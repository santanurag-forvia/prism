{% extends "base.html" %}
{% load static %}
{% load dict_get %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/team_allocations.css' %}">
<style>
.container { max-width:1200px; margin:18px auto; }
.resource-block { background:#fff; border-radius:10px; padding:14px; margin-bottom:18px; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
.resource-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.resource-title { font-weight:800; font-size:16px; color:#0b2447; }
.small-muted { color:#6b7280; font-size:13px; }
.team-table { width:100%; border-collapse:collapse; }
.team-table th, .team-table td { padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:middle; }
.team-table thead th { background:#f8fafc; font-weight:700; color:#374151; }
.week-input { width:100px; padding:6px 8px; border-radius:6px; border:1px solid #e6eaf0; }
.actions { display:flex; gap:8px; align-items:center; }
.btn { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
.btn-save { background:linear-gradient(90deg,#2563eb,#1e40af); color:#fff; border:none; }
.btn-reset { background:#fff; border:1px solid rgba(10,30,80,0.08); color:#0b1320; }

/* Add/Remove row buttons styling */
.btn-add-resource { background:#0b5ed7; color:#fff; padding:8px 12px; border-radius:8px; border:none; font-weight:700; }
.btn-remove-row { background:#ef4444; color:#fff; padding:6px 10px; border-radius:6px; border:none; font-weight:700; }

/* small helper */
.controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
.control-item { display:flex; gap:8px; align-items:center; }

.no-allocs { background: #fff5f5; border: 1px solid #fde3e3; border-radius: 10px; padding: 12px; margin-top: 20px; }
.no-allocs table { width:100%; border-collapse:collapse; }
.no-allocs th, .no-allocs td { padding:8px 10px; border-bottom:1px solid #f8dcdc; text-align:left; vertical-align:middle; }
.no-allocs thead th { font-weight:700; color:#7f1d1d; background: transparent; }
.muted { color:#6b7280; font-size:12px; }

/* ======= New FTE Summary Table ======= */
.table-summary { width:100%; border-collapse:collapse; margin:18px 0; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.table-summary th, .table-summary td { padding:10px 14px; border-bottom:1px solid #e5e7eb; text-align:left; }
.table-summary th { background:#f9fafb; font-weight:700; color:#111827; }
.light-green { background:#dcfce7; }
.light-yellow { background:#fef9c3; }
.light-orange { background:#ffedd5; }
.light-red { background:#fee2e2; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h2 style="margin:0;">Team Allocation — {{ month_start|date:"F Y" }}</h2>

    <form method="get" style="display:flex;gap:8px;align-items:center;">
      <div class="control-item">
        <label class="ctrl-label" style="margin-right:6px;">Select month</label>
        <input type="month" class="input-month" name="month" value="{{ month_start|date:'Y-m' }}" style="padding:8px;border-radius:8px;border:1px solid #e6eaf0;">
      </div>
      <button class="btn-load" type="submit">Load</button>
    </form>
  </div>

  {% if summary %}
  <h3>FTE Allocation Summary</h3>
  <table class="table-summary">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Month %Allocated</th>
        <th>FTE Allocated</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for s in summary.values %}
      <tr class="{{ s.color }}">
        <td>{{ s.name }}</td>
        <td>{{ s.email }}</td>
        <td>{{ s.percent|floatformat:2 }}%</td>
        <td>{{ s.fte|floatformat:2 }}</td>
        <td>
          {% if s.no_allocation %}
            <a href="{% url 'projects:monthly_allocations' %}?month={{ month_start|date:'Y-m' }}" class="btn btn-reset">Create Allocation</a>
          {% else %}
            <a href="{% url 'projects:monthly_allocations' %}?month={{ month_start|date:'Y-m' }}" class="btn btn-reset">View</a>
          {% endif %}
        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if not rows %}
    <div class="panel" style="padding:18px;border-radius:10px;background:#fff;">
      No allocations found for your reportees for this month.
    </div>
  {% else %}
    {% regroup rows by user_ldap as resources %}
    {% for res in resources %}
      <div class="resource-block">
        <div class="resource-header">
          <div>
            <div class="resource-title">
              {{ res.grouper }} — {% if res.list.0.display_name %}{{ res.list.0.display_name }}{% else %}{{ res.list.0.username }}{% endif %}
            </div>
            <div class="small-muted">Reportee</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            <button type="button" class="btn-add-resource" aria-label="Add reportee row">➕ Add Resource</button>
            <div class="small-muted">Tip: enter weekly % values (0-100). Save per-row.</div>
          </div>
        </div>

        <table class="team-table">
          <thead>
            <tr>
              <th>Project</th>
              <th>Domain</th>
              <th>Allocated Hrs</th>
              <th>Week 1 %</th>
              <th>Week 2 %</th>
              <th>Week 3 %</th>
              <th>Week 4 %</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in res.list %}
              {% with w=weekly_map|dict_get:r.allocation_id %}
              <tr data-allocation="{{ r.allocation_id }}">
                <td>{{ r.project_name }}</td>
                <td>{{ r.domain_name }}</td>
                <td>{{ r.total_hours|floatformat:2 }}</td>
                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                           value="{{ w|dict_get:1|dict_get:'percent'|default:0|floatformat:2 }}"
                           data-week="1"></td>
                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                           value="{{ w|dict_get:2|dict_get:'percent'|default:0|floatformat:2 }}"
                           data-week="2"></td>
                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                           value="{{ w|dict_get:3|dict_get:'percent'|default:0|floatformat:2 }}"
                           data-week="3"></td>
                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                           value="{{ w|dict_get:4|dict_get:'percent'|default:0|floatformat:2 }}"
                           data-week="4"></td>
                <td class="actions">
                  <button class="btn btn-save" type="button">Save</button>
                  <button class="btn btn-reset" type="button">Reset</button>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v?v.pop():''; }

const SAVE_TEAM_ALLOCATION_URL = "{% url 'projects:save_team_allocation' %}";

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.btn-save').forEach(hookSave);
  document.querySelectorAll('.btn-reset').forEach(btn => btn.addEventListener('click', () => location.reload()));

  document.querySelectorAll('.btn-add-resource').forEach(btn => {
    btn.addEventListener('click', function(){
      const block = this.closest('.resource-block');
      const tbody = block.querySelector('tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="form-control new-project" placeholder="Project / WBS"></td>
        <td><input type="text" class="form-control new-domain" placeholder="Domain"></td>
        <td><input class="form-control new-allocated-hrs" type="number" step="0.25" min="0" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="1" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="2" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="3" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="4" value="0"></td>
        <td class="actions">
          <button class="btn btn-save new-save" type="button">Save</button>
          <button class="btn btn-remove-row" type="button">Remove</button>
        </td>`;
      tbody.appendChild(tr);

      tr.querySelector('.btn-remove-row').addEventListener('click', () => tr.remove());
      tr.querySelector('.new-save').addEventListener('click', async () => {
        alert('Backend endpoint for creating new resource not yet implemented.');
      });
    });
  });

  function hookSave(btn){
    btn.addEventListener('click', function(){
      const tr = this.closest('tr');
      const allocation_id = tr.dataset.allocation;
      if (!allocation_id) { alert('This row is unsaved.'); return; }
      const weekly = {};
      tr.querySelectorAll('.week-input').forEach(inp => weekly[inp.dataset.week] = Number(inp.value || 0));
      let totalPct = 0; Object.values(weekly).forEach(v => totalPct += Number(v));
      if (totalPct > 100 && !confirm('Total % > 100. Continue saving?')) return;

      fetch(SAVE_TEAM_ALLOCATION_URL, {
        method:'POST', credentials:'same-origin',
        headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
        body:JSON.stringify({allocation_id:Number(allocation_id), weekly:weekly})
      }).then(r=>r.json()).then(data=>{
        if(data.ok){ alert('Saved successfully!'); location.reload(); }
        else alert('Error: '+(data.error||'Server error'));
      }).catch(err=>alert('Save failed: '+err));
    });
  }
});
</script>
{% endblock %}
