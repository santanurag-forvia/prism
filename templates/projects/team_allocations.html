{% extends "base.html" %}
{% load static %}
{% load dict_get %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/team_allocations.css' %}">
<style>
/* Compact layout to match the small screenshot */
.container { max-width:1100px; margin:20px auto 60px; }
.header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.small-muted { color:#6b7280; font-size:13px; }
.table-summary { width:100%; border-collapse:collapse; margin-bottom:18px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
.table-summary th, .table-summary td { padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; }
.table-summary thead th { background:#f8fafc; font-weight:700; }

/* Summary color classes (restored) */
.light-green { background: #ecfdf5; }   /* very light green */
.light-yellow { background: #fffbeb; }  /* very light yellow */
.light-orange { background: #fff7ed; }  /* very light orange */
.light-red { background: #fff1f2; }     /* very light red */

/* Compact resource allocation card */
.alloc-card { background:#fff; border-radius:8px; padding:12px; margin-bottom:12px; box-shadow:0 6px 18px rgba(2,6,23,0.03); display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
.alloc-left { flex:1; }
.alloc-right { width:260px; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }

.alloc-title { font-weight:700; color:#0b2447; margin-bottom:6px; }
.alloc-sub { font-size:13px; color:#475569; margin-bottom:8px; }

/* tiny table inside card */
.alloc-table { width:100%; border-collapse:collapse; font-size:14px; }
.alloc-table th, .alloc-table td { padding:6px 8px; border-bottom:1px solid #f2f6fa; text-align:left; vertical-align:middle; }
.alloc-table thead th { background:#fbfdff; font-weight:700; font-size:13px; color:#374151; }

.form-select { padding:6px 8px; border-radius:6px; border:1px solid #e6eaf0; width:100%; box-sizing:border-box; font-size:13px; }
.form-input { padding:6px 8px; border-radius:6px; border:1px solid #e6eaf0; width:90px; box-sizing:border-box; font-size:13px; }

.btn { padding:7px 10px; border-radius:8px; cursor:pointer; font-weight:700; border:none; font-size:13px; }
.btn-add { background:#0b5ed7; color:#fff; }
.btn-remove { background:#ef4444; color:#fff; padding:6px 8px; border-radius:6px; border:none; }
.btn-save { background:#2563eb; color:#fff; }
.btn-export { background:#fff; border:1px solid #e6eaf0; color:#0b1320; }

/* footer small */
.footer-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:6px; }
.total-assigned { font-weight:700; color:#0b2447; }
.muted { color:#6b7280; font-size:13px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="header-row">
    <div>
      <h2 style="margin:0;">Team Allocations â€” {{ month_start|date:"F Y" }}</h2>
      <div class="small-muted">Distribute your assigned monthly hours to your direct reportees (compact view).</div>
    </div>

    <form method="get" style="display:flex;gap:8px;align-items:center;">
      <label style="font-size:13px;color:#374151;">Month</label>
      <input type="month" name="month" value="{{ month_start|date:'Y-m' }}" style="padding:8px;border-radius:8px;border:1px solid #e6eaf0;">
      <button class="btn btn-export" type="submit">Load</button>
    </form>
  </div>

  {# Top summary table with color coding restored #}
  {% if summary %}
    <table class="table-summary">
      <thead>
        <tr>
          <th>Lead Name / Resource</th>
          <th style="width:160px">Total Hours</th>
          <th style="width:120px">FTE</th>
          <th style="width:160px">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for key, s in summary.items %}
        <tr class="{{ s.color }}" data-email="{{ s.email|default:s.name }}" data-total-hours="{{ s.total_hours|default:0 }}">
          <td>
            <div style="font-weight:700">{{ s.name }}</div>
            <div style="font-size:12px;color:#6b7280;">{{ s.email }}</div>
          </td>
          <td class="summary-hours">{{ s.total_hours|floatformat:2 }}</td>
          <td class="summary-fte">{{ s.fte|floatformat:2 }}</td>
          <td>
            {% if s.no_allocation %}
              <a class="btn btn-export" href="{% url 'projects:monthly_allocations' %}?month={{ month_start|date:'Y-m' }}">Create Allocation</a>
            {% else %}
              <a class="btn btn-export" href="{% url 'projects:monthly_allocations' %}?month={{ month_start|date:'Y-m' }}">View</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# ========== Compact resource allocation cards (per subproject) ========== #}
  <div id="compact-distribution">
    {% if lead_allocations %}
      {% for alloc in lead_allocations %}
        <div class="alloc-card" data-subproject="{{ alloc.subproject_id }}" data-total-hours="{{ alloc.total_hours }}">
          <div class="alloc-left">
            <div class="alloc-title">{{ alloc.project_name }} â€” {{ alloc.subproject_name }}</div>
            <div class="alloc-sub muted">Allocated to you: <strong>{{ alloc.total_hours|floatformat:2 }}</strong> hrs</div>

            <table class="alloc-table">
              <thead>
                <tr><th style="width:65%;">Reportee</th><th style="width:20%;">Hours</th><th style="width:15%;"> </th></tr>
              </thead>
              <tbody class="alloc-rows">
                {% for d in alloc.distribution %}
                <tr data-ldap="{{ d.reportee_ldap|default:'' }}">
                  <td>
                    <select class="form-select dist-reportee">
                      <option value="{{ d.reportee_ldap }}">{{ d.reportee_name|default:d.reportee_ldap }}</option>
                    </select>
                  </td>
                  <td><input type="number" class="form-input dist-hours" min="0" step="0.25" value="{{ d.hours|default:0 }}"></td>
                  <td><button class="btn-remove" type="button">Remove</button></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="alloc-right">
            <div style="text-align:right;">
              <div class="muted">Assigned</div>
              <div style="font-size:18px;"><span class="total-assigned">0.00</span> / <strong>{{ alloc.total_hours|floatformat:2 }}</strong></div>
            </div>

            <div class="footer-actions">
              <button class="btn btn-add" type="button">Add Resource</button>
              <button class="btn btn-save btn-save-card" type="button">Save</button>
            </div>
          </div>
        </div>
      {% endfor %}

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="btn-save-all" class="btn btn-save">ðŸ’¾ Save All</button>
        <button id="btn-export-excel" class="btn btn-export" type="button">Export Excel</button>
      </div>
    {% else %}
      <div class="no-allocs" style="padding:12px;border-radius:8px;background:#fff;box-shadow:0 6px 18px rgba(2,6,23,0.03);">
        No personal allocations found for you this month. Create allocations first in Monthly Allocations.
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
/* Compact distribution script
   Expects:
     - reportees_json (array of {ldap, mail, cn})
     - SAVE endpoint: {% url 'projects:save_team_distribution' %}
*/
const SAVE_URL = "{% url 'projects:save_team_distribution' %}";
const REPORTEES = {{ reportees_json|safe }};
function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v? v.pop():''; }

/* build options for a given allowed array */
function buildOptions(arr) {
  return arr.map(r => `<option value="${r.ldap}">${(r.cn || r.mail || r.ldap)}</option>`).join('');
}

/* return set of used ldap (lower) in this card */
function usedInCard(card) {
  const s = new Set();
  card.querySelectorAll('.dist-reportee').forEach(sel => {
    const v = (sel.value || '').trim().toLowerCase();
    if (v) s.add(v);
  });
  card.querySelectorAll('tbody tr[data-ldap]').forEach(tr => {
    const v = (tr.dataset.ldap || '').trim().toLowerCase();
    if (v) s.add(v);
  });
  return s;
}

/* refresh dropdowns for a card (exclude used except current select value) */
function refreshDropdowns(card) {
  const used = usedInCard(card);
  card.querySelectorAll('.dist-reportee').forEach(sel => {
    const current = (sel.value || '').trim().toLowerCase();
    const allowed = REPORTEES.filter(r => {
      const l = (r.ldap || r.mail || '').toLowerCase();
      return (!used.has(l) || l === current);
    });
    const prev = sel.value;
    sel.innerHTML = buildOptions(allowed);
    if (prev) {
      sel.value = prev;
      if (sel.value !== prev && sel.options.length) sel.selectedIndex = 0;
    }
  });
}

/* update totals display on a card */
function updateCardTotals(card) {
  const total = [...card.querySelectorAll('.dist-hours')].reduce((s, el) => s + (Number(el.value || 0)), 0);
  const span = card.querySelector('.total-assigned');
  if (span) span.textContent = total.toFixed(2);
}

/* add a new empty row to a card */
function addRowToCard(card) {
  const used = usedInCard(card);
  const available = REPORTEES.filter(r => !used.has((r.ldap||r.mail||'').toLowerCase()));
  if (available.length === 0) {
    alert('All reportees already assigned in this subproject.');
    return;
  }
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><select class="form-select dist-reportee">${buildOptions(available)}</select></td>
    <td><input class="form-input dist-hours" type="number" min="0" step="0.25" value="0"></td>
    <td><button class="btn-remove" type="button">Remove</button></td>
  `;
  const tbody = card.querySelector('.alloc-rows');
  tbody.appendChild(tr);

  // wire events
  tr.querySelector('.dist-reportee').addEventListener('change', () => { refreshDropdowns(card); updateCardTotals(card); });
  tr.querySelector('.dist-hours').addEventListener('input', () => updateCardTotals(card));
  tr.querySelector('.btn-remove').addEventListener('click', () => { tr.remove(); refreshDropdowns(card); updateCardTotals(card); });
  refreshDropdowns(card);
  updateCardTotals(card);
}

/* initialize all cards: wire add buttons, remove, inputs, selects */
function initCards() {
  document.querySelectorAll('.alloc-card').forEach(card => {
    // wire Add button
    const addBtn = card.querySelector('.btn-add');
    if (addBtn) addBtn.addEventListener('click', () => addRowToCard(card));

    // wire Save single-card button
    const saveBtn = card.querySelector('.btn-save-card');
    if (saveBtn) saveBtn.addEventListener('click', async () => {
      const subprojectId = card.dataset.subproject;
      const rows = [...card.querySelectorAll('tbody tr')].map(tr => {
        const sel = tr.querySelector('.dist-reportee');
        const ldap = sel ? (sel.value || '').trim() : (tr.dataset.ldap||'').trim();
        const hrs = Number(tr.querySelector('.dist-hours') ? tr.querySelector('.dist-hours').value || 0 : tr.dataset.hours || 0);
        return { reportee: ldap, hours: hrs };
      });
      const payload = { month: "{{ month_start|date:'Y-m' }}", allocations: [ { subproject_id: subprojectId, items: rows } ] };
      await postSave(payload);
    });

    // wire existing remove and inputs/selects
    card.querySelectorAll('.btn-remove').forEach(b => b.addEventListener('click', () => { b.closest('tr').remove(); refreshDropdowns(card); updateCardTotals(card); }));
    card.querySelectorAll('.dist-hours').forEach(inp => inp.addEventListener('input', () => updateCardTotals(card)));
    card.querySelectorAll('.dist-reportee').forEach(sel => sel.addEventListener('change', () => { refreshDropdowns(card); updateCardTotals(card); }));

    // initial refresh & totals
    refreshDropdowns(card);
    updateCardTotals(card);
  });
}

/* Gather whole-page payload and POST to server */
async function postSave(payload) {
  try {
    const resp = await fetch(SAVE_URL, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if (data.ok) {
      alert('Saved successfully.');
      location.reload();
    } else {
      alert('Save error: ' + (data.error || 'unknown'));
    }
  } catch (err) {
    alert('Network or server error: ' + err);
  }
}

/* Save All button (gathers all cards) */
document.addEventListener('DOMContentLoaded', () => {
  initCards();

  const saveAll = document.getElementById('btn-save-all');
  if (saveAll) saveAll.addEventListener('click', () => {
    const allocations = [];
    document.querySelectorAll('.alloc-card').forEach(card => {
      const subp = card.dataset.subproject;
      const items = [...card.querySelectorAll('tbody tr')].map(tr => {
        const sel = tr.querySelector('.dist-reportee');
        const ldap = sel ? (sel.value || '').trim() : (tr.dataset.ldap||'').trim();
        const hours = Number(tr.querySelector('.dist-hours') ? tr.querySelector('.dist-hours').value || 0 : tr.dataset.hours || 0);
        return { reportee: ldap, hours: hours };
      });
      allocations.push({ subproject_id: subp, items: items });
    });
    const payload = { month: "{{ month_start|date:'Y-m' }}", allocations: allocations };
    postSave(payload);
  });

  // Export Excel placeholder - you can wire to your export endpoint
  const exportBtn = document.getElementById('btn-export-excel');
  if (exportBtn) exportBtn.addEventListener('click', () => {
    alert('Export Excel not implemented in this snippet. Wire to your export endpoint.');
  });
});
</script>
{% endblock %}
