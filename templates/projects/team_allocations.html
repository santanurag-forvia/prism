{% extends "base.html" %}
{% load static %}
{% load dict_get %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/team_allocations.css' %}">
<style>
.container { max-width:1200px; margin:18px auto; }
.resource-block { background:#fff; border-radius:10px; padding:14px; margin-bottom:18px; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
.resource-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.resource-title { font-weight:800; font-size:16px; color:#0b2447; }
.small-muted { color:#6b7280; font-size:13px; }
.team-table { width:100%; border-collapse:collapse; }
.team-table th, .team-table td { padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:middle; }
.team-table thead th { background:#f8fafc; font-weight:700; color:#374151; }
.week-input { width:100px; padding:6px 8px; border-radius:6px; border:1px solid #e6eaf0; }
.actions { display:flex; gap:8px; align-items:center; }
.btn { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
.btn-save { background:linear-gradient(90deg,#2563eb,#1e40af); color:#fff; border:none; }
.btn-reset { background:#fff; border:1px solid rgba(10,30,80,0.08); color:#0b1320; }

/* Add/Remove row buttons styling */
.btn-add-resource { background:#0b5ed7; color:#fff; padding:8px 12px; border-radius:8px; border:none; font-weight:700; }
.btn-remove-row { background:#ef4444; color:#fff; padding:6px 10px; border-radius:6px; border:none; font-weight:700; }

/* small helper */
.controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
.control-item { display:flex; gap:8px; align-items:center; }

.no-allocs { background: #fff5f5; border: 1px solid #fde3e3; border-radius: 10px; padding: 12px; margin-top: 20px; }
.no-allocs table { width:100%; border-collapse:collapse; }
.no-allocs th, .no-allocs td { padding:8px 10px; border-bottom:1px solid #f8dcdc; text-align:left; vertical-align:middle; }
.no-allocs thead th { font-weight:700; color:#7f1d1d; background: transparent; }
.muted { color:#6b7280; font-size:12px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h2 style="margin:0;">Team Allocation — {{ month_start|date:"F Y" }}</h2>

    <form method="get" style="display:flex;gap:8px;align-items:center;">
      {# HTML5 month input produces YYYY-MM, aligns with server parsing #}
      <div class="control-item">
        <label class="ctrl-label" style="margin-right:6px;">Select month</label>
        <input type="month" class="input-month" name="month" value="{{ month_start|date:'Y-m' }}" style="padding:8px;border-radius:8px;border:1px solid #e6eaf0;">
      </div>
      <button class="btn-load" type="submit">Load</button>
    </form>
  </div>

  {% if not rows %}
    <div class="panel" style="padding:18px;border-radius:10px;background:#fff;">
      No allocations found for your reportees for this month.
    </div>
  {% else %}
    {# Group rows by user_ldap (resource) #}
    {% regroup rows by user_ldap as resources %}
    {% for res in resources %}
      <div class="resource-block">
        <div class="resource-header">
          <div>
            <div class="resource-title">
              {{ res.grouper }} — {% if res.list.0.display_name %}{{ res.list.0.display_name }}{% else %}{{ res.list.0.username }}{% endif %}
            </div>
            <div class="small-muted">Reportee</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            {# NEW: Add Resource button visible to Team Lead so they can add reportees under their allocation #}
            <button type="button" class="btn-add-resource" aria-label="Add reportee row">➕ Add Resource</button>
            <div class="small-muted">Tip: enter weekly % values (0-100). Save per-row.</div>
          </div>
        </div>

        <table class="team-table">
          <thead>
            <tr>
              <th style="width:260px">Project</th>
              <th style="width:180px">Domain</th>
              <th style="width:120px">Allocated Hrs</th>
              <th style="width:100px">Week 1 %</th>
              <th style="width:100px">Week 2 %</th>
              <th style="width:100px">Week 3 %</th>
              <th style="width:100px">Week 4 %</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in res.list %}
              {% with w=weekly_map|dict_get:r.allocation_id %}
              <tr data-allocation="{{ r.allocation_id }}">
                <td>{{ r.project_name }}</td>
                <td>{{ r.domain_name }}</td>
                <td>{{ r.total_hours|floatformat:2 }}</td>

                {# weekly_map stores 'percent' per week in the view; show percent here #}
                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:1|dict_get:'percent'|default:0|floatformat:2 }}"
                             data-week="1"></td>

                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:2|dict_get:'percent'|default:0|floatformat:2 }}"
                             data-week="2"></td>

                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:3|dict_get:'percent'|default:0|floatformat:2 }}"
                             data-week="3"></td>

                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:4|dict_get:'percent'|default:0|floatformat:2 }}"
                             data-week="4"></td>

                <td class="actions">
                  <button class="btn btn-save" type="button">Save</button>
                  <button class="btn btn-reset" type="button">Reset</button>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% endif %}

  {# Reportees with no allocation — shown at bottom in a light-red table #}
  {% if reportees_no_alloc %}
    <div class="no-allocs">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:800;color:#7f1d1d;">Reportees without allocations — {{ month_start|date:"F Y" }}</div>
        <div class="small-muted">You may want to create allocations for them.</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Resource (LDAP)</th>
            <th>Name / Email</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reportees_no_alloc %}
          <tr>
            <td>{{ r.ldap }}</td>
            <td>{% if r.display %}{{ r.display }}{% else %}—{% endif %}{% if r.email %} &lt;{{ r.email }}&gt;{% endif %}</td>
            <td>
              <a class="btn btn-reset" href="{% url 'projects:monthly_allocations' %}?project_id=&month={{ month_start|date:'Y-m' }}">Create allocation</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v?v.pop():''; }

// URLs used by this template
const SAVE_TEAM_ALLOCATION_URL = "{% url 'projects:save_team_allocation' %}";
//const CREATE_MONTHLY_ENTRY_URL = "#"; // optional: backend endpoint to create new monthly allocation (if implemented)

document.addEventListener('DOMContentLoaded', () => {
  // hook existing rows' actions
  document.querySelectorAll('.btn-save').forEach(hookSave);
  document.querySelectorAll('.btn-reset').forEach(btn => btn.addEventListener('click', () => location.reload()));

  // hook Add Resource buttons (one per resource-block)
  document.querySelectorAll('.btn-add-resource').forEach(btn => {
    btn.addEventListener('click', function(){
      const block = this.closest('.resource-block');
      const tbody = block.querySelector('tbody');
      // append a new editable row (no allocation id yet)
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="form-control new-project" placeholder="Project / WBS"></td>
        <td><input type="text" class="form-control new-domain" placeholder="Domain"></td>
        <td><input class="form-control new-allocated-hrs" type="number" step="0.25" min="0" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="1" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="2" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="3" value="0"></td>
        <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="4" value="0"></td>
        <td class="actions">
          <button class="btn btn-save new-save" type="button">Save</button>
          <button class="btn btn-remove-row" type="button">Remove</button>
        </td>
      `;
      tbody.appendChild(tr);

      // hook remove for this row
      tr.querySelector('.btn-remove-row').addEventListener('click', () => tr.remove());

      // hook save for this new row
      tr.querySelector('.new-save').addEventListener('click', async () => {
        // gather data
        const projectName = tr.querySelector('.new-project').value || '';
        const domain = tr.querySelector('.new-domain').value || '';
        const allocatedHrs = Number(tr.querySelector('.new-allocated-hrs').value || 0);
        const weekly = {};
        tr.querySelectorAll('.week-input').forEach(w => weekly[w.dataset.week] = Number(w.value || 0));

        // optional client-side validation: weekly % sum
        let totalPct = 0;
        Object.values(weekly).forEach(v => totalPct += Number(v));
        if (totalPct > 100 && !confirm('Total % > 100. Continue saving?')) return;

        // Create monthly allocation entry on server (if you have endpoint). If not present, this JS will attempt and fallback to alert.
        try {
          const csrftoken = getCookie('csrftoken');
          const resp = await fetch(CREATE_MONTHLY_ENTRY_URL, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
            body: JSON.stringify({
              // minimal info; adjust on backend as required
              project_name: projectName,
              domain_name: domain,
              allocated_hours: allocatedHrs,
              weekly_percent: weekly,
              // pass month or reportee id if needed; this template expects backend to infer from current page context or accept fields
              month_start: "{{ month_start|date:'Y-m-d' }}",
              user_ldap: "{{ request.user.username|default:'' }}"
            })
          });
          const data = await resp.json();
          if (data && data.ok && data.allocation_id) {
            // replace the editable row with server-saved row (server should return saved fields)
            tr.dataset.allocation = data.allocation_id;
            // replace columns with server values (or keep submitted)
            tr.innerHTML = `
              <td>${projectName}</td>
              <td>${domain}</td>
              <td>${allocatedHrs.toFixed(2)}</td>
              <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="1" value="${weekly[1]||0}"></td>
              <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="2" value="${weekly[2]||0}"></td>
              <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="3" value="${weekly[3]||0}"></td>
              <td><input class="week-input" type="number" min="0" max="100" step="0.01" data-week="4" value="${weekly[4]||0}"></td>
              <td class="actions">
                <button class="btn btn-save" type="button">Save</button>
                <button class="btn btn-reset" type="button">Reset</button>
              </td>
            `;
            // hook newly created row save/reset
            const newSave = tr.querySelector('.btn-save');
            const newReset = tr.querySelector('.btn-reset');
            hookSave(newSave);
            if (newReset) newReset.addEventListener('click', () => location.reload());
            alert('Created allocation row successfully.');
          } else {
            alert('Create failed: ' + (data && data.error ? data.error : 'server did not return id'));
            console.warn('create_monthly_allocation_entry response', data);
          }
        } catch (err) {
          console.error('create_monthly_allocation_entry', err);
          alert('Create failed (see console). If you do not have CREATE endpoint, implement projects:create_monthly_allocation_entry or save rows from Monthly Allocations and reload this page.');
        }
      });
    });
  });

  // existing Save handler for rows that already have allocation_id
  function hookSave(btn){
    btn.addEventListener('click', function(e){
      const tr = this.closest('tr');
      const allocation_id = tr.dataset.allocation;
      if (!allocation_id) {
        alert('This row was not created on server yet; please use Add Resource -> Save to create it.');
        return;
      }
      const weekly = {};
      tr.querySelectorAll('.week-input').forEach(inp=>{
        weekly[inp.dataset.week] = Number(inp.value || 0);
      });

      // validate total percentage per allocation row
      let totalPct = 0;
      Object.values(weekly).forEach(v=> totalPct += Number(v));
      if(totalPct > 100 && !confirm("Total % > 100. Continue anyway?")) return;

      fetch(SAVE_TEAM_ALLOCATION_URL, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({allocation_id: Number(allocation_id), weekly: weekly})
      }).then(r=>r.json()).then(data=>{
        if(data.ok) {
          alert("Saved successfully!");
          // reload to show server-calculated amounts / validations
          location.reload();
        } else alert("Error: " + (data.error || JSON.stringify(data)));
      }).catch(err=>{
        alert("Save failed: " + err);
      });
    });
  }

  // Hook all currently existing save buttons (already done earlier)
  // (hookSave was called during DOMContentLoaded for each existing .btn-save)

</script>
{% endblock %}
