{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<style>
/* compact styling tuned for weekly punching */
.alloc-wrap { max-width:1200px; margin:24px auto; padding:18px; }
.topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; flex-wrap:wrap; }
.small-muted { color:#6b7280; font-size:0.9rem; }
.btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.btn-load { background:#2563eb; color:#fff; }
.btn-vac { background:#f59e0b; color:#fff; }
.btn-tl { background:#6b7280; color:#fff; }
.group-card { background:#fff; border-radius:10px; padding:12px 16px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,0.04); border:1px solid #f1f5f9; }
.alloc-table { width:100%; border-collapse:collapse; }
.alloc-table th, .alloc-table td { padding:8px 10px; border-bottom:1px solid #f3f4f6; text-align:center; font-size:0.93rem; }
.alloc-table th { background:#f9fafb; color:#334155; }
.input-hours { width:90px; padding:5px 6px; border:1px solid #e5e7eb; border-radius:6px; text-align:right; }
.status-badge { padding:4px 8px; border-radius:6px; font-size:0.8rem; font-weight:600; }
.status-pending { background:#fff7ed; color:#92400e; border:1px solid #ffedd5; }
.status-accepted { background:#ecfdf5; color:#065f46; border:1px solid #d1fae5; }
.status-rejected { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
.row-actions { display:flex; gap:6px; justify-content:center; }
</style>
{% endblock %}

{% block content %}
<div class="alloc-wrap">
  <div class="topbar">
    <div>
      <h2 style="margin:0;">My Weekly Allocations — <span class="small-muted">{{ month_label }}</span></h2>
      <div class="small-muted">Billing: {{ billing_start }} — {{ billing_end }}</div>
      <form method="get" style="display:inline-flex;align-items:center;gap:8px;margin-top:6px;">
        <label class="small-muted">Month:</label>
        <input type="month" name="month" value="{{ request.GET.month|default:billing_start|slice:':7' }}">
        <button class="btn btn-load" type="submit">Load</button>
      </form>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button id="vac-btn" class="btn btn-vac">Vacation / Leave</button>
      <a class="btn btn-tl" href="{{ tl_reconsider_url }}">TL Reconsiderations</a>
    </div>
  </div>

  {% if groups %}
    {% for spid, group in groups.items %}
      <div class="group-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:700;">{{ group.subproject_name }} {% if group.project_name %}<span class="small-muted">— {{ group.project_name }}</span>{% endif %}</div>
          <div class="small-muted">Total: {{ group.rows|length }}</div>
        </div>

        <table class="alloc-table" data-subproject="{{ group.subproject_id }}">
          <thead>
            <tr>
              <th style="text-align:left;min-width:200px;">Team Dist. ID</th>
              {% for wk in weeks %}
                <th>Week {{ wk.num }}<br><small class="small-muted">{{ wk.start }} — {{ wk.end }}</small></th>
              {% endfor %}
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in group.rows %}
              <tr data-team-id="{{ row.team_distribution_id }}">
                <td style="text-align:left;">
                  <div style="font-weight:700;">#{{ row.team_distribution_id }}</div>
                  <div class="small-muted">{{ row.total_hours }}h</div>
                </td>

                {# Use the ordered weekly_list (no dynamic key lookup) #}
                {% for cell in row.weekly_list %}
                  <td>
                    {% if cell.status == 'PENDING' %}
                      <input class="input-hours" type="number" step="0.25" min="0"
                             value="{{ cell.hours }}"
                             data-week="{{ forloop.counter }}" data-team-id="{{ row.team_distribution_id }}">
                    {% else %}
                      {{ cell.hours }}h
                    {% endif %}
                  </td>
                {% endfor %}

                <td>
                  {% if row.weekly_list.0.status == 'ACCEPTED' %}
                    <span class="status-badge status-accepted">ACCEPTED</span>
                  {% elif row.weekly_list.0.status == 'REJECTED' %}
                    <span class="status-badge status-rejected">REJECTED</span>
                  {% else %}
                    <span class="status-badge status-pending">PENDING</span>
                  {% endif %}
                </td>

                <td>
                  <div class="row-actions">
                    <button class="btn btn-save save-row" data-team-id="{{ row.team_distribution_id }}">Save</button>
                    <button class="btn btn-accept accept-row" data-team-id="{{ row.team_distribution_id }}">Accept</button>
                    <button class="btn btn-reject reject-row" data-team-id="{{ row.team_distribution_id }}">Reject</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <div class="group-card">
      <div class="small-muted">No allocations found for {{ month_label }}.</div>
    </div>
  {% endif %}
</div>

{% csrf_token %}
<script>
(function(){
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
  const saveWeeklyUrl = "{{ save_weekly_url }}";
  const updateStatusUrl = "{{ update_status_url }}";
  const saveVacationUrl = "{{ save_vacation_url }}";

  async function postJSON(url, body){
    return fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
      body: JSON.stringify(body)
    }).then(r => r.json()).catch(()=>({ok:false,error:'network error'}));
  }

  // Save all inputs for a team row
  document.querySelectorAll('.save-row').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tid = btn.dataset.teamId;
      const inputs = document.querySelectorAll(`input[data-team-id="${tid}"]`);
      for(const inp of inputs){
        const wk = inp.dataset.week;
        const hours = inp.value;
        const body = { team_distribution_id: parseInt(tid,10), week_number: parseInt(wk,10), allocated_hours: hours };
        const res = await postJSON(saveWeeklyUrl, body);
        if(!res.ok){ alert('Save failed: ' + (res.error || 'server')); return; }
      }
      alert('Saved');
    });
  });

  // Accept
  document.querySelectorAll('.accept-row').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tid = btn.dataset.teamId;
      if(!confirm('Accept all weeks for this allocation?')) return;
      const body = { team_distribution_id: parseInt(tid,10), action: 'accept', billing_start: "{{ billing_start }}" };
      const res = await postJSON(updateStatusUrl, body);
      if(res.ok){ alert('Accepted'); location.reload(); } else alert('Failed: ' + (res.error||'server error'));
    });
  });

  // Reject
  document.querySelectorAll('.reject-row').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tid = btn.dataset.teamId;
      const comment = prompt('Provide reason for rejection (this sends to TL for reconsideration):');
      if(!comment) return;
      const body = { team_distribution_id: parseInt(tid,10), action: 'reject', comment: comment, billing_start: "{{ billing_start }}" };
      const res = await postJSON(updateStatusUrl, body);
      if(res.ok){ alert('Rejected — sent to TL'); location.reload(); } else alert('Failed: ' + (res.error||'server error'));
    });
  });

  // Vacation button
  document.getElementById('vac-btn').addEventListener('click', async ()=>{
    const hours = prompt('Total vacation/leave hours for billing period:');
    if(!hours) return;
    const reason = prompt('Optional note:') || '';
    const body = { billing_start: "{{ billing_start }}", billing_end: "{{ billing_end }}", hours: hours, reason: reason };
    const res = await postJSON(saveVacationUrl, body);
    if(res.ok){ alert('Vacation saved'); } else alert('Failed: ' + (res.error||'server error'));
  });

})();
</script>
{% endblock %}
