{% extends "base.html" %}
        {% load static %}

        {% block title %}My Weekly Allocations{% endblock %}

        {% block extra_css %}
        <style>
            /* === GLOBAL STYLES === */
            .page-container {
                padding: 30px;
                max-width: 1600px;
                margin: 0 auto;
            }

            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
            }

            .page-title {
                font-size: 28px;
                font-weight: 700;
                color: #1a202c;
                margin: 0;
            }

            /* === MONTH/YEAR PICKER === */
            .month-year-picker {
                display: flex;
                align-items: center;
                gap: 15px;
                background: white;
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }

            .month-year-picker label {
                font-weight: 600;
                color: #4a5568;
                margin: 0;
                font-size: 14px;
            }

            .month-year-picker select {
                padding: 8px 15px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 14px;
                min-width: 120px;
                transition: all 0.3s ease;
            }

            .month-year-picker select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            /* === PAGE HEADER STYLES === */


            .filter-controls {
                display: flex;
                align-items: center;
                gap: 20px;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .filter-group label {
                color: white;
                font-weight: 600;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin: 0;
            }

            .filter-select {
                min-width: 140px;
                padding: 10px 16px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.95);
                font-size: 14px;
                font-weight: 600;
                color: #2d3748;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .filter-select:hover {
                border-color: rgba(255, 255, 255, 0.6);
                background: white;
            }

            .filter-select:focus {
                outline: none;
                border-color: white;
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            }

            .btn-search {
                padding: 10px 28px;
                background: white;
                color: #667eea;
                border: 2px solid white;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .btn-search:hover {
                background: #f7fafc;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .btn-search:active {
                transform: translateY(0);
            }

            /* === RESPONSIVE === */
            @media (max-width: 1200px) {
                .page-header {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 20px;
                }

                .filter-controls {
                    justify-content: center;
                    flex-wrap: wrap;
                }
            }

            @media (max-width: 768px) {
                .filter-controls {
                    flex-direction: column;
                    width: 100%;
                }

                .filter-group {
                    width: 100%;
                    justify-content: space-between;
                }

                .filter-select {
                    flex: 1;
                    min-width: 0;
                }

                .btn-search {
                    width: 100%;
                    justify-content: center;
                }
            }

            /* === ACTION BAR === */
            .action-bar {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px 25px;
                border-radius: 12px;
                margin-bottom: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            }

            .action-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 20px;
            }

            .week-selector-group {
                flex: 0 0 auto;
                min-width: 280px;
            }

            .week-selector-group label {
                color: white;
                font-weight: 600;
                font-size: 13px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
                display: block;
            }

            .week-selector-group select {
                width: 100%;
                padding: 10px 15px;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 8px;
                background: rgba(255,255,255,0.95);
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .week-selector-group select:focus {
                outline: none;
                border-color: #fff;
                box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
            }

            .action-buttons {
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .action-bar .btn {
                padding: 12px 28px;
                font-weight: 600;
                font-size: 14px;
                border-radius: 8px;
                border: none;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
            }

            .btn-save-draft {
                background: #ffffff;
                color: #667eea;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .btn-save-draft:hover {
                background: #f7fafc;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .btn-submit-effort {
                background: #48bb78;
                color: white;
                box-shadow: 0 2px 8px rgba(72,187,120,0.3);
            }

            .btn-submit-effort:hover {
                background: #38a169;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(72,187,120,0.5);
            }

            .btn-add-allocation {
                background: #ed8936;
                color: white;
                box-shadow: 0 2px 8px rgba(237,137,54,0.3);
            }

            .btn-add-allocation:hover {
                background: #dd6b20;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(237,137,54,0.5);
            }

            /* === ALLOCATION CARDS === */
            .allocations-container {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .allocation-card {
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .allocation-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            }

            .card-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 18px 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .card-title {
                color: white;
                font-size: 18px;
                font-weight: 700;
                margin: 0;
            }

            .card-subtitle {
                color: rgba(255,255,255,0.85);
                font-size: 14px;
                margin-top: 4px;
            }

            .self-allocation-badge {
                background: rgba(255,255,255,0.2);
                color: white;
                padding: 6px 14px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .card-body {
                padding: 0;
            }

            /* === ALLOCATION TABLE === */
            .allocation-table {
                width: 100%;
                border-collapse: collapse;
            }

            .allocation-table thead {
                background: #f7fafc;
            }

            .allocation-table th {
                padding: 15px 20px;
                text-align: left;
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: #4a5568;
                border-bottom: 2px solid #e2e8f0;
            }

            .allocation-table td {
                padding: 16px 20px;
                border-bottom: 1px solid #f1f1f1;
                vertical-align: middle;
            }

            .allocation-table tbody tr:last-child td {
                border-bottom: none;
            }

            .allocation-table tbody tr:hover {
                background-color: #f7fafc;
            }

            .allocation-table input[type="number"] {
                width: 100px;
                padding: 8px 12px;
                border: 2px solid #e2e8f0;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .allocation-table input[type="number"]:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .allocation-table input:disabled {
                background-color: #f7fafc;
                color: #a0aec0;
                cursor: not-allowed;
            }

            .status-badge {
                display: inline-block;
                padding: 6px 14px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-draft {
                background: #fef5e7;
                color: #d68910;
            }

            .status-submitted {
                background: #d5f4e6;
                color: #0e7c4e;
            }

            .status-approved {
                background: #d6eaf8;
                color: #1a5490;
            }

            .status-rejected {
                background: #fadbd8;
                color: #a93226;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #a0aec0;
            }

            .empty-state i {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                font-size: 20px;
                margin-bottom: 10px;
                color: #718096;
            }

            /* === MODAL OVERLAY === */
            .modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.65);
                z-index: 9999;
                animation: fadeIn 0.3s ease;
                backdrop-filter: blur(4px);
            }

            .modal-overlay.active {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .modal-dialog {
                background: white;
                border-radius: 16px;
                width: 100%;
                max-width: 900px;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                animation: slideUp 0.4s ease;
            }

            .modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 25px 30px;
                border-radius: 16px 16px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-title {
                color: white;
                font-size: 22px;
                font-weight: 700;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .modal-close {
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                font-size: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-close:hover {
                background: rgba(255,255,255,0.3);
                transform: rotate(90deg);
            }

            .modal-body {
                padding: 30px;
                overflow-y: auto;
                flex: 1;
            }

            .form-section {
                margin-bottom: 25px;
            }

            .form-section-title {
                font-size: 16px;
                font-weight: 700;
                color: #2d3748;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #e2e8f0;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                font-weight: 600;
                font-size: 14px;
                color: #4a5568;
                margin-bottom: 8px;
            }

            .form-group select,
            .form-group input {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .form-group select:focus,
            .form-group input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .form-group select:disabled {
                background-color: #f7fafc;
                color: #a0aec0;
                cursor: not-allowed;
            }

            .week-allocation-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }

            .week-allocation-table thead {
                background: #f7fafc;
            }

            .week-allocation-table th {
                padding: 12px 15px;
                text-align: left;
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                color: #4a5568;
                border-bottom: 2px solid #e2e8f0;
            }

            .week-allocation-table td {
                padding: 12px 15px;
                border-bottom: 1px solid #f1f1f1;
            }

            .week-allocation-table tbody tr:hover {
                background-color: #f7fafc;
            }

            .week-allocation-table input[type="number"] {
                width: 100%;
                padding: 8px 12px;
                border: 2px solid #e2e8f0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.3s ease;
            }

            .week-allocation-table input[type="number"]:focus {
                outline: none;
                border-color: #667eea;
            }

            .modal-footer {
                padding: 20px 30px;
                border-top: 2px solid #f1f1f1;
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                background: #fafafa;
                border-radius: 0 0 16px 16px;
            }

            .modal-footer .btn {
                padding: 12px 30px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .btn-secondary {
                background: #e2e8f0;
                color: #4a5568;
            }

            .btn-secondary:hover {
                background: #cbd5e0;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
            }
            .btn-record-leave {
                background: #e53e3e;
                color: white;
                box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
            }

            .btn-record-leave:hover {
                background: #c53030;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(229, 62, 62, 0.5);
            }

            /* === ANIMATIONS === */
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes slideUp {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            /* === RESPONSIVE === */
            @media (max-width: 1200px) {
                .action-row {
                    flex-direction: column;
                    align-items: stretch;
                }

                .action-buttons {
                    justify-content: center;
                }
            }

            @media (max-width: 768px) {
                .form-row {
                    grid-template-columns: 1fr;
                }

                .modal-dialog {
                    max-width: 100%;
                    max-height: 95vh;
                }
            }
            .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.page-title {
    font-size: 28px;
    font-weight: 700;
    color: white;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
        </style>
        {% endblock %}

        {% block content %}
        <div class="page-container">
            <!-- Page Header with Month/Year Picker -->
            <!-- Page Header with Month/Year Picker -->
            <div class="page-header">
                <h1 class="page-title">My Weekly Allocations</h1>

                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="yearSelect">Year:</label>
                        <select id="yearSelect" class="filter-select">
                            {% for year in years %}
                                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                                    {{ year }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="monthSelect">Month:</label>
                        <select id="monthSelect" class="filter-select">
                            {% for month in months %}
                                <option value="{{ month.num }}" {% if month.num == selected_month %}selected{% endif %}>
                                    {{ month.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <button id="searchBtn" class="btn-search" onclick="changeMonthYear()">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                </div>
            </div>

            <!-- Action Bar with Week Selector and Buttons -->
            <div class="action-bar">
                <div class="action-row">
                    <div class="week-selector-group">
                        <label for="weekSelector">Select Week</label>
                        <select id="weekSelector">
                            <option value="all" {% if selected_week == 'all' %}selected{% endif %}>
                                All Weeks
                            </option>
                            {% for week in all_weeks_list %}
                            <option value="{{ week.num }}"
                                    {% if selected_week|stringformat:"s" == week.num|stringformat:"s" %}selected{% endif %}
                                    {% if week.num == current_week %}data-current="true"{% endif %}>
                                Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}
                                {% if week.num == current_week %} ★{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-save-draft" id="btnSaveDraft">
                            <i class="fas fa-save"></i>
                            Save Draft
                        </button>
                        <button class="btn btn-submit-effort" id="btnSubmit">
                            <i class="fas fa-check-circle"></i>
                            Submit Efforts
                        </button>
                        <button class="btn btn-add-allocation" id="btnAddAllocation">
                            <i class="fas fa-plus-circle"></i>
                            Add Allocation
                        </button>
                        <button class="btn btn-record-leave" id="btnRecordLeave">
                            <i class="fas fa-calendar-times"></i>
                            Record Leave
                        </button>
                    </div>
                </div>
            </div>

            <!-- Allocations Container -->
            <div class="allocations-container">
                {% if groups %}
                    {% for group_key, group in groups.items %}
                        {% for row in group.rows %}
                        <div class="allocation-card" data-tdid="{{ row.team_distribution_id }}">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">{{ row.project_name }}</div>
                                    <div class="card-subtitle">{{ row.subproject_name }}</div>
                                </div>
                                {% if row.is_self_allocation %}
                                <span class="self-allocation-badge">
                                    <i class="fas fa-user-plus"></i> Self Added
                                </span>
                                {% endif %}
                            </div>

                            <div class="card-body">
                                <table class="allocation-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Week</th>

                                            <th style="width: 12%;">Working Days</th>
                                            <th style="width: 10%;">Max %</th>
                                            <th style="width: 12%;">Allocated Hours</th>
                                            <th style="width: 10%;">Leave Hours</th>
                                            <th style="width: 13%;">Punched Hours</th>
                                            <th style="width: 15%;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for week in row.weeks_list %}
                                        <tr data-tdid="{{ row.team_distribution_id }}"
                                            data-week="{{ week.week_number }}"
                                            data-editable="{{ week.is_editable|yesno:'true,false' }}">
                                            <td><strong>Week {{ week.week_number }}</strong></td>

                                            <td>{{ week.working_days }} days</td>
                                            <td>{{ week.max_percent }}%</td>
                                            <td><strong>{{ week.allocated_hours }}h</strong></td>
                                            <td>
                                                {% if week.leave_hours %}
                                                    <span class="badge badge-warning" style="background: #fef5e7; color: #d68910; padding: 6px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                        {{ week.leave_hours }}h Leave
                                                    </span>
                                                {% else %}
                                                    <span style="color: #cbd5e0;">—</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <input type="number"
                                                              class="form-control punch-input"
                                                              value="{{ week.punched_hours }}"
                                                              {% if week.status == 'SUBMITTED' %}disabled{% endif %}>
                                                {% if week.leave_hours %}
                                                    <small style="display: block; margin-top: 4px; color: #718096; font-size: 11px;">
                                                        Max: {{ week.available_hours }}h ({{ week.allocated_hours }}h - {{ week.leave_hours }}h leave)
                                                    </small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="status-badge status-{{ week.status|lower }}">
                                                    {{ week.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <div class="allocation-card">
                        <div class="card-body">
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <h3>No Allocations Found</h3>
                                <p>You don't have any allocations for this period. Use "Add Allocation" to create one.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Add Allocation Modal -->
        <div id="addAllocationModal" class="modal-overlay">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h4 class="modal-title">
                        <i class="fas fa-plus-circle"></i>
                        Add Self Allocation
                    </h4>
                    <button class="modal-close" id="btnModalClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Project Selection -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-project-diagram"></i>
                            Project Selection
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="modalProject">
                                    Project <span style="color: #e53e3e;">*</span>
                                </label>
                                <select id="modalProject" required>
                                    <option value="">Select Project...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="modalSubproject">
                                    Subproject <span style="color: #e53e3e;">*</span>
                                </label>
                                <select id="modalSubproject" disabled required>
                                    <option value="">Select Subproject...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Week-wise Allocation -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-calendar-week"></i>
                            Week-wise Effort Allocation
                        </div>

                        <table class="week-allocation-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Week</th>
                                    <th style="width: 45%;">Date Range</th>
                                    <th style="width: 40%;">% Effort</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week in all_weeks_list %}
                                <tr>
                                    <td><strong>Week {{ week.num }}</strong></td>
                                    <td>{{ week.start|date:"M d, Y" }} - {{ week.end|date:"M d, Y" }}</td>
                                    <td>
                                        <input type="number"
                                               class="modal-percent-input"
                                               data-week="{{ week.num }}"
                                               step="0.01"
                                               min="0"
                                               max="100"
                                               value="0"
                                               placeholder="0.00">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" id="btnModalCancel">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" id="btnModalSave">
                        <i class="fas fa-check"></i> Save Allocation
                    </button>
                </div>
            </div>
        </div>
        <!-- Record Leave Modal -->
        <div id="recordLeaveModal" class="modal-overlay">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h4 class="modal-title">
                        <i class="fas fa-calendar-times"></i>
                        Record Leave
                    </h4>
                    <button class="modal-close" id="btnLeaveModalClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-info-circle"></i>
                            Leave Details
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveWeek">
                                    Week <span style="color: #e53e3e;">*</span>
                                </label>
                                <select id="leaveWeek" required>
                                    <option value="">Select Week...</option>
                                    {% for week in all_weeks_list %}
                                    <option value="{{ week.num }}">
                                        Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="leaveType">
                                    Leave Type <span style="color: #e53e3e;">*</span>
                                </label>
                                <select id="leaveType" required>
                                    <option value="">Select Type...</option>
                                    <option value="CASUAL">Casual Leave</option>
                                    <option value="SICK">Sick Leave</option>
                                    <option value="EARNED">Earned Leave</option>
                                    <option value="UNPAID">Unpaid Leave</option>
                                    <option value="MATERNITY">Maternity Leave</option>
                                    <option value="PATERNITY">Paternity Leave</option>
                                    <option value="COMPENSATORY">Compensatory Off</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveHours">
                                    Leave Hours <span style="color: #e53e3e;">*</span>
                                </label>
                                <input type="number"
                                       id="leaveHours"
                                       step="0.01"
                                       min="0"
                                       max="40"
                                       placeholder="0.00"
                                       required>
                            </div>

                            <div class="form-group">
                                <label for="leaveDays">
                                    Leave Days (auto-calculated)
                                </label>
                                <input type="text"
                                       id="leaveDays"
                                       readonly
                                       style="background: #f7fafc;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="leaveReason">
                                Reason (Optional)
                            </label>
                            <textarea id="leaveReason"
                                      rows="3"
                                      maxlength="500"
                                      placeholder="Enter reason for leave..."
                                      style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" id="btnLeaveModalCancel">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" id="btnLeaveModalSave">
                        <i class="fas fa-check"></i> Save Leave
                    </button>
                </div>
            </div>
        </div>
        {% endblock %}

        {% block extra_js %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === DOM ELEMENTS ===
            const weekSelector = document.getElementById('weekSelector');
            const btnSaveDraft = document.getElementById('btnSaveDraft');
            const btnSubmit = document.getElementById('btnSubmit');
            const btnAddAllocation = document.getElementById('btnAddAllocation');
            const btnRecordLeave = document.getElementById('btnRecordLeave');
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');

            // Add Allocation Modal
            const modal = document.getElementById('addAllocationModal');
            const modalProject = document.getElementById('modalProject');
            const modalSubproject = document.getElementById('modalSubproject');
            const btnModalClose = document.getElementById('btnModalClose');
            const btnModalCancel = document.getElementById('btnModalCancel');
            const btnModalSave = document.getElementById('btnModalSave');

            // Record Leave Modal
            const leaveModal = document.getElementById('recordLeaveModal');
            const leaveWeek = document.getElementById('leaveWeek');
            const leaveType = document.getElementById('leaveType');
            const leaveHours = document.getElementById('leaveHours');
            const leaveDays = document.getElementById('leaveDays');
            const leaveReason = document.getElementById('leaveReason');
            const btnLeaveModalClose = document.getElementById('btnLeaveModalClose');
            const btnLeaveModalCancel = document.getElementById('btnLeaveModalCancel');
            const btnLeaveModalSave = document.getElementById('btnLeaveModalSave');

            let projectsData = [];
            const BILLING_START = '{{ billing_start|date:"Y-m-d" }}';
            const BILLING_END = '{{ billing_end|date:"Y-m-d" }}';
            const HOURS_PER_DAY = 8;


            // Add keyboard support for Enter key
            document.addEventListener('DOMContentLoaded', function() {
                const yearSelect = document.getElementById('yearSelect');
                const monthSelect = document.getElementById('monthSelect');

                [yearSelect, monthSelect].forEach(select => {
                    if (select) {
                        select.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                changeMonthYear();
                            }
                        });
                    }
                });
            });
            // === WEEK SELECTOR ===
            weekSelector.addEventListener('change', function() {
                const url = new URL(window.location.href);
                url.searchParams.set('week', this.value);
                window.location.href = url.toString();
            });

            // === RECORD LEAVE MODAL ===
            btnRecordLeave.addEventListener('click', function() {
                // Reset form
                leaveWeek.value = '';
                leaveType.value = '';
                leaveHours.value = '';
                leaveDays.value = '';
                leaveReason.value = '';

                leaveModal.classList.add('active');
            });

            // Auto-calculate leave days
            leaveHours.addEventListener('input', function() {
                const hours = parseFloat(this.value) || 0;
                const days = (hours / HOURS_PER_DAY).toFixed(2);
                leaveDays.value = `${days} days`;
            });

            btnLeaveModalClose.addEventListener('click', closeLeaveModal);
            btnLeaveModalCancel.addEventListener('click', closeLeaveModal);

            leaveModal.addEventListener('click', function(e) {
                if (e.target === leaveModal) {
                    closeLeaveModal();
                }
            });

            function closeLeaveModal() {
                leaveModal.classList.remove('active');
            }

            btnLeaveModalSave.addEventListener('click', async function() {
                const week = parseInt(leaveWeek.value);
                const type = leaveType.value;
                const hours = parseFloat(leaveHours.value) || 0;
                const reason = leaveReason.value.trim();

                if (!week || !type || hours <= 0) {
                    showNotification('Please fill all required fields', 'warning');
                    return;
                }

                try {
                    const response = await fetch('{{ record_leave_url }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            billing_start: BILLING_START,
                            billing_end: BILLING_END,
                            week_number: week,
                            leave_hours: hours,
                            leave_type: type,
                            reason: reason
                        })
                    });

                    const data = await response.json();

                    if (data.ok) {
                        showNotification('Leave recorded successfully!', 'success');
                        closeLeaveModal();
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showNotification('Error: ' + data.error, 'error');
                    }
                } catch (err) {
                    showNotification('Network error occurred', 'error');
                    console.error(err);
                }
            });

            // === SAVE DRAFT ===
            btnSaveDraft.addEventListener('click', async function() {
                const efforts = collectEffortData();

                if (efforts.length === 0) {
                    showNotification('No editable efforts to save', 'warning');
                    return;
                }

                try {
                    const response = await fetch('{{ save_effort_url }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ efforts: efforts })
                    });

                    const data = await response.json();

                    if (data.ok) {
                        showNotification('Draft saved successfully!', 'success');
                        // Optional: Reload to show updated status
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        // Show specific validation errors if available
                        if (data.details && Array.isArray(data.details)) {
                            const errorMsg = data.details.join('\n');
                            showNotification(errorMsg, 'error');
                        } else {
                            showNotification('Error: ' + data.error, 'error');
                        }
                    }
                } catch (err) {
                    showNotification('Network error occurred', 'error');
                    console.error(err);
                }
            });

            // === SUBMIT EFFORTS ===
            // In btnSubmitEffort click handler
            btnSubmit.addEventListener('click', async function() {
                const year = document.getElementById('yearFilter').value;
                const month = document.getElementById('monthFilter').value;
                const monthStr = `${year}-${month.padStart(2, '0')}`;

                // Collect all weeks with punched hours
                const weeks = [];
                document.querySelectorAll('.allocation-card').forEach(card => {
                    const tdId = card.dataset.teamDistributionId;

                    card.querySelectorAll('.week-row').forEach(row => {
                        const weekNum = row.dataset.weekNumber;
                        const punchedInput = row.querySelector('.punched-hours-input');
                        const punchedHours = parseFloat(punchedInput?.value || 0);

                        weeks.push({
                            team_distribution_id: parseInt(tdId),
                            week_number: parseInt(weekNum),
                            punched_hours: punchedHours
                        });
                    });
                });

                try {
                    const resp = await fetch('/projects/my-allocations/submit/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            month: monthStr,
                            weeks: weeks
                        })
                    });

                    const data = await resp.json();
                    if (data.ok) {
                        showNotification('Efforts submitted successfully!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        const errorMsg = data.details
                            ? data.details.join('\n')
                            : data.error;
                        showNotification(errorMsg, 'error');
                    }
                } catch (err) {
                    showNotification('Submission failed: ' + err.message, 'error');
                }
            });

            // === ADD ALLOCATION MODAL (existing code) ===
            btnAddAllocation.addEventListener('click', async function() {
                try {
                    const response = await fetch('{{ get_projects_url }}');
                    const data = await response.json();

                    if (data.ok) {
                        projectsData = data.projects;

                        modalProject.innerHTML = '<option value="">Select Project...</option>';
                        data.projects.forEach(proj => {
                            modalProject.innerHTML += `<option value="${proj.id}">${proj.name}</option>`;
                        });

                        modalSubproject.innerHTML = '<option value="">Select Subproject...</option>';
                        modalSubproject.disabled = true;
                        document.querySelectorAll('.modal-percent-input').forEach(input => {
                            input.value = 0;
                        });

                        modal.classList.add('active');
                    }
                } catch (err) {
                    showNotification('Failed to load projects', 'error');
                    console.error(err);
                }
            });

            modalProject.addEventListener('change', function() {
                const projectId = parseInt(this.value);
                const project = projectsData.find(p => p.id === projectId);

                modalSubproject.disabled = !project;
                modalSubproject.innerHTML = '<option value="">Select Subproject...</option>';

                if (project && project.subprojects) {
                    project.subprojects.forEach(sub => {
                        modalSubproject.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                    });
                }
            });

            btnModalClose.addEventListener('click', closeModal);
            btnModalCancel.addEventListener('click', closeModal);

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            function closeModal() {
                modal.classList.remove('active');
            }

            btnModalSave.addEventListener('click', async function() {
                const projectId = parseInt(modalProject.value);
                const subprojectId = parseInt(modalSubproject.value);

                if (!projectId || !subprojectId) {
                    showNotification('Please select both project and subproject', 'warning');
                    return;
                }

                const allocations = [];
                document.querySelectorAll('.modal-percent-input').forEach(input => {
                    const pct = parseFloat(input.value) || 0;
                    if (pct > 0) {
                        allocations.push({
                            week_number: parseInt(input.dataset.week),
                            percent_effort: pct
                        });
                    }
                });

                if (allocations.length === 0) {
                    showNotification('Please enter at least one week allocation', 'warning');
                    return;
                }

                try {
                    const response = await fetch('{{ add_allocation_url }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            project_id: projectId,
                            subproject_id: subprojectId,
                            month_start: BILLING_START,
                            allocations: allocations
                        })
                    });

                    const data = await response.json();

                    if (data.ok) {
                        showNotification('Allocation added successfully!', 'success');
                        closeModal();
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showNotification('Error: ' + data.error, 'error');
                    }
                } catch (err) {
                    showNotification('Network error occurred', 'error');
                    console.error(err);
                }
            });

            // === HELPER FUNCTIONS ===
            function collectEffortData() {
                const efforts = [];
                document.querySelectorAll('tbody tr[data-editable="true"]').forEach(row => {
                    const input = row.querySelector('.effort-input');
                    if (input) {
                        const punchedHours = parseFloat(input.value) || 0;
                        const maxHours = parseFloat(input.getAttribute('max')) || 0;

                        // Validate against available hours (allocated - leave)
                        if (punchedHours > maxHours) {
                            showNotification(`Punched hours exceed available hours for Week ${row.dataset.week}`, 'warning');
                            return;
                        }

                        efforts.push({
                            team_distribution_id: parseInt(row.dataset.tdid),
                            week_number: parseInt(row.dataset.week),
                            punched_hours: punchedHours
                        });
                    }
                });
                return efforts;
            }


            function showNotification(message, type) {
                const colors = {
                    success: { bg: '#d5f4e6', border: '#0e7c4e', text: '#0e7c4e' },
                    error: { bg: '#fadbd8', border: '#a93226', text: '#a93226' },
                    warning: { bg: '#fef5e7', border: '#d68910', text: '#d68910' },
                    info: { bg: '#d6eaf8', border: '#1a5490', text: '#1a5490' }
                };

                const color = colors[type] || colors.info;

                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    min-width: 300px;
                    max-width: 500px;
                    background: ${color.bg};
                    color: ${color.text};
                    border-left: 4px solid ${color.border};
                    padding: 16px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-weight: 600;
                    animation: slideInRight 0.3s ease;
                `;

                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };

                notification.innerHTML = `
                    <i class="${icons[type]}" style="font-size: 20px;"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()"
                            style="margin-left: auto; background: none; border: none;
                                   color: ${color.text}; font-size: 20px; cursor: pointer;
                                   opacity: 0.7; padding: 0; width: 24px; height: 24px;">
                        ×
                    </button>
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        function handleFilterChange() {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                window.location.href = `?year=${year}&month=${month}`;
            }
            function changeMonthYear() {
                console.log("=== changeMonthYear() called ===");

                const yearSel = document.getElementById("yearSelect");
                const monthSel = document.getElementById("monthSelect");

                console.log("Year selector element:", yearSel);
                console.log("Month selector element:", monthSel);

                if (!yearSel || !monthSel) {
                    console.error("Year or month selector not found");
                    console.error("yearSel is null:", yearSel === null);
                    console.error("monthSel is null:", monthSel === null);
                    return;
                }

                const year = yearSel.value;
                const month = monthSel.value;

                console.log("Raw year value:", year);
                console.log("Raw month value:", month);
                console.log("Year type:", typeof year);
                console.log("Month type:", typeof month);

                const paddedMonth = month.padStart(2, '0');
                console.log("Padded month:", paddedMonth);

                if (!year || !month) {
                    console.warn("Missing year or month");
                    console.warn("Year empty?", !year);
                    console.warn("Month empty?", !month);
                    showNotification('Please select both year and month', 'warning');
                    return;
                }

                // Construct YYYY-MM format
                const billingMonth = `${year}-${paddedMonth}`;
                console.log("Constructed billing month:", billingMonth);

                // Show loading state
                const searchBtn = document.getElementById('searchBtn');
                console.log("Search button element:", searchBtn);

                if (searchBtn) {
                    console.log("Disabling search button");
                    searchBtn.disabled = true;
                    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                } else {
                    console.warn("Search button not found!");
                }

                // Construct URL with separate year and month parameters
                const targetUrl = `/projects/my-allocations/?year=${encodeURIComponent(year)}&month=${encodeURIComponent(paddedMonth)}`;
                console.log("Target URL:", targetUrl);
                console.log("Encoded year:", encodeURIComponent(year));
                console.log("Encoded month:", encodeURIComponent(paddedMonth));

                console.log("Redirecting to:", targetUrl);
                console.log("Current location before redirect:", window.location.href);

                window.location.href = targetUrl;

                console.log("=== changeMonthYear() completed ===");
            }
        </script>
        {% endblock %}