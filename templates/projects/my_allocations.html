{# templates/projects/my_allocations.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}My Weekly Allocations{% endblock %}

{% block extra_css %}
<style>
/* -- layout / card / header -- */
.container { padding:28px; }
.card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(15,30,60,0.06); }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
.controls { display:flex; gap:8px; align-items:center; }

/* -- table -- */
.table { width:100%; border-collapse:collapse; margin-top:10px; }
.table th, .table td { padding:10px 12px; border-bottom:1px solid #f3f6f9; text-align:left; vertical-align:middle; }
.table th { background:#fbfcfe; color:#334155; font-weight:600; font-size:13px; }
.text-center { text-align:center; }
.text-right { text-align:right; }

/* -- buttons / badges -- */
.btn { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; color:#fff; font-weight:600; }
.btn-accept { background:#16a34a; }
.btn-reject { background:#ef4444; }
.btn-leave { background:#f59e0b; color:#fff; }
.small-muted { color:#6b7280; font-size:12px; }
.input-leave { width:80px; padding:6px; border-radius:6px; border:1px solid #e6edf3; text-align:right; }

/* badges */
.badge { padding:6px 8px; border-radius:6px; font-weight:600; display:inline-block; }
.badge-pending { background:#fff7ed; color:#92400e; }
.badge-accepted { background:#ecfdf5; color:#065f46; }
.badge-rejected { background:#fff1f2; color:#9f1239; }

/* alerts */
.alert { padding:10px; border-radius:8px; margin-bottom:10px; }
.alert-success { background:#ecfdf5; color:#065f46; border:1px solid #d1fae5; }
.alert-error { background:#fff1f2; color:#9f1239; border:1px solid #fecaca; }

/* modal simple styling */
.modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; }
.modal { background:#fff; border-radius:8px; padding:16px; width:420px; }

/* ensure action buttons inline and compact */
.table .action-cell { white-space:nowrap; }
.table .action-cell button { display:inline-block; vertical-align:middle; margin:0 6px 0 0; }

/* emphasize hours punched text */
.hours-punched { font-weight:700; color:#0b2545; }

/* small responsive tweak */
@media (max-width: 880px) {
  .table th, .table td { padding:8px; font-size:13px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card">
    <div class="header">
      <div>
        <h2 style="margin:0;">My Weekly Allocations — <small class="small-muted">{{ month_label }}</small></h2>
        <div class="small-muted">Billing: {{ billing_start }} — {{ billing_end }} &nbsp; • &nbsp; Max hours: {{ monthly_max_hours }}h</div>
      </div>

      <div class="controls">
        <label class="small-muted">Month:</label>
        <input id="month" type="month" value="{{ billing_start|date:'Y-m' }}" />
        <button id="btnLoad" class="btn" style="background:#2563eb">Load</button>
        <a href="{{ tl_reconsider_url }}" class="btn" style="background:#6b7280; text-decoration:none;">TL Reconsiderations</a>
      </div>
    </div>

    <div id="alertContainer"></div>

    {% if not groups %}
      <div class="small-muted">No allocations found for {{ month_label }}.</div>
    {% else %}
      {% for spid, group in groups.items %}
        <h4 style="margin:8px 0 6px 0;">{{ group.subproject_name }} <small class="small-muted">— {{ group.project_name }}</small></h4>

        {% for row in group.rows %}
          <table class="table">
            <thead>
              <tr>
                <th style="width:60px;">Week#</th>
                <th style="width:160px;">Week Start Date</th>
                <th style="width:160px;">Week End Date</th>
                <th style="width:120px;">Working Days</th>
                <th style="width:140px;">Allocated Efforts %</th>
                <th style="width:160px;">Allocated Efforts (hrs)</th>
                <th style="width:120px;">Leave Hrs</th>
                <th style="width:120px;">Hours Punched</th>
                <th style="width:220px;">Action</th>
              </tr>
            </thead>
            <tbody>
              {# iterate ordered weeks prepared by the view: row.weeks_list #}
              {% for cell in row.weeks_list %}
                <tr data-tdid="{{ row.team_distribution_id }}" data-week="{{ cell.week_number }}">
                  <td>{{ cell.week_number }}</td>
                  <td>{{ cell.week_start }}</td>
                  <td>{{ cell.week_end }}</td>
                  <td class="text-center">{{ cell.working_days }}</td>

                  {# percent may be None; show 0.00% fallback #}
                  <td class="text-right">{% if cell.percent %}{{ cell.percent }}%{% else %}0.00%{% endif %}</td>

                  {# allocated_hours shown as 'XX.XXh' #}
                  <td class="text-right allocated-hours">{{ cell.allocated_hours }}h</td>

                  <td class="text-center">
                    {% if cell.leave_hours %}
                      <span>{{ cell.leave_hours }}h</span>
                    {% else %}
                      <span class="small-muted">—</span>
                    {% endif %}
                    <button class="btn btn-leave js-leave" style="margin-left:8px;" data-tdid="{{ row.team_distribution_id }}" data-week="{{ cell.week_number }}">Leave</button>
                  </td>

                  {# Hours punched — wrap in span.hours-punched for JS updates; include data attributes #}
                  <td class="text-right hours-cell" data-tdid="{{ row.team_distribution_id }}" data-week="{{ cell.week_number }}">
                    <span class="hours-punched">{% if cell.punched_hours %}{{ cell.punched_hours }}h{% else %}{{ cell.allocated_hours }}h{% endif %}</span>
                  </td>

                  <td class="text-center action-cell">
                    {% if cell.status == 'ACCEPTED' %}
                      <span class="badge badge-accepted">ACCEPTED</span>
                    {% elif cell.status == 'RECONSIDERED' %}
                      <span class="badge badge-rejected">RECONSIDERED</span>
                    {% elif cell.status == 'REJECTED' %}
                      <span class="badge badge-rejected">REJECTED</span>
                    {% else %}
                      {# inline Accept + Reconsider with data attributes used by JS #}
                      <button class="btn btn-accept js-accept" data-tdid="{{ row.team_distribution_id }}" data-week="{{ cell.week_number }}">Accept</button>
                      <button class="btn btn-reject js-reconsider" data-tdid="{{ row.team_distribution_id }}" data-week="{{ cell.week_number }}" style="margin-left:8px;">Reconsider</button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      {% endfor %}
    {% endif %}
  </div>
</div>

{# Leave modal #}
<div id="leaveModal" style="display:none;">
  <div class="modal-backdrop" id="leaveBackdrop">
    <div class="modal">
      <h3 style="margin-top:0;">Record Leave</h3>
      <p class="small-muted">Enter leave hours for this week (1 day = 8.75 hrs).</p>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="leaveHours" type="number" step="0.01" min="0" class="input-leave" />
        <div style="flex:1;"></div>
      </div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="leaveCancel" class="btn" style="background:#6b7280;">Cancel</button>
        <button id="leaveSave" class="btn btn-leave">Save Leave</button>
      </div>
    </div>
  </div>
</div>

{# Reconsider modal (comment required) #}
<div id="reconModal" style="display:none;">
  <div class="modal-backdrop" id="reconBackdrop">
    <div class="modal">
      <h3 style="margin-top:0;">Send to TL for Reconsideration</h3>
      <p class="small-muted">Please enter reason/details for TL review (required):</p>
      <textarea id="reconComment" rows="4" style="width:100%; padding:8px; border-radius:6px; border:1px solid #e6edf3;"></textarea>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="reconCancel" class="btn" style="background:#6b7280;">Cancel</button>
        <button id="reconSend" class="btn btn-reject">Send</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Simple helper to read CSRF token cookie
  function cookie(name){ let m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
  const csrftoken = cookie('csrftoken');

  const UPDATE_URL = "{{ update_status_url }}";      // my_allocations_update_status
  const VACATION_URL = "{{ save_vacation_url }}";    // my_allocations_vacation

  // small UI alert
  function showAlert(msg, ok=true){
    const c = document.getElementById('alertContainer');
    if(!c) return;
    const el = document.createElement('div');
    el.className = 'alert ' + (ok ? 'alert-success' : 'alert-error');
    el.innerText = msg;
    c.appendChild(el);
    setTimeout(()=> { try{ el.remove(); } catch(e){} }, 4000);
  }

  // -----------------------
  // Accept (AJAX) - robust replacement
  // -----------------------
  function acceptWeek(allocationId, weekNumber, allocatedHours, billingStart) {
    const url = UPDATE_URL || "{{ update_status_url }}";
    // If allocatedHours not provided, try to read from the row's .allocated-hours cell
    let allocH = allocatedHours;
    try {
      if (typeof allocH === 'undefined' || allocH === null) {
        const row = document.querySelector('tr[data-tdid="'+allocationId+'"][data-week="'+weekNumber+'"]');
        if (row) {
          const allocCell = row.querySelector('.allocated-hours');
          if (allocCell) {
            allocH = parseFloat((allocCell.innerText||'0').replace('h','').trim()) || 0;
          }
        }
      }
    } catch(e) { allocH = allocH || 0; }

    const payload = {
      allocation_id: allocationId,
      week_number: weekNumber,
      billing_start: billingStart || "{{ billing_start }}",
      action: 'accept',
      allocated_hours: allocH || 0
    };

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(resp => {
      if (!resp || resp.error || resp.status === 'error') {
        const msg = resp && (resp.error || resp.detail || 'Server error');
        showAlert(msg, false);
        return;
      }

      // server authoritative values (prefer these)
      let newPunched = null;
      if (typeof resp.accepted_hours_sum !== 'undefined') newPunched = parseFloat(resp.accepted_hours_sum);
      else if (typeof resp.new_hours !== 'undefined') newPunched = parseFloat(resp.new_hours);
      else if (typeof resp.punched_hours !== 'undefined') newPunched = parseFloat(resp.punched_hours);

      // find the row and hours-punched span
      const row = document.querySelector('tr[data-tdid="'+allocationId+'"][data-week="'+weekNumber+'"]');
      if (row) {
        const hp = row.querySelector('.hours-punched');
        if (hp) {
          if (!isNaN(newPunched)) {
            hp.textContent = `${newPunched.toFixed(2)}h`;
          } else if (typeof resp.percent !== 'undefined') {
            const monthly = parseFloat(window.monthly_hours || {{ monthly_max_hours|default:"183.75" }});
            const computed = (parseFloat(resp.percent)/100.0) * monthly;
            hp.textContent = `${computed.toFixed(2)}h`;
          } else {
            // no server value — do not add to existing to avoid duplication
          }
        }

        // update action cell badge (replace buttons with accepted badge)
        const actionCell = row.querySelector('.action-cell');
        if (actionCell) {
          actionCell.innerHTML = '<span class="badge badge-accepted">ACCEPTED</span>';
        }
      } else {
        // fallback selector - try generic hours cell with matching data-week
        const hp2 = document.querySelector('.hours-cell[data-week="'+weekNumber+'"] .hours-punched');
        if (hp2 && !isNaN(newPunched)) hp2.textContent = `${newPunched.toFixed(2)}h`;
      }

      showAlert('Week accepted', true);
    })
    .catch(err => {
      console.error('Accept request failed', err);
      showAlert('Network error', false);
    });
  }

  // -----------------------
  // Reconsider flow
  // -----------------------
  let reconTarget = null;
  function openReconsider(tdid, week){
    reconTarget = {tdid: tdid, week: week};
    document.getElementById('reconComment').value = '';
    document.getElementById('reconModal').style.display = 'block';
  }

  async function sendReconsider(){
    if(!reconTarget) return;
    const comment = (document.getElementById('reconComment').value || '').trim();
    if(comment.length < 3) return showAlert('Please enter a reason for TL', false);

    const payload = { allocation_id: reconTarget.tdid, week_number: reconTarget.week, billing_start: "{{ billing_start }}", action: 'reject', comment: comment };
    try {
      const resp = await fetch(UPDATE_URL, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify(payload)
      });
      const j = await resp.json();
      if(resp.ok && j && j.ok){
        showAlert('Sent to TL for reconsideration');
        const row = document.querySelector('tr[data-tdid="'+reconTarget.tdid+'"][data-week="'+reconTarget.week+'"]');
        if(row) row.querySelector('td.action-cell').innerHTML = '<span class="badge badge-rejected">RECONSIDERED</span>';
      } else {
        showAlert((j && j.error) ? j.error : 'Action failed', false);
      }
    } catch(err){
      console.error('Reconsider error', err);
      showAlert('Server error', false);
    }
    reconTarget = null;
    document.getElementById('reconModal').style.display = 'none';
  }

  // -----------------------
  // Leave flow (unchanged; minor fix to read data attributes)
  // -----------------------
  let leaveTarget = null;
  function openLeave(tdid, week){
    leaveTarget = {tdid: tdid, week: week};
    document.getElementById('leaveHours').value = '';
    document.getElementById('leaveModal').style.display = 'block';
  }

  async function saveLeave(){
    if(!leaveTarget) return;
    const v = parseFloat(document.getElementById('leaveHours').value || 0);
    if(!(v > 0)) return showAlert('Enter leave hours greater than 0', false);

    const payload = { allocation_id: leaveTarget.tdid, week_number: leaveTarget.week, billing_start: "{{ billing_start }}", leave_hours: v };
    try {
      const resp = await fetch(VACATION_URL, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify(payload)
      });
      const j = await resp.json();
      if(resp.ok && j && j.ok){
        showAlert('Leave recorded');

        // Update the table row locally (best-effort). Server may return j.new_hours or j.leave_hours.
        const row = document.querySelector('tr[data-tdid="'+leaveTarget.tdid+'"][data-week="'+leaveTarget.week+'"]');
        if(row){
          // update allocated hours (cell .allocated-hours)
          if(j.new_hours !== undefined){
            const allocCell = row.querySelector('.allocated-hours');
            if(allocCell) allocCell.innerText = (parseFloat(j.new_hours).toFixed(2)) + 'h';
          } else {
            const allocCell = row.querySelector('.allocated-hours');
            if(allocCell){
              const curAlloc = parseFloat((allocCell.innerText || '0').replace('h','').trim()) || 0;
              const newAlloc = Math.max(0, (curAlloc - v)).toFixed(2);
              allocCell.innerText = newAlloc + 'h';
            }
          }

          // update leave hrs display
          const leaveCell = row.querySelector('td:nth-child(7)');
          if(leaveCell){
            leaveCell.innerHTML = '<span>' + ((j.leave_hours !== undefined) ? parseFloat(j.leave_hours).toFixed(2) : v) + 'h</span>'
                                  + '<button class="btn btn-leave js-leave" style="margin-left:8px;" data-tdid="'+leaveTarget.tdid+'" data-week="'+leaveTarget.week+'">Leave</button>';
          }

          // update punched hours (cell .hours-punched)
          const hp = row.querySelector('.hours-punched');
          if(hp){
            const curPunch = parseFloat((hp.innerText || '0').replace('h','').trim()) || 0;
            const newPunch = Math.max(0, (curPunch - v)).toFixed(2);
            hp.innerText = newPunch + 'h';
          }
        }

      } else {
        showAlert((j && j.error) ? j.error : 'Failed to record leave', false);
      }
    } catch(err){
      console.error('Leave error', err);
      showAlert('Server error', false);
    }

    leaveTarget = null;
    document.getElementById('leaveModal').style.display = 'none';
  }

  // -----------------------
  // Event handling (delegated)
  // -----------------------
  document.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;

    // Accept button
    if(t.classList.contains('js-accept') || t.classList.contains('btn-accept')){
      const tdid = t.getAttribute('data-tdid'), week = parseInt(t.getAttribute('data-week'),10);
      acceptWeek(tdid, week);
      return;
    }

    // Reconsider
    if(t.classList.contains('js-reconsider') || t.classList.contains('btn-reject')){
      const tdid = t.getAttribute('data-tdid'), week = parseInt(t.getAttribute('data-week'),10);
      openReconsider(tdid, week);
      return;
    }

    // Open Leave
    if(t.classList.contains('js-leave') || t.classList.contains('btn-leave')){
      const tdid = t.getAttribute('data-tdid'), week = parseInt(t.getAttribute('data-week'),10);
      openLeave(tdid, week);
      return;
    }
  });

  // modal actions wiring
  document.getElementById('reconCancel').addEventListener('click', ()=> document.getElementById('reconModal').style.display = 'none');
  document.getElementById('reconSend').addEventListener('click', sendReconsider);

  document.getElementById('leaveCancel').addEventListener('click', ()=> document.getElementById('leaveModal').style.display = 'none');
  document.getElementById('leaveSave').addEventListener('click', saveLeave);

  // -----------------------
  // Load month button
  // -----------------------
  document.getElementById('btnLoad').addEventListener('click', function(ev){
    ev.preventDefault();
    const m = document.getElementById('month').value;
    if(!m) return;
    const url = new URL(window.location.href);
    url.searchParams.set('month', encodeURIComponent(m));
    // navigate
    window.location.href = url.toString();
  });

})();
</script>
{% endblock %}
