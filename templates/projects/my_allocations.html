{% extends "base.html" %}
{% load dict_get %}
{% load static %}

{% block title %}My Weekly Allocations{% endblock %}

{% block extra_css %}
<style>
    /* === GLOBAL STYLES === */
    .page-container {
        padding: 30px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1a202c;
        margin: 0;
    }

    /* === MONTH/YEAR PICKER === */
    .month-year-picker {
        display: flex;
        align-items: center;
        gap: 15px;
        background: white;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .month-year-picker label {
        font-weight: 600;
        color: #4a5568;
        margin: 0;
        font-size: 14px;
    }

    .month-year-picker select {
        padding: 8px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        min-width: 120px;
        transition: all 0.3s ease;
    }

    .month-year-picker select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* === PAGE HEADER STYLES === */


    .filter-controls {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-group label {
        color: white;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
    }

    .filter-select {
        min-width: 140px;
        padding: 10px 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        font-weight: 600;
        color: #2d3748;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-select:hover {
        border-color: rgba(255, 255, 255, 0.6);
        background: white;
    }

    .filter-select:focus {
        outline: none;
        border-color: white;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .btn-search {
        padding: 10px 28px;
        background: white;
        color: #667eea;
        border: 2px solid white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-search:hover {
        background: #f7fafc;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-search:active {
        transform: translateY(0);
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 20px;
        }

        .filter-controls {
            justify-content: center;
            flex-wrap: wrap;
        }
    }

    @media (max-width: 768px) {
        .filter-controls {
            flex-direction: column;
            width: 100%;
        }

        .filter-group {
            width: 100%;
            justify-content: space-between;
        }

        .filter-select {
            flex: 1;
            min-width: 0;
        }

        .btn-search {
            width: 100%;
            justify-content: center;
        }
    }

    /* === ACTION BAR === */
    .action-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .action-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }

    .week-selector-group {
        flex: 0 0 auto;
        min-width: 280px;
    }

    .week-selector-group label {
        color: white;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: block;
    }

    .week-selector-group select {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .week-selector-group select:focus {
        outline: none;
        border-color: #fff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .action-bar .btn {
        padding: 12px 28px;
        font-weight: 600;
        font-size: 14px;
        border-radius: 8px;
        border: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .btn-save-draft {
        background: #ffffff;
        color: #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-save-draft:hover {
        background: #f7fafc;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-submit-effort {
        background: #48bb78;
        color: white;
        box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
    }

    .btn-submit-effort:hover {
        background: #38a169;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(72, 187, 120, 0.5);
    }

    .btn-add-allocation {
        background: #ed8936;
        color: white;
        box-shadow: 0 2px 8px rgba(237, 137, 54, 0.3);
    }

    .btn-add-allocation:hover {
        background: #dd6b20;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(237, 137, 54, 0.5);
    }

    /* === ALLOCATION CARDS === */
    .allocations-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .allocation-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .allocation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    }

    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 18px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        color: white;
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }

    .card-subtitle {
        color: rgba(255, 255, 255, 0.85);
        font-size: 14px;
        margin-top: 4px;
    }

    .self-allocation-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .card-body {
        padding: 0;
    }

    /* === ALLOCATION TABLE === */
    .allocation-table {
        width: 100%;
        border-collapse: collapse;
    }

    .allocation-table thead {
        background: #f7fafc;
    }

    .allocation-table th {
        padding: 15px 20px;
        text-align: left;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
    }

    /* Add or update these styles in your <style> section */
    .allocation-table th,
    .allocation-table td {
        white-space: normal !important;
        word-break: break-word;
        vertical-align: top;
    }

    .allocation-table th[style*="width: 10%"],
    .allocation-table td[style*="width: 10%"] {
        min-width: 120px;
        max-width: 180px;
    }

    .allocation-table td {
        /* Remove or override any overflow: hidden or text-overflow styles */
        overflow: visible !important;
    }

    .allocation-table td {
        padding: 16px 20px;
        border-bottom: 1px solid #f1f1f1;
        vertical-align: middle;
    }

    .allocation-table tbody tr:last-child td {
        border-bottom: none;
    }

    .allocation-table td strong + br + small {
        display: block;
        margin-top: 2px;
    }

    .allocation-table tbody tr:hover {
        background-color: #f7fafc;
    }

    /* Add to your <style> section */
    .allocation-table th:nth-child(2),
    .allocation-table td:nth-child(2) {
        width: 7%;
        min-width: 60px;
    }

    .allocation-table th:nth-child(3),
    .allocation-table td:nth-child(3) {
        width: 9%;
        min-width: 70px;
    }

    .allocation-table th:nth-child(4),
    .allocation-table td:nth-child(4) {
        width: 8%;
        min-width: 65px;
    }

    .allocation-table th:nth-child(5),
    .allocation-table td:nth-child(5) {
        width: 23%;
    }

    /* In your <style> section, update the width for allocation-table inputs: */
    .allocation-table input[type="number"] {
        width: 90px;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        text-align: right;
        transition: all 0.3s ease;
    }

    .allocation-table input[type="number"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .allocation-table input:disabled {
        background-color: #f7fafc;
        color: #a0aec0;
        cursor: not-allowed;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-draft {
        background: #fef5e7;
        color: #d68910;
    }

    .status-submitted {
        background: #d5f4e6;
        color: #0e7c4e;
    }

    .status-approved {
        background: #d6eaf8;
        color: #1a5490;
    }

    .status-rejected {
        background: #fadbd8;
        color: #a93226;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #a0aec0;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 20px;
        margin-bottom: 10px;
        color: #718096;
    }

    /* === MODAL OVERLAY === */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.65);
        z-index: 9999;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-dialog {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px 30px;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        color: white;
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }

    .form-section {
        margin-bottom: 25px;
    }

    .form-section-title {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        color: #4a5568;
        margin-bottom: 8px;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group select:disabled {
        background-color: #f7fafc;
        color: #a0aec0;
        cursor: not-allowed;
    }

    .week-allocation-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .week-allocation-table thead {
        background: #f7fafc;
    }

    .week-allocation-table th {
        padding: 12px 15px;
        text-align: left;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
    }

    .week-allocation-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f1f1;
    }

    .week-allocation-table tbody tr:hover {
        background-color: #f7fafc;
    }

    .week-allocation-table input[type="number"] {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .week-allocation-table input[type="number"]:focus {
        outline: none;
        border-color: #667eea;
    }

    .modal-footer {
        padding: 20px 30px;
        border-top: 2px solid #f1f1f1;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: #fafafa;
        border-radius: 0 0 16px 16px;
    }

    .modal-footer .btn {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    .btn-record-leave {
        background: #e53e3e;
        color: white;
        box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
    }

    .btn-record-leave:hover {
        background: #c53030;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(229, 62, 62, 0.5);
    }

    .leave-allocation-card {
        border: 2px solid #e57373;
        box-shadow: 0 2px 12px rgba(229, 115, 115, 0.15);
    }
    .leave-allocation-card .card-header {
        background: linear-gradient(135deg, #e57373 0%, #ffb199 100%);
    }
    .punch-input,
    .daily-effort-input {
        width: 90px;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px; /* Rounded corners */
        font-size: 14px;
        font-weight: 600;
        text-align: right;
        background: #f8fafc;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.07); /* Subtle shadow */
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .punch-input:focus,
    .daily-effort-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        background: #fff;
        outline: none;
    }

    .punch-input:disabled,
    .daily-effort-input:disabled {
        background-color: #f1f5f9;
        color: #a0aec0;
        cursor: not-allowed;
    }
    .leave-allocation-card .allocation-table th,
    .leave-allocation-card .allocation-table td {
        padding: 6px 10px;
    }
    /* css */
    .week-block { margin-bottom:32px; background:#ffffff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); padding:12px 16px; }
    .week-header { display:flex; justify-content:space-between; align-items:center; padding:8px 4px 12px; }
    .week-table { width:100%; border-collapse:separate; border-spacing:0 6px; }
    .week-table th { background:#667eea; color:#fff; font-weight:600; padding:8px 10px; font-size:13px; }
    .week-table td { background:#f8fafc; padding:6px 8px; font-size:13px; border-radius:6px; }
    .week-row td:first-child { font-weight:600; }
    .week-table th:nth-child(2),
    .week-table td:nth-child(2), /* Project */
    .week-table th:nth-child(3),
    .week-table td:nth-child(3), /* TL Allocation */
    .week-table th:nth-child(4),
    .week-table td:nth-child(4)  /* Act. Effort */
    {
        text-align: center;
    }

      /* Footer actions (per-week) */
      .week-footer-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-start;
        padding: 10px 12px 14px;
      }
      .week-footer-actions .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border: none;
        border-radius: 999px; /* pill */
        font-size: 13px;
        font-weight: 700;
        text-transform: none;
        letter-spacing: 0.2px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      .week-footer-actions .btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 5px rgba(0,0,0,0.08);
      }
      .week-footer-actions .btn i {
        font-size: 14px;
      }
      .week-footer-actions .btn-save-draft {
        background: #ffffff;
        color: #334155;
        border: 1px solid #e2e8f0;
      }
      .week-footer-actions .btn-save-draft:hover {
        background: #f8fafc;
        border-color: #cbd5e0;
        transform: translateY(-1px);
      }
      .week-footer-actions .btn-submit-effort {
        background: #22c55e; /* green */
        color: #ffffff;
      }
      .week-footer-actions .btn-submit-effort:hover {
        background: #16a34a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34,197,94,0.35);
      }

      /* Compact on small screens */
      @media (max-width: 768px) {
        .week-footer-actions {
          justify-content: stretch;
        }
        .week-footer-actions .btn {
          flex: 1 1 auto;
          justify-content: center;
        }
      }


    /* === ANIMATIONS === */
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
        .action-row {
            flex-direction: column;
            align-items: stretch;
        }

        .action-buttons {
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .modal-dialog {
            max-width: 100%;
            max-height: 95vh;
        }
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;

    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: white;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">

        <!-- Action Bar with Week Selector and Buttons -->
<input type="hidden" id="hiddenMonthStart" value="{{ billing_start|date:'Y-m-d' }}">
<input type="hidden" id="hiddenWeeksData" value="{{ all_weeks_list_json }}">
<div class="action-bar">

     <div class="page-header">
            <h1 class="page-title">My Weekly Allocations</h1>

            <div class="filter-controls">
                <div class="filter-group">
                    <label for="yearSelect">Year:</label>
                    <select id="yearSelect" class="filter-select">
                      {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                      {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="monthSelect">Month:</label>
                    <select id="monthSelect" class="filter-select">
                      {% for month in months %}
                        <option value="{{ month.num }}" {% if month.num == selected_month %}selected{% endif %}>{{ month.name }}</option>
                      {% endfor %}
                    </select>

                </div>

                <button id="searchBtn" class="btn-search" onclick="changeMonthYear()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </div>
        </div>
        <div class="action-row">
            <div class="week-selector-group">
                <label for="weekSelector">Select Week</label>
                <select id="weekSelector">
                    <option value="all" {% if selected_week == 'all' %}selected{% endif %}>
                        All Weeks
                    </option>
                    {% for week in all_weeks_list %}
                    <option value="{{ week.num }}"
                            {% if selected_week|stringformat:"s" == week.num|stringformat:"s" %}selected{% endif %}
                            {% if week.num == current_week %}data-current="true"{% endif %}>
                        Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}
                        {% if week.num == current_week %} ★{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="action-buttons">

                <button class="btn btn-add-allocation" id="btnAddAllocation">
                    <i class="fas fa-plus-circle"></i>
                    Add Allocation
                </button>

            </div>
        </div>
    </div>
    <div class="allocations-container">
      {% for week in weeks %}
        {% if selected_week == 'all' or week.num|stringformat:"s" == selected_week|stringformat:"s" %}
        <div class="week-block">
          <div class="week-header">
            <h3>Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}</h3>

          </div>

          <table class="week-table">
            <thead>
              <tr>
                <th style="width:4%;">
                  <input type="checkbox" class="week-select-all" data-week="{{ week.num }}">
                </th>
                <th style="width:18%;">Program</th>
                <th style="width:18%;">Project</th>

                {% if not is_eu_user %}
                    <th style="width:8%;">TL Allocation</th>
                    <th style="width:8%;">Act. Effort</th>
                {% endif %}
                {% for ab in day_order %}
                  <th style="width:6%;">
                    {{ ab }}{% if is_eu_user %} %{% endif %}
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in week.rows %}
              <tr class="week-row"
                  data-week="{{ row.week_num }}"
                  data-tdid="{{ row.team_distribution_id }}"
                  data-project-id="{{ row.project_id }}"
                  data-subproject-id="{{ row.subproject_id }}">
                <!-- Checkbox must be inside the first cell -->
                <td style="text-align:center;">
                  <input type="checkbox"
                         class="week-row-select"
                         data-week="{{ row.week_num }}"
                         data-tdid="{{ row.team_distribution_id }}">
                </td>

                <td>{{ row.project_name }}</td>
                <td>{{ row.subproject_name }}</td>
                {% comment %} Always render TL Allocation cell for JS, hide for non-EU users {% endcomment %}
                {% if not is_eu_user %}
                  <td class="tl-allocation">{{ row.tl_allocation_hours }}</td>
                  <td class="actual-weekly-effort">{{ row.actual_effort }}</td>
                {% endif %}

                {% for slot in row.day_slots %}
                <td>
                  {% if slot %}
                    <div style="text-align:center;">
                      <input type="number"
                                 class="punch-input daily-effort-input"
                                 step="0.01"
                                 min="0"
                                 max="{% if is_eu_user %}100{% else %}24{% endif %}"
                                 value="{{ slot.punched_hours|default:'0.00' }}"
                                 data-date="{{ slot.date }}"
                                 data-week="{{ row.week_num }}"
                                 data-tdid="{{ row.team_distribution_id }}"
                                 data-project-id="{{ row.project_id }}"
                                 data-subproject-id="{{ row.subproject_id }}"
                                 data-month-start="{{ billing_start|date:'Y-m-d' }}"
                                 data-tl-allocation="{{ row.tl_allocation_hours }}"
                                 {% if not slot.is_editable %}disabled{% endif %}
                                 style="width:70px;text-align:right;{% if slot.leave_hours %}background:#ffeaea;{% endif %}">
                    </div>
                  {% else %}
                    <div style="height:34px;"></div>
                  {% endif %}
                </td>
                {% endfor %}
              </tr>
              {% endfor %}

              {% if week.rows|length == 0 %}
              <tr>
                <td colspan="{{ day_order|length|add:5 }}" style="text-align:center;color:#718096;">
                  No allocations this week
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>

          <!-- Footer action buttons for this week -->
          <div class="week-footer-actions">
              <button class="btn btn-save-draft" data-week="{{ week.num }}">
                <i class="fas fa-save"></i>
                Save Draft
              </button>
              <button class="btn btn-submit-effort" data-week="{{ week.num }}">
                <i class="fas fa-paper-plane"></i>
                Submit
              </button>
            </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
</div>
{% if leave_allocations %}
    <div class="allocation-card leave-allocation-card">
        <div class="card-header" style="background: linear-gradient(135deg, #e57373 0%, #ffb199 100%);">
            <div class="card-title">
                <i class="fas fa-calendar-times"></i> Applied Leave
            </div>
        </div>
        <div class="card-body">
            <table class="allocation-table">
                <thead>
                  <tr>
                    <th style="width: 6%; padding-left: 12px;">S.NO</th>
                    <th style="width: 16%;">DATE</th>
                    <th style="width: 14%;">DAY</th>
                    <th style="width: 12%;">HOURS</th>

                    <th style="width: 14%;">TYPE</th>
                    <th>REASON</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in leave_allocations %}
                    <tr>
                      <td style="padding-left: 12px;">{{ row.sno }}</td>
                      <td>{{ row.date|date:"M. d, Y" }}</td>
                      <td>{{ row.day_name }}</td>
                      <td>{{ row.hours|floatformat:2 }}</td>

                      <td>{{ row.leave_type }}</td>
                      <td>{{ row.description }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
<!-- Add Allocation Modal (Redesigned for Day-wise Punching) -->
<div id="addAllocationModal" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-header">
            <h4 class="modal-title">
                <i class="fas fa-plus-circle"></i>
                Add Self Allocation
            </h4>
            <button class="modal-close" id="btnModalClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-project-diagram"></i>
                    Project Selection
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalProject">
                            Project <span style="color: #e53e3e;">*</span>
                        </label>
                        <select id="modalProject" required>
                            <option value="">Select Project...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalSubproject">
                            Subproject <span style="color: #e53e3e;">*</span>
                        </label>
                        <select id="modalSubproject" disabled required>
                            <option value="">Select Subproject...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-calendar-week"></i>
                    Day-wise Effort Punching
                </div>
                <div class="form-group">
                    <label for="modalWeekSelector">Select Week</label>
                    <select id="modalWeekSelector" required>
                        <option value="">Select Week...</option>
                        {% for week in all_weeks_list %}
                        <option value="{{ week.num }}">
                            Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <table class="week-allocation-table" id="modalDayTable">
                    <thead>
                    <tr>
                        <th style="width: 30%;">Day</th>
                        <th style="width: 40%;">Date</th>
                        <th style="width: 30%;">Effort (hours)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Populated by JS based on selected week -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btnModalCancel">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" id="btnModalSave">
                <i class="fas fa-check"></i> Save Allocation
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function showNotification(message, type) {
            const colors = {
                success: {bg: '#d5f4e6', border: '#0e7c4e', text: '#0e7c4e'},
                error: {bg: '#fadbd8', border: '#a93226', text: '#a93226'},
                warning: {bg: '#fef5e7', border: '#d68910', text: '#d68910'},
                info: {bg: '#d6eaf8', border: '#1a5490', text: '#1a5490'}
            };
            const color = colors[type] || colors.info;
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        max-width: 500px;
        background: ${color.bg};
        color: ${color.text};
        border-left: 4px solid ${color.border};
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
    `;
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            notification.innerHTML = `
        <i class="${icons[type]}" style="font-size: 20px;"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()"
                style="margin-left: auto; background: none; border: none;
                       color: ${color.text}; font-size: 20px; cursor: pointer;
                       opacity: 0.7; padding: 0; width: 24px; height: 24px;">
            ×
        </button>
    `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
    document.addEventListener('DOMContentLoaded', function () {
// === DOM ELEMENTS ===
        const weekSelector = document.getElementById('weekSelector');
        const btnAddAllocation = document.getElementById('btnAddAllocation');
        //const btnRecordLeave = document.getElementById('btnRecordLeave');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
// Add Allocation Modal
        const modal = document.getElementById('addAllocationModal');
        const modalProject = document.getElementById('modalProject');
        const modalSubproject = document.getElementById('modalSubproject');
        const btnModalClose = document.getElementById('btnModalClose');
        const btnModalCancel = document.getElementById('btnModalCancel');
        const btnModalSave = document.getElementById('btnModalSave');
        const modalWeekSelector = document.getElementById('modalWeekSelector');
        const modalDayTable = document.getElementById('modalDayTable');

// Record Leave Modal
        const leaveModal = document.getElementById('recordLeaveModal');
        const leaveStartDate = document.getElementById('leaveStartDate');
        const leaveEndDate = document.getElementById('leaveEndDate');
        const leaveType = document.getElementById('leaveType');
        const leaveDays = document.getElementById('leaveDays');
        const leaveReason = document.getElementById('leaveReason');
        const btnLeaveModalClose = document.getElementById('btnLeaveModalClose');
        const btnLeaveModalCancel = document.getElementById('btnLeaveModalCancel');
        const btnLeaveModalSave = document.getElementById('btnLeaveModalSave');

        const HOURS_PER_DAY = 8.75;

        let projectsData = [];
        const BILLING_START = '{{ month_start|date:"Y-m-d" }}';
        const BILLING_END = '{{ month_end|date:"Y-m-d" }}';

        // --- Add Allocation Modal (with day-wise effort) ---
        if (btnAddAllocation) {   // new line added to open the open the modal
        btnAddAllocation.addEventListener('click', async function () {
            try {
                const response = await fetch('{{ get_projects_url }}');
                const data = await response.json();
                if (data.ok) {
                    projectsData = data.projects;
                    modalProject.innerHTML = '<option value="">Select Project...</option>';
                    data.projects.forEach(proj => {
                        modalProject.innerHTML += `<option value="${proj.id}">${proj.name}</option>`;
                    });
                    modalSubproject.innerHTML = '<option value="">Select Subproject...</option>';
                    modalSubproject.disabled = true;
                    modal.classList.add('active');
                    setupModalWeekSelector();
                }
            } catch (err) {
                showNotification('Failed to load projects', 'error');
                console.error(err);
            }
        });
    }

        // --- Main page event listeners ---
        // --- EU/Non-EU punch input display fix ---
        document.querySelectorAll('.punch-input').forEach(input => {
            const isEuUser = {{ is_eu_user|yesno:"true,false" }};
            const HOURS_PER_DAY = 8.75;
            if (isEuUser && input.value !== '') {
                let hours = parseFloat(input.value);
                let percent = hours > 0 ? (hours / HOURS_PER_DAY) * 100 : 0;
                input.value = percent ? percent.toFixed(2) : '';
                console.log(`Converted hours to percent: ${hours} -> ${input.value}`);
            }
            input.addEventListener('blur', function () {
                if (this.value !== '') {
                    this.value = parseFloat(this.value).toFixed(2);
                }
            });
        });



        [yearSelect, monthSelect].forEach(select => {
            if (select) {
                select.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        changeMonthYear();
                    }
                });
            }
        });

        weekSelector.addEventListener('change', function () {
            const url = new URL(window.location.href);
            url.searchParams.set('week', this.value);
            window.location.href = url.toString();
        });

        function calculateLeaveDays() {
            const start = leaveStartDate.value;
            const end = leaveEndDate.value;
            if (!start || !end) {
                leaveDays.value = '';
                return;
            }
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (endDate < startDate) {
                leaveDays.value = 'Invalid range';
                return;
            }
            // Inclusive of both start and end
            const diffDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            leaveDays.value = `${diffDays} (${(diffDays * HOURS_PER_DAY).toFixed(2)} hrs)`;
        }

        leaveStartDate.addEventListener('change', calculateLeaveDays);
        leaveEndDate.addEventListener('change', calculateLeaveDays);

        btnLeaveModalClose.addEventListener('click', closeLeaveModal);
        btnLeaveModalCancel.addEventListener('click', closeLeaveModal);

        leaveModal.addEventListener('click', function (e) {
            if (e.target === leaveModal) closeLeaveModal();
        });

        function closeLeaveModal() {
            leaveModal.classList.remove('active');
            leaveStartDate.value = '';
            leaveEndDate.value = '';
            leaveType.value = '';
            leaveDays.value = '';
            leaveReason.value = '';
        }

        btnLeaveModalSave.addEventListener('click', async function () {
            const start = leaveStartDate.value;
            const end = leaveEndDate.value;
            const type = leaveType.value;
            const reason = leaveReason.value.trim();
            const billingStart = document.getElementById('hiddenBillingStart').value;
            const billingEnd = document.getElementById('hiddenBillingEnd').value;

            if (!start || !end || !type) {
                showNotification('Please select from date, to date, and leave type', 'warning');
                return;
            }
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (endDate < startDate) {
                showNotification('End date cannot be before start date', 'warning');
                return;
            }
            // Optionally, check if dates are within billing period
            if (billingStart && start < billingStart) {
                showNotification('Leave start date is before billing period', 'warning');
                return;
            }
            if (billingEnd && end > billingEnd) {
                showNotification('Leave end date is after billing period', 'warning');
                return;
            }
            const diffDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const leaveHours = (diffDays * HOURS_PER_DAY).toFixed(2);

            // Build payload for backend
            const payload = {
                leave_start: start,
                leave_end: end,
                leave_type: type,
                leave_days: diffDays,
                leave_hours: leaveHours,
                reason: reason
            };

            try {
                const response = await fetch("{% url 'projects:record_leave' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.ok) {
                    showNotification('Leave recorded successfully!', 'success');
                    closeLeaveModal();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (err) {
                showNotification('Network error occurred', 'error');
                console.error(err);
            }
        });



        // --- Add Allocation Modal (with day-wise effort) ---


        modalProject.addEventListener('change', function () {
            const projectId = parseInt(this.value);
            const project = projectsData.find(p => p.id === projectId);
            modalSubproject.disabled = !project;
            modalSubproject.innerHTML = '<option value="">Select Subproject...</option>';
            if (project && project.subprojects) {
                project.subprojects.forEach(sub => {
                    modalSubproject.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
            }
        });

        btnModalClose.addEventListener('click', closeModal);
        btnModalCancel.addEventListener('click', closeModal);

        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                closeModal();
            }
        });

        function closeModal() {
            modal.classList.remove('active');
        }

        function buildDaysList(week) {
            // week.start and week.end are "YYYY-MM-DD"
            const days = [];
            const start = new Date(week.start);
            const end = new Date(week.end);
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                days.push({
                    weekday: d.toLocaleDateString('en-US', {weekday: 'long'}),
                    date: d.toISOString().slice(0, 10)
                });
            }
            return days;
        }

// --- Modal Week Selector and Day Table ---
        function setupModalWeekSelector() {
            console.log("Setting up modal week selector");
            // Defensive: remove any previous event listeners by replacing the element
            const oldSelector = document.getElementById('modalWeekSelector');
            if (!oldSelector) return;
            const newSelector = oldSelector.cloneNode(true);
            oldSelector.parentNode.replaceChild(newSelector, oldSelector);

            // Populate week selector
            const allWeeksList = JSON.parse(document.getElementById('hiddenWeeksData').value);
            newSelector.innerHTML = '<option value="">Select Week...</option>';
            allWeeksList.forEach(w => {
                newSelector.innerHTML += `<option value="${w.num}">Week ${w.num}: ${w.start} - ${w.end}</option>`;
            });

            // Clear day table
            const dayTable = document.getElementById('modalDayTable');
            if (dayTable) {
                dayTable.querySelector('tbody').innerHTML = '';
            }

            // Attach event listener for week change
            newSelector.addEventListener('change', function () {
                console.log("Week selected:", this.value);
                const weekNum = this.value;
                const week = allWeeksList.find(w => String(w.num) === String(weekNum));
                const tbody = document.getElementById('modalDayTable').querySelector('tbody');
                tbody.innerHTML = '';
                console.log("Populating days for week:", week, weekNum);
                console.log("days_list for week:", week.days_list);
                if (week && (!week.days_list || week.days_list.length === 0)) {
                    week.days_list = buildDaysList(week);
                }
                if (week && week.days_list && week.days_list.length > 0) {
                    week.days_list.forEach(day => {
                        tbody.innerHTML += `
                    <tr>
                        <td>${day.weekday}</td>
                        <td>${day.date}</td>
                        <td>
                            <input type="number"
                                class="modal-day-effort"
                                data-date="${day.date}"
                                min="0"
                                max="24"
                                step="0.01"
                                value="0"
                                placeholder="0.00"
                                style="width: 80px; text-align: right;">
                        </td>
                    </tr>
                `;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#a0aec0;">No days found for this week</td></tr>`;
                }
            });
        }

// --- Save Allocation (day-wise) ---
        btnModalSave.addEventListener('click', async function () {
            const projectId = parseInt(modalProject.value);
            const subprojectId = parseInt(modalSubproject.value);
            const weekNum = parseInt(document.getElementById('modalWeekSelector').value);
            const monthStart = document.getElementById('hiddenMonthStart').value; // Get month_start

            if (!projectId || !subprojectId || !weekNum || !monthStart) {
                showNotification('Please select project, subproject, week, and ensure billing period is set', 'warning');
                return;
            }

            const days = [];
            document.querySelectorAll('.modal-day-effort').forEach(input => {
                const hours = parseFloat(input.value) || 0;
                if (hours > 0) {
                    days.push({
                        punch_date: input.dataset.date,
                        punched_hours: hours
                    });
                }
            });
            if (days.length === 0) {
                showNotification('Please enter effort for at least one day', 'warning');
                return;
            }

            // Calculate total hours and percent (if needed for weekly_allocations)
            const totalHours = days.reduce((sum, d) => sum + d.punched_hours, 0);
            // You may want to calculate percent based on your business logic
            const percent = 0; // Set as needed

            // Build the allocation object as per backend requirements
            const payload = {
                project_id: projectId,
                subproject_id: subprojectId,
                month_start: monthStart,
                allocations: [{
                    week_number: weekNum,
                    hours: totalHours,
                    percent: percent,
                    days: days
                }]
            };

            try {
                const response = await fetch("{% url 'projects:add_self_allocation' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.ok) {
                    showNotification('Allocation added successfully!', 'success');
                    closeModal();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (err) {
                showNotification('Network error occurred', 'error');
                console.error(err);
            }
        });

// --- Utility Functions ---
        function groupEfforts(rawEfforts) {
            const grouped = {};
            rawEfforts.forEach(e => {
                const key = `${e.team_distribution_id}_${e.week_number}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        team_distribution_id: e.team_distribution_id,
                        week_number: e.week_number,
                        project_id: e.project_id,
                        subproject_id: e.subproject_id,
                        month_start: e.month_start,
                        days: []
                    };
                }
                grouped[key].days.push({
                    punch_date: e.date,
                    punched_hours: e.punched_hours,
                    allocated_hours: e.allocated_hours,
                    percent_effort: e.percent_effort
                });
            });
            return Object.values(grouped);
        }

        function collectEffortData() {
          const efforts = [];
          const isEuUser = {{ is_eu_user|yesno:"true,false" }};
          document.querySelectorAll('.punch-input:not([disabled])').forEach(input => {
            let punchedHours = parseFloat(input.value) || 0;
            const tlAllocation = parseFloat(input.dataset.tlAllocation || 0);
            if (isEuUser) {
              punchedHours = tlAllocation * (punchedHours / 100);
            }
            const date = input.dataset.date;
            const weekNum = parseInt(input.dataset.week);
            const tdid = parseInt(input.dataset.tdid);
            const projectId = parseInt(input.dataset.projectId);
            const subprojectId = parseInt(input.dataset.subprojectId);
            const monthStart = input.dataset.monthStart;
            efforts.push({
              team_distribution_id: tdid,
              week_number: weekNum,
              date: date,
              punched_hours: punchedHours,
              project_id: projectId,
              subproject_id: subprojectId,
              month_start: monthStart,
              punched_percent: isEuUser ? parseFloat(input.value) : null
            });
          });
          return efforts;
        }



// --- Month/Year Change ---
        function changeMonthYear() {
            const yearSel = document.getElementById("yearSelect");
            const monthSel = document.getElementById("monthSelect");
            if (!yearSel || !monthSel) return;
            const year = yearSel.value;
            const month = monthSel.value;
            const paddedMonth = month.padStart(2, '0');
            if (!year || !month) {
                showNotification('Please select both year and month', 'warning');
                return;
            }
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            const targetUrl = `/projects/my-allocations/?year=${encodeURIComponent(year)}&month=${encodeURIComponent(paddedMonth)}`;
            window.location.href = targetUrl;
        }

        window.changeMonthYear = changeMonthYear;

        // JavaScript
        document.querySelectorAll('.week-row').forEach(function(row) {
          function updateActualEffort() {
            let sum = 0;
            const isEuUser = {{ is_eu_user|yesno:"true,false" }};
            const tlAllocationCell = row.querySelector('.tl-allocation');
            let tlAllocation = 0;
            if (tlAllocationCell) {
              // Remove "h" and whitespace, then parse
              tlAllocation = parseFloat(tlAllocationCell.textContent.replace(/[^\d.]/g, ''));
            }
            row.querySelectorAll('.daily-effort-input').forEach(inp => {
              let val = parseFloat(inp.value || 0);
              if (isEuUser) {
                val = (val * 8.75) / 100;
              }
              sum += val;
            });
            const percent = tlAllocation > 0 ? (sum / tlAllocation) * 100 : 0;
            const cell = row.querySelector('.actual-weekly-effort');
            if (cell) cell.textContent = `${sum.toFixed(2)}h (${percent.toFixed(2)}%)`;
          }
          row.querySelectorAll('.daily-effort-input').forEach(inp => {
            inp.addEventListener('input', updateActualEffort);
            inp.addEventListener('blur', updateActualEffort);
          });
          updateActualEffort();
        });
    });

    // javascript
    document.addEventListener('DOMContentLoaded', function () {
      // Prefer hidden input token; fallback to csrftoken cookie
      const csrfInput = document.querySelector('input[name=csrfmiddlewaretoken]');
      const csrfToken = csrfInput ? csrfInput.value : (function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
      })('csrftoken');

      // Select-all per week
      document.querySelectorAll('.week-select-all').forEach(chk => {
        chk.addEventListener('change', function () {
          const wk = this.dataset.week;
          document.querySelectorAll(`.week-row-select[data-week="${wk}"]`).forEach(r => {
            r.checked = chk.checked;
          });
        });
      });

      document.querySelectorAll('.week-row').forEach(function(row) {
        function updateActualEffort() {
          let sum = 0;
          const isEuUser = {{ is_eu_user|yesno:"true,false" }};
          const tlAllocationCell = row.querySelector('.tl-allocation');
          console.log("TL Allocation Cell:", tlAllocationCell);
          let tlAllocation = 0;
          if (tlAllocationCell) {
            // Remove "h" and whitespace, then parse
            tlAllocation = parseFloat(tlAllocationCell.textContent.replace(/[^\d.]/g, ''));
          }
          console.log("Calculating actual effort for row:", row, "TL Allocation:", tlAllocation);
          row.querySelectorAll('.daily-effort-input').forEach(inp => {
            let val = parseFloat(inp.value || 0);
            if (isEuUser) {
              val = (val * 8.75) / 100;
            }
            sum += val;
          });
          const percent = tlAllocation > 0 ? (sum / tlAllocation) * 100 : 0;
          console.log("Total sum:", sum, "Percent:", percent);
          const cell = row.querySelector('.actual-weekly-effort');
         if (cell) {
            cell.textContent = isEuUser
              ? `${sum.toFixed(2)}h (${percent.toFixed(2)}%)`
              : `${sum.toFixed(2)}h`;
          }
        }
        row.querySelectorAll('.daily-effort-input').forEach(inp => {
          inp.addEventListener('input', updateActualEffort);
          inp.addEventListener('blur', updateActualEffort);
        });
        updateActualEffort();
      });

      async function postWeekStatus(weekNum, status) {
        const isEuUser = {{ is_eu_user|yesno:"true,false" }};
        const selectedRows = Array.from(
          document.querySelectorAll(`.week-row-select[data-week="${weekNum}"]:checked`)
        ).map(chk => {
          const tdid = parseInt(chk.dataset.tdid);
          const tr = chk.closest('tr.week-row');
          const tlAllocationCell = tr.querySelector('.tl-allocation');
          let tlAllocation = 0;
          if (tlAllocationCell) {
            tlAllocation = parseFloat(tlAllocationCell.textContent.replace(/[^\d.]/g, '')) || 0;
            console.log("Missing or zero TL Allocation for row", tr);
          }
          const punch_data = [];
          tr.querySelectorAll('.daily-effort-input').forEach(inp => {
            let value = parseFloat(inp.value || 0);
            const date = inp.dataset.date;
            if (isEuUser) {
              // Convert percent to hours for EU case (each day max is 8.75h)
              value = (value * 8.75) / 100;
              console.log("Converted EU percent to hours:", value, "for date:", date);
            }
            if (value > 0 && date) {
              punch_data.push({
                punched_hours: value,
                punch_date: date
              });
            }
          });
          const totalEffort = punch_data.reduce((sum, d) => sum + d.punched_hours, 0);
          console.log("Row TDID:", tdid, "Total Effort:", totalEffort, "Punch Data:", punch_data);
          return {
            team_distribution_id: tdid,
            project_id: parseInt(tr.dataset.projectId),
            subproject_id: parseInt(tr.dataset.subprojectId),
            punch_data: punch_data,
            totalEffort: totalEffort
          };
        }).filter(row => row.totalEffort > 0 && row.punch_data.length > 0)
          .map(({totalEffort, ...rest}) => rest);

        if (selectedRows.length === 0) {
          showNotification('Select at least one row with non-zero effort in the week', 'warning');
          return;
        }

        const firstPunchDate = selectedRows[0].punch_data[0]?.punch_date;
        let year, month, month_start;
        if (firstPunchDate) {
          const dt = new Date(firstPunchDate);
          year = dt.getFullYear();
          month = dt.getMonth() + 1;
          month_start = `${year}-${String(month).padStart(2, '0')}-01`;
        } else {
          const yearSel = document.getElementById('yearSelect');
          const monthSel = document.getElementById('monthSelect');
          year = parseInt(yearSel?.value);
          month = parseInt(monthSel?.value);
          month_start = document.getElementById('hiddenMonthStart')?.value || '';
        }

        const payload = {
          status: status,
          year: year,
          month: month,
          week_num: parseInt(weekNum),
          month_start: month_start,
          rows: selectedRows
        };

        const btnDisable = status === 'DRAFT'
          ? document.querySelector(`.btn.btn-save-draft[data-week="${weekNum}"]`)
          : document.querySelector(`.btn.btn-submit-effort[data-week="${weekNum}"]`);
        if (btnDisable) {
          btnDisable.disabled = true;
          btnDisable.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        }

        try {
          const res = await fetch('{% url "projects:bulk_update_week_status" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken || ''
            },
            body: JSON.stringify(payload)
          });

          let data;
          if (res.ok) {
            data = await res.json();
          } else {
            try {
              data = await res.json();
              showNotification(data.error || 'Submission failed', 'error');
            } catch (e) {
              showNotification(res.statusText || 'Submission failed', 'error');
            }
            return;
          }

          if (!data.ok) {
            showNotification(data.error || 'Submission failed', 'error');
            if (Array.isArray(data.zero_rows)) {
              data.zero_rows.forEach(row => {
                const selector = `.week-row[data-tdid="${row.team_distribution_id}"][data-projectid="${row.project_id}"][data-subprojectid="${row.subproject_id}"]`;
                document.querySelectorAll(selector).forEach(el => {
                  el.style.border = '2px solid #a93226';
                });
              });
            }
            return;
          }
          showNotification(`Updated ${data.count} allocations to ${data.updated_status}`, 'success');
        } catch (err) {
          showNotification(err.message || 'Failed to update status', 'error');
        } finally {
          if (btnDisable) {
            btnDisable.disabled = false;
            btnDisable.innerHTML = (status === 'DRAFT')
              ? '<i class="fas fa-save"></i> Save Draft'
              : '<i class="fas fa-paper-plane"></i> Submit';
          }
        }
      }

      // Footer buttons per week
      document.querySelectorAll('.btn.btn-save-draft[data-week]').forEach(btn => {
        btn.addEventListener('click', function () {
          const wk = this.dataset.week;
          postWeekStatus(wk, 'DRAFT');
        });
      });
      document.querySelectorAll('.btn.btn-submit-effort[data-week]').forEach(btn => {
        btn.addEventListener('click', function () {
          const wk = this.dataset.week;
          postWeekStatus(wk, 'SUBMITTED');
        });
      });
    });
    // --- CSS Animations for notifications ---
    const style = document.createElement('style');
    style.textContent = `
@keyframes slideInRight {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
`;
    document.head.appendChild(style);
</script>
{% endblock %}