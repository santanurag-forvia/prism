{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/team_allocations.css' %}">

<style>
/* Improved, compact styling for the allocation section */
.page-card { padding:20px; background:#fff; border-radius:10px; box-shadow:0 8px 20px rgba(12,40,80,0.06); }
.page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
.alloc-title { font-size:26px; margin:0; color:#0b2545; }

.card { background: #fff; border-radius:8px; margin-top:18px; box-shadow:none; border:1px solid #f0f4f8; }
.card-header { padding:12px 18px; border-bottom:1px solid #f3f6fb; font-weight:600; color:#0b2545; display:flex; justify-content:space-between; align-items:center; }
.card-header span { margin-left:6px; } /* small breathing space between the left edge and heading text */
.card-body { padding:16px 18px; overflow-x: auto; } /* allow horizontal scroll for wide table */

.summary-table, .alloc-table { width:100%; border-collapse:collapse; font-size:14px; }
.summary-table th, .summary-table td, .alloc-table th, .alloc-table td { padding:10px 8px; border-bottom:1px solid #f3f6fb; text-align:left; vertical-align:middle; }
.alloc-table thead th { background:#f7fbff; color:#0b2545; font-weight:700; }
.input { padding:6px 8px; border-radius:6px; border:1px solid #e5eef8; background:#ffffff; font-size:13px; min-width:60px; }
.input:focus { outline:none; border-color:#9ec1ff; box-shadow:0 0 0 3px rgba(11,92,255,0.06); }
.btn { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; border: none; }
.btn-primary { background:#0b5cff; color:#fff; box-shadow:0 6px 18px rgba(11,92,255,0.12); }
.btn-danger { background:#ef4444; color:#fff; }
.small-muted { color:#6b7280; font-size:13px; }

/* compact width constraints */
.compact-project { max-width:420px; }
.compact-subproject { max-width:260px; }
.sel-resource { min-width:220px; }

/* highlight rows that exceed monthly limit */
.alloc-row.limit-exceeded { background: linear-gradient(90deg, rgba(255,234,234,0.9), rgba(255,244,244,0.6)); border-left:4px solid #ef4444; }

/* vertical spacing between cards (visual breathing) */
.card + .card { margin-top: 20px; }

/* responsive */
@media (max-width: 980px) {
  .compact-project, .compact-subproject, .sel-resource { max-width:100%; display:block; }
}

/* small pill spacing (fix gaps around headings) */
.card-header .pill { width:8px; height:28px; display:inline-block; background:linear-gradient(180deg,#2b7cff,#1a4ed8); border-radius:6px; margin-right:10px; vertical-align:middle; }
</style>

<div class="page-card">
  <div class="page-header">
    <div>
      <h1 class="alloc-title">Team Lead Free Allocations — {{ billing_month }}</h1>
      <div class="small-muted">Month: <strong>{{ billing_month }}</strong></div>
    </div>

    <form id="monthForm" method="get" style="display:flex; gap:8px; align-items:center;">
      <label for="month" class="small-muted">Month</label>
      <input id="month" class="input" type="month" name="month" value="{{ billing_month|default:'' }}">
      <button class="btn btn-primary" type="submit">Load</button>
    </form>
  </div>

  <!-- Direct reportees summary -->
  <div class="card">
    <div class="card-header"><span><span class="pill"></span>Direct Reportees Summary</span></div>
    <div class="card-body">
      <table class="summary-table" id="summaryTable">
        <thead>
          <tr>
            <th>Reportee</th>
            <th style="width:180px;">Total Allocated Hours</th>
            <th style="width:120px;">FTE</th>
          </tr>
        </thead>
        <tbody id="summaryBody">
          {% if reportees %}
            {% for r in reportees %}
            <tr class="reportee-row" data-ldap="{{ r.ldap }}">
              <td>
                {# robust fallback: prefer cn -> name -> mail -> ldap #}
                {% if r.cn %}
                  {{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;
                {% elif r.name %}
                  {{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;
                {% else %}
                  &lt;{{ r.mail|default:r.ldap }}&gt;
                {% endif %}
              </td>
              <td class="r-hours">{{ r.total_hours|default:"0.00" }}</td>
              <td class="r-fte">{{ r.fte|default:"0.000" }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="3" class="small-muted">No reportees found.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Allocation section -->
  <div class="card">
    <div class="card-header">
      <span><span class="pill"></span>Allocate Bandwidth</span>
      <button id="btnAddRow" class="btn btn-primary">Add Resource</button>

    </div>

    <div class="card-body">
      <table class="alloc-table" id="allocTable">
        <thead>
          <tr>
            <th style="min-width:220px;">Resource</th>
            <th class="compact-project">Project</th>
            <th class="compact-subproject">Subproject</th>
            <th style="width:100px;">Hours</th>
            <th style="width:80px;">FTE</th>
            <th style="width:70px;">W1%</th>
            <th style="width:70px;">W2%</th>
            <th style="width:70px;">W3%</th>
            <th style="width:70px;">W4%</th>
            <th style="width:100px;">Action</th>
          </tr>
        </thead>
        <tbody id="allocBody">
          {# If server provides allocations, render rows now so Django-side values used #}
          {% for row in allocations %}
            <tr class="alloc-row" data-team-dist-id="{{ row.id }}" data-subproject-id="{{ row.subproject_id }}">
              <td>
                <select class="input sel-resource">
                  <option value="">-- select --</option>
                  {% for r in reportees %}
                    {% comment %} robust display: prefer cn -> name -> mail -> ldap {% endcomment %}
                    {% if r.cn %}
                      <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>{{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
                    {% elif r.name %}
                      <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>{{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
                    {% else %}
                      <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>&lt;{{ r.mail|default:r.ldap }}&gt;</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </td>

              <td class="compact-project">
                <select class="input sel-project">
                  <option value="">-- select --</option>
                  {% for p in projects %}
                    {# p.project_id, bg_code, project_id } from view #}
                    <option value="{{ p.project_id }}" data-bgcode="{{ p.bg_code|default:'' }}" {% if p.project_id == row.project_id %}selected{% endif %}>
                      {{ p.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <td class="compact-subproject">
                <select class="input sel-subproject">
                  <option value="">-- select --</option>
                </select>
              </td>

              <td><input type="number" min="0" step="0.25" class="input inp-hours" value="{{ row.hours|floatformat:2 }}"></td>
              <td class="auto-fte">--</td>
              <td><input class="input wpct-1" type="number" min="0" max="100" value="{{ row.week_perc.0|default:0 }}"></td>
              <td><input class="input wpct-2" type="number" min="0" max="100" value="{{ row.week_perc.1|default:0 }}"></td>
              <td><input class="input wpct-3" type="number" min="0" max="100" value="{{ row.week_perc.2|default:0 }}"></td>
              <td><input class="input wpct-4" type="number" min="0" max="100" value="{{ row.week_perc.3|default:0 }}"></td>
              <td class="action-cell"><button class="btn btn-danger btn-remove">Remove</button></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="text-align:right; margin-top:14px;">
          <button id="btnExportExcel" class="btn btn-primary" style="background:#0284c7;">Export to Excel</button>
        <button id="btnSaveAlloc" class="btn btn-primary">Save Allocations</button>
      </div>
    </div>
  </div>
</div>

<!-- template to clone for new rows -->
<template id="tpl-alloc-row">
  <tr class="alloc-row" data-team-dist-id="" data-subproject-id="">
    <td>
      <select class="input sel-resource">
        <option value="">-- select --</option>
        {% for r in reportees %}
          {% if r.cn %}
            <option value="{{ r.ldap }}">{{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% elif r.name %}
            <option value="{{ r.ldap }}">{{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% else %}
            <option value="{{ r.ldap }}">&lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% endif %}
        {% endfor %}
      </select>
    </td>
    <td class="compact-project">
      <select class="input sel-project">
        <option value="">-- select --</option>
        {% for p in projects %}
          <option value="{{ p.project_id }}" data-bgcode="{{ p.bg_code|default:'' }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </td>
    <td class="compact-subproject">
      <select class="input sel-subproject"><option value="">-- select --</option></select>
    </td>
    <td><input type="number" min="0" step="0.25" class="input inp-hours" value="0"></td>
    <td class="auto-fte">--</td>
    <td><input class="input wpct-1" type="number" min="0" max="100" value="0"></td>
    <td><input class="input wpct-2" type="number" min="0" max="100" value="0"></td>
    <td><input class="input wpct-3" type="number" min="0" max="100" value="0"></td>
    <td><input class="input wpct-4" type="number" min="0" max="100" value="0"></td>
    <td class="action-cell"><button class="btn btn-danger btn-remove">Remove</button></td>
  </tr>
</template>

<script>
(function(){
  // Config / server-provided values
  const MONTHLY_LIMIT = {{ monthly_hours|default:183.75 }};           // per-billing-cycle maximum hours (one scalar)
  const SUBPROJECTS = JSON.parse('{{ subprojects_json|escapejs }}' || '[]');
  const CSRF = (document.cookie.split('; ').find(x=>x.trim().startsWith('csrftoken='))||'').split('=')[1] || '';

  // Helper: populate subproject select for a row given a project id and optional selected subproject id
  function fillSubprojectOptions(selSub, projectId, selectedId){
    selSub.innerHTML = '<option value="">-- select --</option>';
    if(!projectId){
      // fallback attempt: if selectedId present, try to find and show it even without project
      if(selectedId){
        try{
          const s = SUBPROJECTS.find(x => String(x.id) === String(selectedId));
          if(s){
            const opt = document.createElement('option');
            opt.value = s.id || '';
            opt.textContent = s.name || '';
            opt.selected = true;
            selSub.appendChild(opt);
          }
        } catch(e){}
      }
      return;
    }

    // primary matching logic: try project -> bg_code -> mdm match
    try {
      // if projectId corresponds directly to subproject.project_id, show matches
      SUBPROJECTS.forEach(s => {
        const pid = (s.project_id === null || s.project_id === undefined) ? '' : String(s.project_id);
        if(pid === String(projectId)){
          const opt = document.createElement('option');
          opt.value = s.id || '';
          opt.textContent = s.name || '';
          if(selectedId && String(selectedId) === String(s.id)) opt.selected = true;
          selSub.appendChild(opt);
        }
      });

      // if none found above, attempt bg/mdm matching using project's data-bgcode attribute
      if(selSub.options.length === 1){ // only the default option present
        // find a project option element to get bgcode
        const projOpt = Array.from(document.querySelectorAll('.sel-project option')).find(o => String(o.value) === String(projectId));
        const bg = projOpt ? (projOpt.dataset.bgcode || projOpt.getAttribute('data-bgcode')) : null;
        if(bg){
          SUBPROJECTS.forEach(s => {
            const code = (s.mdm_code || s.bg_code || '').toString();
            if(code && String(code).toLowerCase() === String(bg).toLowerCase()){
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.name || s.description || ('subproject ' + s.id);
              if(selectedId && String(selectedId) === String(s.id)) opt.selected = true;
              selSub.appendChild(opt);
            }
          });
        }
      }
    } catch(e){
      // swallow errors — fallback to empty subproject list
      // console.debug('fillSubprojectOptions error', e);
    }
  }

  // Update FTE cell for the given row
  function updateFTE(tr){
    const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
    const fte = MONTHLY_LIMIT ? (hrs / MONTHLY_LIMIT) : 0;
    const td = tr.querySelector('.auto-fte');
    if(td) td.textContent = (hrs > 0 && isFinite(fte)) ? fte.toFixed(3) : '--';
  }

  // Create a new row (prefill optional)
  function createRow(prefill){
    const tpl = document.getElementById('tpl-alloc-row');
    const node = tpl.content.cloneNode(true);
    const tr = node.querySelector('tr');

    // wire project change -> populate subprojects
    const selProj = tr.querySelector('.sel-project');
    const selSub  = tr.querySelector('.sel-subproject');
    const inpH   = tr.querySelector('.inp-hours');

    selProj.addEventListener('change', function(){
      fillSubprojectOptions(selSub, this.value, null);
    });

    inpH.addEventListener('input', function(){ updateFTE(tr); recomputeSummaryTotals(); });

    tr.querySelector('.btn-remove').addEventListener('click', function(ev){
      ev.preventDefault();
      const tid = tr.getAttribute('data-team-dist-id');
      if(tid){
        // call delete endpoint to remove server row + weekly allocations via cascade
        fetch("{% url 'projects:delete_team_distribution' %}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
          body: JSON.stringify({id: parseInt(tid, 10)})
        }).then(r => r.json()).then(j => {
          if(j && j.ok){ tr.remove(); recomputeSummaryTotals(); }
          else { alert('Delete failed: ' + (j && j.error ? j.error : 'unknown')); }
        }).catch(err => { console.error(err); alert('Delete request failed'); });
      } else {
        tr.remove(); recomputeSummaryTotals();
      }
    });

    // apply prefill values if provided
    if(prefill){
      if(prefill.reportee_ldap){
        const selR = tr.querySelector('.sel-resource');
        for(let i=0;i<selR.options.length;i++){
          if(String(selR.options[i].value).toLowerCase() === String(prefill.reportee_ldap).toLowerCase()){
            selR.selectedIndex = i; break;
          }
        }
      }
      if(prefill.project_id){
        selProj.value = prefill.project_id;
        fillSubprojectOptions(selSub, prefill.project_id, prefill.subproject_id || null);
      } else if(prefill.subproject_id){
        // if only subproject known, try to set it (fillSubprojectOptions has fallback)
        fillSubprojectOptions(selSub, '', prefill.subproject_id);
      }
      if(prefill.hours) tr.querySelector('.inp-hours').value = prefill.hours;
      if(Array.isArray(prefill.week_perc)){
        tr.querySelector('.wpct-1').value = prefill.week_perc[0]||0;
        tr.querySelector('.wpct-2').value = prefill.week_perc[1]||0;
        tr.querySelector('.wpct-3').value = prefill.week_perc[2]||0;
        tr.querySelector('.wpct-4').value = prefill.week_perc[3]||0;
      }
      if(prefill.id) tr.setAttribute('data-team-dist-id', prefill.id);
      updateFTE(tr);
    }

    document.getElementById('allocBody').appendChild(tr);
    return tr;
  }

  // recompute summary table totals from allocation rows
  function recomputeSummaryTotals(){
    const totals = {};
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
      if(!ldap) return;
      totals[ldap] = (totals[ldap] || 0) + hrs;
    });
    document.querySelectorAll('#summaryBody .reportee-row').forEach(rr => {
      const ldap = (rr.getAttribute('data-ldap')||'').toLowerCase();
      const hrs = totals[ldap] || 0;
      const hrsEl = rr.querySelector('.r-hours');
      const fteEl = rr.querySelector('.r-fte');
      if(hrsEl) hrsEl.textContent = hrs.toFixed(2);
      if(fteEl) fteEl.textContent = (MONTHLY_LIMIT ? (hrs / MONTHLY_LIMIT).toFixed(3) : '0.000');
    });
  }

  // Build initial rows from server-provided allocations
  function populateInitialRows(){
    // Guard: if server already rendered rows into #allocBody, do not duplicate.
    if(document.querySelectorAll('#allocBody .alloc-row').length > 0){
      // still ensure subproject selects are filled for those server-rendered rows
      document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
        const projectId = tr.querySelector('.sel-project')?.value;
        const subprojectSelected = tr.getAttribute('data-subproject-id') || tr.querySelector('.sel-subproject')?.value;
        if(projectId){
          fillSubprojectOptions(tr.querySelector('.sel-subproject'), projectId, subprojectSelected);
        } else if(subprojectSelected){
          // if project missing but subproject present, attempt to find project and select it
          try {
            const sp = SUBPROJECTS.find(s => String(s.id) === String(subprojectSelected));
            if(sp && sp.project_id){
              // try to set project select element to matching value
              const projSel = tr.querySelector('.sel-project');
              if(projSel){
                const opt = Array.from(projSel.options).find(o => String(o.value) === String(sp.project_id));
                if(opt) projSel.value = opt.value;
              }
              // now fill subprojects for the selected project
              fillSubprojectOptions(tr.querySelector('.sel-subproject'), tr.querySelector('.sel-project')?.value, subprojectSelected);
            } else {
              // fallback: ensure subproject select still shows the specific subproject if possible
              fillSubprojectOptions(tr.querySelector('.sel-subproject'), '', subprojectSelected);
            }
          } catch(e){}
        }
        updateFTE(tr);
      });
      recomputeSummaryTotals();
      return;
    }

    const initial = {{ allocations|default:"[]"|safe }};
    if(Array.isArray(initial) && initial.length){
      initial.forEach(r => {
        createRow({
          id: r.id || null,
          reportee_ldap: r.reportee_ldap || '',
          project_id: r.project_id || '',
          subproject_id: r.subproject_id || '',
          hours: r.hours || 0,
          week_perc: r.week_perc || [0,0,0,0]
        });
      });
    }
    recomputeSummaryTotals();
  }

  // collect rows into payload for save
  function gatherAllocations(){
    const rows = [];
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const tid = tr.getAttribute('data-team-dist-id') || null;
      const reportee = tr.querySelector('.sel-resource')?.value || '';
      const project_id = tr.querySelector('.sel-project')?.value || null;
      const subproject_id = tr.querySelector('.sel-subproject')?.value || null;
      const hours = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
      const weeks = [
        parseFloat(tr.querySelector('.wpct-1')?.value || 0) || 0,
        parseFloat(tr.querySelector('.wpct-2')?.value || 0) || 0,
        parseFloat(tr.querySelector('.wpct-3')?.value || 0) || 0,
        parseFloat(tr.querySelector('.wpct-4')?.value || 0) || 0,
      ];
      rows.push({
        id: tid,
        reportee: reportee,
        project_id: project_id,
        subproject_id: subproject_id,
        hours: hours,
        weeks: weeks
      });
    });
    return rows;
  }

  // Validate monthly limit across all allocations before save.
  // Highlights rows that cause exceedance and returns boolean valid/invalid.
  function validateMonthlyLimit(){
    const totals = {};
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
      if(!ldap) return;
      totals[ldap] = (totals[ldap] || 0) + hrs;
    });

    // Clear all previous highlight states
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => tr.classList.remove('limit-exceeded'));

    let valid = true;
    // For each row, if totals for that resource exceed MONTHLY_LIMIT, mark the row.
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      if(!ldap) return;
      const totalForUser = totals[ldap] || 0;
      if(MONTHLY_LIMIT && totalForUser > MONTHLY_LIMIT){
        tr.classList.add('limit-exceeded');
        valid = false;
      }
    });

    if(!valid){
      // Friendly message (non-blocking except save prevented by caller)
      alert('⚠️ One or more resources exceed the monthly hours limit (' + MONTHLY_LIMIT + ' hrs). Rows highlighted in red.');
    }
    return valid;
  }

  // -----------------------
  // Event wiring / handlers
  // -----------------------

  // Add Resource button
  document.getElementById('btnAddRow').addEventListener('click', function(e){
    e.preventDefault();
    const tr = createRow({});
    // focus on the resource select for quick input
    const sel = tr.querySelector('.sel-resource');
    if(sel) sel.focus();
  });

  // Delegated event handling for dynamic elements:
  // NOTE: for server-rendered rows (which were not created via createRow)
  // we need to call delete endpoint when a DB-backed row is removed.
  document.addEventListener('click', function(e){
    // remove button (any dynamically created or server-rendered .btn-remove)
    if(e.target && e.target.classList && e.target.classList.contains('btn-remove')){
      const row = e.target.closest('.alloc-row');
      if(!row) return;

      const tid = row.getAttribute('data-team-dist-id');
      if(tid){
        // Confirm then call server delete; on success remove row from DOM
        if(!confirm('This allocation exists in the database. Are you sure you want to delete it?')) return;
        fetch("{% url 'projects:delete_team_distribution' %}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
          body: JSON.stringify({id: parseInt(tid,10)})
        }).then(r => r.json()).then(j => {
          if(j && j.ok){
            row.remove();
            recomputeSummaryTotals();
          } else {
            alert('Delete failed: ' + (j && j.error ? j.error : 'unknown'));
          }
        }).catch(err => {
          console.error('Delete error', err);
          alert('Delete request failed — see console.');
        });
      } else {
        // just remove unsaved row
        row.remove();
        recomputeSummaryTotals();
      }
      return;
    }
  });

  // Delegated change handler for select/project/subproject/hours inputs
  document.addEventListener('change', function(e){
    const target = e.target;
    // project changed -> refill subproject options
    if(target && target.classList && target.classList.contains('sel-project')){
      const tr = target.closest('.alloc-row');
      if(tr){
        const selSub = tr.querySelector('.sel-subproject');
        fillSubprojectOptions(selSub, target.value, tr.getAttribute('data-subproject-id') || null);
      }
    }

    // hours changed or resource changed -> recompute totals & fte
    if(target && (target.classList.contains('inp-hours') || target.classList.contains('sel-resource'))){
      const tr = target.closest('.alloc-row');
      if(tr) updateFTE(tr);
      recomputeSummaryTotals();
    }

    // any week percent changes -> nothing special now but can be wired later
  });

  // Save handler: validate monthly limit first, then proceed to post
  document.getElementById('btnSaveAlloc').addEventListener('click', async function(e){
    e.preventDefault();

    recomputeSummaryTotals(); // ensure summary up-to-date
    if(!validateMonthlyLimit()) return; // stop if invalid

    const payload = {
      month: document.getElementById('month')?.value || '{{ billing_month }}',
      allocations: gatherAllocations()
    };

    try {
      const resp = await fetch(window.location.pathname.replace(/\/$/, '') + '/save/', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(data && data.ok){
        // reload to reflect server truth (idempotent upserts on server)
        location.reload();
      } else {
        alert('Save failed: ' + (data && data.error ? data.error : 'Unknown error'));
      }
    } catch(err){
      console.error('Save error', err);
      alert('Save failed (network or server error). See console for details.');
    }
  });

  // Initialise: populate rows (but guarded to avoid duplicates)
  document.addEventListener('DOMContentLoaded', function(){
    populateInitialRows();
    // Ensure subproject selects for any server-rendered rows are filled
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const projectId = tr.querySelector('.sel-project')?.value;
      const subprojectSelected = tr.getAttribute('data-subproject-id') || tr.querySelector('.sel-subproject')?.value;
      if(projectId){
        fillSubprojectOptions(tr.querySelector('.sel-subproject'), projectId, subprojectSelected);
      } else if(subprojectSelected){
        fillSubprojectOptions(tr.querySelector('.sel-subproject'), '', subprojectSelected);
      }
      updateFTE(tr);
    });
    recomputeSummaryTotals();
  });
document.getElementById("btnExportExcel").addEventListener("click", function(e){
  e.preventDefault();
  const month = document.getElementById("month")?.value || "{{ billing_month }}";
  window.location.href = "{% url 'projects:export_tl_allocations_excel' %}?month=" + encodeURIComponent(month);
});

})();
</script>

{% endblock %}
