
{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/team_allocations.css' %}">

<style>
/* Improved, compact styling for the allocation section */
.page-card { padding:20px; background:#fff; border-radius:10px; box-shadow:0 8px 20px rgba(12,40,80,0.06); }
.page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
.alloc-title { font-size:26px; margin:0; color:#0b2545; }

.card { background: #fff; border-radius:8px; margin-top:18px; box-shadow:none; border:1px solid #f0f4f8; }
.card-header { padding:12px 18px; border-bottom:1px solid #f3f6fb; font-weight:600; color:#0b2545; display:flex; justify-content:space-between; align-items:center; }
.card-header span { margin-left:6px; } /* small breathing space between the left edge and heading text */
.card-body { padding:16px 18px; overflow-x: auto; } /* allow horizontal scroll for wide table */

.summary-table, .alloc-table { width:100%; border-collapse:collapse; font-size:14px; }
.summary-table th, .summary-table td, .alloc-table th, .alloc-table td { padding:10px 8px; border-bottom:1px solid #f3f6fb; text-align:left; vertical-align:middle; }
.alloc-table thead th { background:#f7fbff; color:#0b2545; font-weight:700; }
.input { padding:6px 8px; border-radius:6px; border:1px solid #e5eef8; background:#ffffff; font-size:13px; min-width:60px; }
.input:focus { outline:none; border-color:#9ec1ff; box-shadow:0 0 0 3px rgba(11,92,255,0.06); }
.btn { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; border: none; }
.btn-primary { background:#0b5cff; color:#fff; box-shadow:0 6px 18px rgba(11,92,255,0.12); }
.btn-danger { background:#ef4444; color:#fff; }
.small-muted { color:#6b7280; font-size:13px; }

/* compact width constraints */
.compact-project { max-width:420px; }
.compact-subproject { max-width:260px; }
.sel-resource { min-width:220px; }

 /* weekly header - flatter + KPI pill */
th.week-header {
  text-align: center;
  vertical-align: middle;
  background: linear-gradient(180deg, #fbfdff 0%, #f6fbff 100%);
  border-right: 1px solid #eef3f8;
  padding: 8px 6px;
  min-width: 120px;
  white-space: nowrap;
}

.week-top {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:4px;
}

.week-label {
  font-weight:700;
  color:#0b2545;
  font-size:13px;
}

.max-pill {
  background: linear-gradient(90deg,#e6f7ed,#dff3e9);
  color:#065f46;
  font-weight:600;
  font-size:11px;
  padding:4px 6px;
  border-radius:999px;
  box-shadow: 0 1px 0 rgba(11,37,69,0.03);
}

.week-meta {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  font-size:12px;
  color:#64748b;
}

.week-dates { font-weight:600; color:#0b2545; font-size:12px; }
.week-wd { font-weight:600; color:#0b2545; }

.alloc-table thead tr { border-bottom: 2px solid #e6eef6; }
.alloc-table th, .alloc-table td { padding-top:8px; padding-bottom:8px; }

/* small adjustments for inputs */
.alloc-table input.wpct { width:72px; text-align:right; padding:6px 8px; }
/* ----- Week percentage input styling ----- */
/* --- % input visibility & shading --- */
.input.wpct {
  width: 84px;
  text-align: right;
  border: 1.6px solid #d1d5db;
  border-radius: 8px;
  padding: 6px 10px;
  background-color: #ffffff;
  font-weight: 600;
  color: #0f172a;
  transition: all 0.16s ease;
  box-shadow: 0 1px 2px rgba(2,6,23,0.04);
}

.input.wpct:hover {
  border-color: #60a5fa;
}

.input.wpct:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
}

/* filled vs zero shading */
.input.wpct.filled {
  background: linear-gradient(180deg, #f0fdf4 0%, #ecfdf3 100%);
  border-color: #34d399;
  color: #065f46;
}

.input.wpct.zero {
  background: #fbfdff;
  border-color: #e2e8f0;
  color: #6b7280;
}

/* keep spinner hidden for nicer look */
.input.wpct::-webkit-inner-spin-button,
.input.wpct::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

/* highlight rows that exceed monthly limit */
.alloc-row.limit-exceeded { background: linear-gradient(90deg, rgba(255,234,234,0.9), rgba(255,244,244,0.6)); border-left:4px solid #ef4444; }

/* vertical spacing between cards (visual breathing) */
.card + .card { margin-top: 20px; }

/* responsive */
@media (max-width: 980px) {
  .compact-project, .compact-subproject, .sel-resource { max-width:100%; display:block; }
}

/* small pill spacing (fix gaps around headings) */
.card-header .pill { width:8px; height:28px; display:inline-block; background:linear-gradient(180deg,#2b7cff,#1a4ed8); border-radius:6px; margin-right:10px; vertical-align:middle; }

/* -------- stronger vertical separators between weeks -------- */
.alloc-table th.week-header,
.alloc-table td.td-week {
  position: relative;
  /* subtle default right divider */
  border-right: 1px solid rgba(14, 35, 58, 0.06);
}

/* visually stronger divider line (full height) */
.alloc-table th.week-header::after,
.alloc-table td.td-week::after {
  content: "";
  position: absolute;
  right: 0;
  top: 6px;
  bottom: 6px;
  width: 2px;
  border-radius: 2px;
  /* subtle vertical gradient to add depth */
  background: linear-gradient(180deg, rgba(11,37,69,0.06), rgba(11,37,69,0.03));
  pointer-events: none;
  z-index: 2;
}

/* reduce visual clutter on the last week column */
.alloc-table th.week-header:last-child::after,
.alloc-table td.td-week:last-child::after {
  display: none;
}

/* -------- optional: explicit boundary highlight class -------- */
.week-boundary::after {
  /* strong accent color for the boundary */
  background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(239,68,68,0.95));
  width: 3px;
  box-shadow: 0 0 8px rgba(239,68,68,0.08);
}

/* subtle pill over the divider to label boundary if desired */
.week-boundary .boundary-pill {
  position: absolute;
  right: -26px; /* sits slightly right of the divider */
  top: 8px;
  background: #ffffff;
  border: 1px solid rgba(14,35,58,0.06);
  padding: 2px 6px;
  font-size: 11px;
  color: #dc2626;
  border-radius: 999px;
  box-shadow: 0 4px 10px rgba(2,6,23,0.06);
  z-index: 4;
  white-space: nowrap;
}

#two-tabs .tabs {
    display: flex; gap: 8px; border-bottom: 1px solid #e5e7eb; margin-bottom: 12px;
  }
  #two-tabs .tab-btn {
    appearance: none; background: none; border: none; padding: 10px 14px;
    cursor: pointer; border-bottom: 2px solid transparent; color: #475569; font-weight: 600;
  }
  #two-tabs .tab-btn.active { border-color: #0ea5e9; color: #0f172a; }
  #two-tabs .tab-panel[hidden] { display: none; }


  .feas-tabs-header {
  display: flex;
  gap: 8px;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 12px;
  background: #f7fbff;
  border-radius: 8px 8px 0 0;
      position: sticky;
      top:0;
      z-index: 20;
}
.feas-tab-btn {
  appearance: none;
  background: none;
  border: none;
  padding: 12px 18px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  color: #475569;
  font-weight: 600;
  font-size: 15px;
  transition: color 0.18s, border-color 0.18s;
  border-radius: 8px 8px 0 0;
}
.feas-tab-btn.active {
  border-color: #0ea5e9;
  color: #0b2545;
  background: lightskyblue;
  box-shadow: 0 2px 8px rgba(11,92,255,0.04);
}
.feas-tab-panel[hidden] {
  display: none;
}

#allocTable thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #f7fbff;
}

/* Sticky Resource column */
.alloc-table th:first-child,
.alloc-table td:first-child {
  position: sticky;
  left: 0;
  z-index: 15;
  background: #fff;
  box-shadow: 2px 0 8px rgba(11,92,255,0.04);
}

/* Scrollable table container */
.alloc-table-scroll-x {
  width: 100%;
  max-height: 480px;
  overflow-x: auto;
  overflow-y: auto;
  position: relative;
}

/* Sticky button bar at bottom */
.alloc-action-bar {
  position: sticky;
  bottom: 0;
  z-index: 30;
  background: #fff;
  padding: 14px 0 10px 0;
  text-align: right;
  box-shadow: 0 -2px 8px rgba(11,92,255,0.04);
}

.alloc-action-bar-right {
  position: sticky;
  right: 0;
  z-index: 40;
  background: #fff;
  padding: 14px 0 10px 0;
  text-align: right;
  box-shadow: -2px 0 8px rgba(11,92,255,0.04);
  min-width: 320px;
  display: flex;
  gap: 12px;
  align-items: center;
}
</style>

<div class="page-card">
  <div class="page-header">
    <div>
      <h1 class="alloc-title">Team Lead Free Allocations — {{ billing_month }}</h1>
      <div class="small-muted">Month: <strong>{{ billing_month }}</strong></div>
    </div>

    <form id="monthForm" method="get" style="display:flex; gap:8px; align-items:center;">
      <label for="month" class="small-muted">Month</label>
      <input id="month" class="input" type="month" name="month" value="{{ billing_month|default:'' }}">
      <button class="btn btn-primary" type="submit">Load</button>
    </form>
  </div>

  <!-- Direct reportees summary -->
  <div class="card">
    <div class="card-header"><span><span class="pill"></span>Reportees Allocation Summary</span>
    <a id="btnMyApproval" class="btn btn-primary" href="{% url 'projects:tl_punch_review' %}">My Approvals</a>
    </div>
   <div class="card-body">
       <!--Start of tab-->
       <div class="feas-tabs" style="margin: 16px auto;">
  <!-- Tab buttons -->
  <div class="feas-tabs-header" role="tablist" aria-label="Two tabs">
    <button class="feas-tab-btn active" role="tab" aria-selected="true" aria-controls="panel-one">Direct reportees summary</button>
    <button class="feas-tab-btn" role="tab" aria-selected="false" aria-controls="panel-two">Project View</button>
      <button class="feas-tab-btn" role="tab" aria-selected="false" aria-controls="panel-three">View Allotment</button>
  </div>

  <!-- Tab panels -->
  <div class="feas-tab-panels">
    <section id="panel-one" class="feas-tab-panel" role="tabpanel" tabindex="0">
      <!-- Content for Tab One -->
        <table class="summary-table" id="summaryTable">
        <thead>
          <tr>
            <th style="width:180px">Reportee</th>
            <th>Total Allocated Hours</th>
            <th>FTE</th>
              <th>%</th>
          </tr>
        </thead>
        <tbody id="summaryBody">
          {% if reportees %}
            {% for r in reportees %}
            <tr class="reportee-row" data-ldap="{{ r.ldap }}">
              <td style="width:500px">
                {# robust fallback: prefer cn -> name -> mail -> ldap #}
                {% if r.cn %}
                  {{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;
                {% elif r.name %}
                  {{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;
                {% else %}
                  &lt;{{ r.mail|default:r.ldap }}&gt;
                {% endif %}
              </td>
              <td class="r-hours" style="width:300px">{{ r.total_hours|default:"0.00" }}</td>
              <td class="r-fte">{{ r.fte|default:"0.0" }}
              </td><td class="r-ptge">{{ r.ptge|default:"0.0" }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="3" class="small-muted">No reportees found.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section id="panel-two" class="feas-tab-panel" role="tabpanel" tabindex="1" hidden>
      <!-- Content for Tab Two -->
        <table class="summary-table" id="summaryTable1">
        <thead>
          <tr>
            <th style="">Program</th>
              <th style="">Project</th>
            <th style="">Resource</th>
             <th style="">Hour</th>
              <th style="">FTE</th>
              <th style="">%</th>
          </tr>
        </thead>

<tbody id="summaryBodyprojectview">
  {% with prev_program=None %}
    {% for row in allocations %}
      {% for p in projects %}
        {% if p.project_id == row.project_id %}
          {% with program_name=p.bg_code|stringformat:"s - "|add:p.name %}
            {% ifchanged program_name %}
              <tr class="alloc-row" data-ldap="{{ row.reportee_ldap }}" data-team-dist-id="{{ row.id }}" data-subproject-id="{{ row.subproject_id }}">
                <td class="compact-project">{{ program_name }}</td>
                <td class="compact-subproject">
                  {% for sp in subprojects %}
                    {% if sp.id == row.subproject_id %}
                      {{ sp.name }}
                    {% endif %}
                  {% endfor %}
                </td>
                <td>
                  {% for r in reportees %}
                    {% if r.ldap|lower == row.reportee_ldap|lower %}
                      {% if r.cn %}
                        {{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;
                      {% elif r.name %}
                        {{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;
                      {% else %}
                        &lt;{{ r.mail|default:r.ldap }}&gt;
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </td>
                <td class="r-hours">{{ row.hours|floatformat:2 }}</td>
                <td class="r-fte">
                  {% for r in reportees %}
                    {% if r.ldap|lower == row.reportee_ldap|lower %}
                      {{ r.fte|default:"0.0" }}
                    {% endif %}
                  {% endfor %}
                </td>
                <td class="r-ptge">
                  {% for r in reportees %}
                    {% if r.ldap|lower == row.reportee_ldap|lower %}
                      {{ r.ptge|default:"0.0" }}
                    {% endif %}
                  {% endfor %}
                </td>
              </tr>
            {% else %}
              <tr class="alloc-row" data-ldap="{{ row.reportee_ldap }}" data-team-dist-id="{{ row.id }}" data-subproject-id="{{ row.subproject_id }}">
                <td class="compact-project"></td>
                <td class="compact-subproject">
                  {% for sp in subprojects %}
                    {% if sp.id == row.subproject_id %}
                      {{ sp.name }}
                    {% endif %}
                  {% endfor %}
                </td>
                <td>
                  {% for r in reportees %}
                    {% if r.ldap|lower == row.reportee_ldap|lower %}
                      {% if r.cn %}
                        {{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;
                      {% elif r.name %}
                        {{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;
                      {% else %}
                        &lt;{{ r.mail|default:r.ldap }}&gt;
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </td>
                <td class="r-hours">{{ row.hours|floatformat:2 }}</td>
                <td class="r-fte">
                  {% for r in reportees %}
                    {% if r.ldap|lower == row.reportee_ldap|lower %}
                      {{ r.fte|default:"0.0" }}
                    {% endif %}
                  {% endfor %}
                </td>
                <td class="r-ptge">
                  {% for r in reportees %}
                    {% if r.ldap|lower == row.reportee_ldap|lower %}
                      {{ r.ptge|default:"0.0" }}
                    {% endif %}
                  {% endfor %}
                </td>
              </tr>
            {% endifchanged %}
          {% endwith %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  {% endwith %}
</tbody>





<!--Original code-->
<!--<tbody id="summaryBodyprojectview">-->
<!--  {% for row in allocations %}-->
<!--    <tr class="alloc-row" data-ldap="{{ row.reportee_ldap }}" data-team-dist-id="{{ row.id }}" data-subproject-id="{{ row.subproject_id }}">-->
<!--      <td class="compact-project">-->
<!--        {% for p in projects %}-->
<!--          {% if p.project_id == row.project_id %}-->
<!--            {{ p.bg_code }} - {{ p.name }}-->
<!--          {% endif %}-->
<!--        {% endfor %}-->
<!--      </td>-->
<!--      <td class="compact-subproject">-->
<!--        {% for sp in subprojects %}-->
<!--          {% if sp.id == row.subproject_id %}-->
<!--            {{ sp.name }}-->
<!--          {% endif %}-->
<!--        {% endfor %}-->
<!--      </td>-->
<!--      <td>-->
<!--        {% for r in reportees %}-->
<!--          {% if r.ldap|lower == row.reportee_ldap|lower %}-->
<!--            {% if r.cn %}-->
<!--              {{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;-->
<!--            {% elif r.name %}-->
<!--              {{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;-->
<!--            {% else %}-->
<!--              &lt;{{ r.mail|default:r.ldap }}&gt;-->
<!--            {% endif %}-->
<!--          {% endif %}-->
<!--        {% endfor %}-->
<!--      </td>-->
<!--      <td class="r-hours">{{ row.hours|floatformat:2 }}</td>-->
<!--      <td class="r-fte">-->
<!--        {% for r in reportees %}-->
<!--          {% if r.ldap|lower == row.reportee_ldap|lower %}-->
<!--            {{ r.fte|default:"0.0" }}-->
<!--          {% endif %}-->
<!--        {% endfor %}-->
<!--      </td>-->
<!--      <td class="r-ptge">-->
<!--        {% for r in reportees %}-->
<!--          {% if r.ldap|lower == row.reportee_ldap|lower %}-->
<!--            {{ r.ptge|default:"0.0" }}-->
<!--          {% endif %}-->
<!--        {% endfor %}-->
<!--      </td>-->
<!--    </tr>-->
<!--  {% endfor %}-->
<!--</tbody>-->
            <!-- End of original code -->

      </table>
    </section>
      <section id="panel-three" class="feas-tab-panel" role="tabpanel" tabindex="2" hidden>
      <!-- Content for Tab Two -->
        <table class="summary-table" id="summaryTable2">
        <thead>
          <tr>
            <th style="width:120px;">Program</th>
               <th style="width:120px;">Project</th>
               <th style="width:120px;">Resource</th>
               <th style="width:120px;">Allocation (in Hrs)</th>
               <th style="width:120px;">FTE</th>
               <th style="width:120px;">WBS</th>
          </tr>
        </thead>
       <tbody id="summaryBodyallottmentview">
  <!-- Data will be loaded by JS -->
</tbody>
      </table>
    </section>
  </div>
</div>
       <!--End of Start tab-->
    </div>
  </div>
    <!--End of Direct reportees-->

  <!-- Allocation section -->
  <div class="card">
    <div class="card-header">
      <span><span class="pill"></span>Allocate Bandwidth</span>
<!--      <button id="btnAddRow" class="btn btn-primary">Add Resource</button>-->
    </div>
    <div class="card-body">
        <div class="feas-tabs" style="">
  <!-- Tab buttons -->
  <div class="feas-tabs-header" role="tablist" aria-label="Two tabs">
    <button class="feas-tab-btn active" role="tab" aria-selected="true" aria-controls="panel-one-allocation">Allocation by Team Member</button>
    <button class="feas-tab-btn" role="tab" aria-selected="false" aria-controls="panel-two-allocation">Allocation by Project</button>
  </div>

  <!-- Tab panels -->
  <div class="alloc-table-scroll-x">
      <!-- Start of allocation by team member-->
    <section id="panel-one-allocation" class="feas-tab-panel" role="tabpanel" tabindex="0">
      <!-- Content for Tab One -->
        <table class="alloc-table" id="allocTable">
        <!-- week header row (dynamic) -->
            <thead>
              <tr>
                <th style="position: sticky; left: 0; z-index: 14;">Resource</th>
                <th class="compact-project">Program</th>
                <th class="compact-subproject">Project</th>
                <th>Hours</th>
                <th>FTE</th>

                {% for w in weeks_info %}
                  <th class="week-header">
                    <div class="week-top">
                      <span class="week-label">W{{ w.num }}</span>
                      <span class="max-pill">Max {{ w.max_pct }}%</span>
                    </div>

                    <div class="week-meta">
                      <span class="week-dates">
                        {{ w.start|slice:"0:10" }} → {{ w.end|slice:"0:10" }}
                      </span>
                      <span class="dot">•</span>
                      <span class="week-wd">{{ w.working_days }} WD</span>
                    </div>
                  </th>
                {% endfor %}
                <th class="action-cell">Action</th>
              </tr>
            </thead>

        <tbody id="allocBody">
          {# If server provides allocations, render rows now so Django-side values used #}
          {% for row in allocations %}
            <tr class="alloc-row" data-team-dist-id="{{ row.id }}" data-subproject-id="{{ row.subproject_id }}">
              <td>
                <select class="input sel-resource">
                  <option value="">-- select --</option>
                  {% for r in reportees %}
                    {% comment %} robust display: prefer cn -> name -> mail -> ldap {% endcomment %}
                    {% if r.cn %}
                      <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>{{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
                    {% elif r.name %}
                      <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>{{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
                    {% else %}
                      <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>&lt;{{ r.mail|default:r.ldap }}&gt;</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </td>

              <td class="compact-project">
                <select class="input sel-project">
                  <option value="">-- select --</option>
                  {% for p in projects %}
                    {# p.project_id, bg_code, project_id } from view #}
                    <option value="{{ p.project_id }}" data-bgcode="{{ p.bg_code|default:'' }}" {% if p.project_id == row.project_id %}selected{% endif %}>
                      {{ p.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <td class="compact-subproject">
                <select class="input sel-subproject">
                  <option value="">-- select --</option>
                </select>
              </td>

              <td><input type="number" min="0" step="0.25" class="input inp-hours" value="{{ row.hours|floatformat:2 }}"></td>
              <td class="auto-fte">--</td>
              {% for w in weeks_info %}
              <td>
                <input class="input wpct" type="number" min="0" max="100"
                       data-week="{{ w.num }}" data-max="{{ w.max_pct }}"
                       value="{{ row.week_perc|default_if_none:''|slice:forloop.counter0|default:'0' }}">
              </td>
            {% endfor %}

              <td class="action-cell">
                  <button class="btn btn-danger btn-remove">Remove</button>
              </td>
                <td>
                  <button id="btnAddProjectForResource" class="btn btn-primary btn-add-row" title="Add row for same resource">+</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
         <div style="text-align:right; margin-top:14px;">
             <button id="btnAddRow" class="btn btn-primary">Add Resource</button>
<!-- Place this next to Add Resource button in Allocation by Team Member tab -->


          <button id="btnExportExcel" class="btn btn-primary" >Export to Excel</button>
        <button id="btnSaveAlloc" class="btn btn-primary">Save Allocations</button>
      </div>
    </section>
      <!-- End of allocation by team member-->
      <!--start of allocation by project-->
      <section id="panel-two-allocation" class="feas-tab-panel" role="tabpanel" tabindex="1" hidden>
      <!-- Content for Tab Two -->
        <table class="alloc-table" id="allocTableByProject">
        <thead>
    <tr>

      <th class="compact-project" style="position: sticky; left: 0; z-index: 14;">Program</th>
      <th class="compact-subproject">Project</th>
        <th >Resource</th>
      <th>Hours</th>
      <th>FTE</th>
      {% for w in weeks_info %}
        <th class="week-header">
          <div class="week-top">
            <span class="week-label">W{{ w.num }}</span>
            <span class="max-pill">Max {{ w.max_pct }}%</span>
          </div>
          <div class="week-meta">
            <span class="week-dates">
              {{ w.start|slice:"0:10" }} → {{ w.end|slice:"0:10" }}
            </span>
            <span class="dot">•</span>
            <span class="week-wd">{{ w.working_days }} WD</span>
          </div>
        </th>
      {% endfor %}
      <th class="action-cell">Action</th>
    </tr>
  </thead>
<tbody id="allocBodyByProject">
  {% for row in allocations %}
    <tr class="alloc-row" data-team-dist-id="{{ row.id }}" data-subproject-id="{{ row.subproject_id }}">
      <td class="compact-project">
        <select class="input sel-project">
          <option value="">-- select --</option>
          {% for p in projects %}
            <option value="{{ p.project_id }}" data-bgcode="{{ p.bg_code|default:'' }}" {% if p.project_id == row.project_id %}selected{% endif %}>
              {{ p.name }}
            </option>
          {% endfor %}
        </select>
      </td>
      <td class="compact-subproject">
        <select class="input sel-subproject">
          <option value="">-- select --</option>
        </select>
      </td>
      <td>
        <select class="input sel-resource1">
          <option value="">-- select --</option>
          {% for r in reportees %}
            {% if r.cn %}
              <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>{{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
            {% elif r.name %}
              <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>{{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
            {% else %}
              <option value="{{ r.ldap }}" {% if r.ldap|lower == row.reportee_ldap|lower %}selected{% endif %}>&lt;{{ r.mail|default:r.ldap }}&gt;</option>
            {% endif %}
          {% endfor %}
        </select>
      </td>
      <td><input type="number" min="0" step="0.25" class="input inp-hours" value="{{ row.hours|floatformat:2 }}"></td>
      <td class="auto-fte">--</td>
      {% for w in weeks_info %}
        <td>
          <input class="input wpct" type="number" min="0" max="100"
                 data-week="{{ w.num }}" data-max="{{ w.max_pct }}"
                 value="{{ row.week_perc|default_if_none:''|slice:forloop.counter0|default:'0' }}">
        </td>
      {% endfor %}
      <td class="action-cell">
          <button class="btn btn-danger btn-remove">Remove</button></td>
        <td>
<!--            <button  id="btnAddResourceForProject" class="btn btn-primary btn-add-row" title="Add row for same resource">+</button>-->
        <button class="btn btn-primary btn-add-row btn-add-resource-for-project" title="Add row for same resource">+</button>
        </td>

    </tr>
  {% endfor %}
</tbody>
</table>
             <div class="alloc-action-bar" style="text-align:right; margin-top:14px;">
                   <button id="btnAddRow-project" class="btn btn-primary">Add Resource</button>
          <button id="btnExportExcel-project" class="btn btn-primary" style="background:#0284c7;">Export to Excel</button>
        <button id="btnSaveAlloc-project" class="btn btn-primary">Save Allocations</button>
      </div>
    </section>
<!-- End of allocation by project-->
  </div>



  </div>
    <!--ENd of Allocation section-->
</div>
  </div>
<!-- template to clone for new rows -->
<template id="tpl-alloc-row">
  <tr class="alloc-row" data-team-dist-id="" data-subproject-id="">
    <td>
      <select class="input sel-resource">
        <option value="">-- select --</option>
        {% for r in reportees %}
          {% if r.cn %}
            <option value="{{ r.ldap }}">{{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% elif r.name %}
            <option value="{{ r.ldap }}">{{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% else %}
            <option value="{{ r.ldap }}">&lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% endif %}
        {% endfor %}
      </select>
    </td>
    <td class="compact-project">
      <select class="input sel-project">
        <option value="">-- select --</option>
        {% for p in projects %}
          <option value="{{ p.project_id }}" data-bgcode="{{ p.bg_code|default:'' }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </td>
    <td class="compact-subproject">
      <select class="input sel-subproject"><option value="">-- select --</option></select>
    </td>
    <td><input type="number" min="0" step="0.25" class="input inp-hours" value="0"></td>
    <td class="auto-fte">--</td>
    {# --- per-row, render week inputs from row.weeks_list if available --- #}
    {% if row.weeks_list %}
     {% for w in weeks_info %}
          <td class="td-week text-center">
            <input class="input wpct"
                   type="number"
                   step="0.01"
                   min="0"
                   max="100"
                   data-week="{{ w.num }}"
                   data-max="{{ w.max_pct }}"
                   value="">
          </td>
        {% endfor %}


    {% else %}
      {# fallback: no server-side weeks present for this row (e.g. newly added template row)
         leave empty; JS will populate week inputs for the row when it is inserted. #}
    {% endif %}

    <td class="action-cell"><button class="btn btn-danger btn-remove">Remove</button></td>
  </tr>
</template>

   <!--template to clone for new rows for allocation by Project tab-->
    <template id="tpl-alloc-row-by-project">
  <tr class="alloc-row" data-team-dist-id="" data-subproject-id="">
    <td class="compact-project">
      <select class="input sel-project">
        <option value="">-- select --</option>
        {% for p in projects %}
          <option value="{{ p.project_id }}" data-bgcode="{{ p.bg_code|default:'' }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </td>
    <td class="compact-subproject">
      <select class="input sel-subproject"><option value="">-- select --</option></select>
    </td>
    <td>
      <select class="input sel-resource1">
        <option value="">-- select --</option>
        {% for r in reportees %}
          {% if r.cn %}
            <option value="{{ r.ldap }}">{{ r.cn }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% elif r.name %}
            <option value="{{ r.ldap }}">{{ r.name }} &lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% else %}
            <option value="{{ r.ldap }}">&lt;{{ r.mail|default:r.ldap }}&gt;</option>
          {% endif %}
        {% endfor %}
      </select>
    </td>
    <td><input type="number" min="0" step="0.25" class="input inp-hours" value="0"></td>
    <td class="auto-fte">--</td>
    {% for w in weeks_info %}
      <td class="td-week text-center">
        <input class="input wpct"
               type="number"
               step="0.01"
               min="0"
               max="100"
               data-week="{{ w.num }}"
               data-max="{{ w.max_pct }}"
               value="">
      </td>
    {% endfor %}

    <td class="action-cell">

        <button class="btn btn-danger btn-remove">Remove</button>

    </td>
  </tr>
</template>

<script>

(function(){
  // Config / server-provided values
  const MONTHLY_LIMIT = {{ monthly_hours|default:183.75 }};           // per-billing-cycle maximum hours (one scalar)
  const SUBPROJECTS = JSON.parse('{{ subprojects_json|escapejs }}' || '[]');
  const CSRF = (document.cookie.split('; ').find(x=>x.trim().startsWith('csrftoken='))||'').split('=')[1] || '';
  const MAX_FTE_PM = {{175}};

  // Helper: populate subproject select for a row given a project id and optional selected subproject id

  function fillSubprojectOptions(selSub, projectId, selectedId){
    selSub.innerHTML = '<option value="">-- select --</option>';
    if(!projectId){
      // fallback attempt: if selectedId present, try to find and show it even without project
      if(selectedId){
        try{
          const s = SUBPROJECTS.find(x => String(x.id) === String(selectedId));
          if(s){
            const opt = document.createElement('option');
            opt.value = s.id || '';
            opt.textContent = s.name || '';
            opt.selected = true;
            selSub.appendChild(opt);
          }
        } catch(e){}
      }
      return;
    }

    // primary matching logic: try project -> bg_code -> mdm match
    try {
      // if projectId corresponds directly to subproject.project_id, show matches
      SUBPROJECTS.forEach(s => {
        const pid = (s.project_id === null || s.project_id === undefined) ? '' : String(s.project_id);
        if(pid === String(projectId)){
          const opt = document.createElement('option');
          opt.value = s.id || '';
          opt.textContent = s.name || '';
          if(selectedId && String(selectedId) === String(s.id)) opt.selected = true;
          selSub.appendChild(opt);
        }
      });

      // if none found above, attempt bg/mdm matching using project's data-bgcode attribute
      if(selSub.options.length === 1){ // only the default option present
        // find a project option element to get bgcode
        const projOpt = Array.from(document.querySelectorAll('.sel-project option')).find(o => String(o.value) === String(projectId));
        const bg = projOpt ? (projOpt.dataset.bgcode || projOpt.getAttribute('data-bgcode')) : null;
        if(bg){
          SUBPROJECTS.forEach(s => {
            const code = (s.mdm_code || s.bg_code || '').toString();
            if(code && String(code).toLowerCase() === String(bg).toLowerCase()){
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.name || s.description || ('subproject ' + s.id);
              if(selectedId && String(selectedId) === String(s.id)) opt.selected = true;
              selSub.appendChild(opt);
            }
          });
        }
      }
    } catch(e){
      // swallow errors — fallback to empty subproject list
      // console.debug('fillSubprojectOptions error', e);
    }
  }


  // Update FTE cell for the given row
  function updateFTE(tr){
    const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
    const fte = MONTHLY_LIMIT ? (hrs / MONTHLY_LIMIT) : 0;
    const td = tr.querySelector('.auto-fte');
    if(td) td.textContent = (hrs > 0 && isFinite(fte)) ? fte.toFixed(2) : '--';
  }

  // Create a new row (prefill optional)
  function createRow(prefill){
    const tpl = document.getElementById('tpl-alloc-row');
    const node = tpl.content.cloneNode(true);
    const tr = node.querySelector('tr');

    // wire project change -> populate subprojects
    const selProj = tr.querySelector('.sel-project');
    const selSub  = tr.querySelector('.sel-subproject');
    const inpH   = tr.querySelector('.inp-hours');
    // after inserting row into DOM:
if(window.tl_alloc_helpers && typeof window.tl_alloc_helpers.populateWeekInputsForRow === 'function'){
  tl_alloc_helpers.populateWeekInputsForRow(tr, {}); // {} -> no existing week values
}

    selProj.addEventListener('change', function(){
      fillSubprojectOptions(selSub, this.value, null);
    });

    inpH.addEventListener('input', function(){ updateFTE(tr); recomputeSummaryTotals(); });

    tr.querySelector('.btn-remove').addEventListener('click', function(ev){
      ev.preventDefault();
      const tid = tr.getAttribute('data-team-dist-id');
      if(tid){
        // call delete endpoint to remove server row + weekly allocations via cascade
        fetch("{% url 'projects:delete_team_distribution' %}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
          body: JSON.stringify({id: parseInt(tid, 10)})
        }).then(r => r.json()).then(j => {
          if(j && j.ok){ tr.remove(); recomputeSummaryTotals(); }
          else { alert('Delete failed: ' + (j && j.error ? j.error : 'unknown')); }
        }).catch(err => { console.error(err); alert('Delete request failed'); });
      } else {
        tr.remove(); recomputeSummaryTotals();
      }
    });

    // apply prefill values if provided
    if(prefill){
      if(prefill.reportee_ldap){
        const selR = tr.querySelector('.sel-resource');
        for(let i=0;i<selR.options.length;i++){
          if(String(selR.options[i].value).toLowerCase() === String(prefill.reportee_ldap).toLowerCase()){
            selR.selectedIndex = i; break;
          }
        }
      }
      if(prefill.project_id){
        selProj.value = prefill.project_id;
        fillSubprojectOptions(selSub, prefill.project_id, prefill.subproject_id || null);
      } else if(prefill.subproject_id){
        // if only subproject known, try to set it (fillSubprojectOptions has fallback)
        fillSubprojectOptions(selSub, '', prefill.subproject_id);
      }
      if(prefill.hours) tr.querySelector('.inp-hours').value = prefill.hours;
      if(Array.isArray(prefill.week_perc)){
        tr.querySelector('.wpct-1').value = prefill.week_perc[0]||0;
        tr.querySelector('.wpct-2').value = prefill.week_perc[1]||0;
        tr.querySelector('.wpct-3').value = prefill.week_perc[2]||0;
        tr.querySelector('.wpct-4').value = prefill.week_perc[3]||0;
      }
      if(prefill.id) tr.setAttribute('data-team-dist-id', prefill.id);
      updateFTE(tr);
    }

    document.getElementById('allocBody').appendChild(tr);
    return tr;
  }
window.createRow = createRow;
// end of a new row creation

 // Create a new row in allocation by project tab(prefill optional)
  function createRowByProject(prefill){
    const tpl = document.getElementById('tpl-alloc-row-by-project');
    const node = tpl.content.cloneNode(true);
    const tr = node.querySelector('tr');

    // wire project change -> populate subprojects
    const selProj = tr.querySelector('.sel-project');
    const selSub  = tr.querySelector('.sel-subproject');
    const inpH   = tr.querySelector('.inp-hours');
    // after inserting row into DOM:
if(window.tl_alloc_helpers && typeof window.tl_alloc_helpers.populateWeekInputsForRow === 'function'){
  tl_alloc_helpers.populateWeekInputsForRow(tr, {}); // {} -> no existing week values
}

    selProj.addEventListener('change', function(){
      fillSubprojectOptions(selSub, this.value, null);
    });

    inpH.addEventListener('input', function(){ updateFTE(tr); recomputeSummaryTotals(); });

    tr.querySelector('.btn-remove').addEventListener('click', function(ev){
      ev.preventDefault();
      const tid = tr.getAttribute('data-team-dist-id');
      if(tid){
        // call delete endpoint to remove server row + weekly allocations via cascade
        fetch("{% url 'projects:delete_team_distribution' %}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
          body: JSON.stringify({id: parseInt(tid, 10)})
        }).then(r => r.json()).then(j => {
          if(j && j.ok){ tr.remove(); recomputeSummaryTotals(); }
          else { alert('Delete failed: ' + (j && j.error ? j.error : 'unknown')); }
        }).catch(err => { console.error(err); alert('Delete request failed'); });
      } else {
        tr.remove(); recomputeSummaryTotals();
      }
    });

    // apply prefill values if provided
    // if(prefill){
    //   if(prefill.reportee_ldap){
    //     const selR = tr.querySelector('.sel-resource');
    //     for(let i=0;i<selR.options.length;i++){
    //       if(String(selR.options[i].value).toLowerCase() === String(prefill.reportee_ldap).toLowerCase()){
    //         selR.selectedIndex = i; break;
    //       }
    //     }
    //   }
    //   if(prefill.project_id){
    //     selProj.value = prefill.project_id;
    //     fillSubprojectOptions(selSub, prefill.project_id, prefill.subproject_id || null);
    //   } else if(prefill.subproject_id){
    //     // if only subproject known, try to set it (fillSubprojectOptions has fallback)
    //     fillSubprojectOptions(selSub, '', prefill.subproject_id);
    //   }
    //   if(prefill.hours) tr.querySelector('.inp-hours').value = prefill.hours;
    //   if(Array.isArray(prefill.week_perc)){
    //     tr.querySelector('.wpct-1').value = prefill.week_perc[0]||0;
    //     tr.querySelector('.wpct-2').value = prefill.week_perc[1]||0;
    //     tr.querySelector('.wpct-3').value = prefill.week_perc[2]||0;
    //     tr.querySelector('.wpct-4').value = prefill.week_perc[3]||0;
    //   }
    //   if(prefill.id) tr.setAttribute('data-team-dist-id', prefill.id);
    //   updateFTE(tr);

// apply prefill values if provided
if(prefill){
  if(prefill.reportee_ldap){
    const selR = tr.querySelector('.sel-resource1');
    if (selR) {
      for(let i=0;i<selR.options.length;i++){
        if(String(selR.options[i].value).toLowerCase() === String(prefill.reportee_ldap).toLowerCase()){
          selR.selectedIndex = i; break;
        }
      }
    }
  }
  if(prefill.project_id){
    selProj.value = prefill.project_id;
    fillSubprojectOptions(selSub, prefill.project_id, prefill.subproject_id || null);
  } else if(prefill.subproject_id){
    fillSubprojectOptions(selSub, '', prefill.subproject_id);
  }
  if(prefill.hours) tr.querySelector('.inp-hours').value = prefill.hours;
  if(Array.isArray(prefill.week_perc)){
    tr.querySelector('.wpct-1').value = prefill.week_perc[0]||0;
    tr.querySelector('.wpct-2').value = prefill.week_perc[1]||0;
    tr.querySelector('.wpct-3').value = prefill.week_perc[2]||0;
    tr.querySelector('.wpct-4').value = prefill.week_perc[3]||0;
  }
  if(prefill.id) tr.setAttribute('data-team-dist-id', prefill.id);
  updateFTE(tr);


    }

    document.getElementById('allocBodyByProject').appendChild(tr);
    return tr;
  }
  window.createRowByProject = createRowByProject;

// end of a new row creation for allocation by project tab


  // recompute summary table totals from allocation rows


  function recomputeSummaryTotals(){
    const totals = {};
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
      if(!ldap) return;
      totals[ldap] = (totals[ldap] || 0) + hrs;
    });



    document.querySelectorAll('#summaryBody .reportee-row').forEach(rr => {
      const ldap = (rr.getAttribute('data-ldap')||'').toLowerCase();
      const hrs = totals[ldap] || 0;
      const hrsEl = rr.querySelector('.r-hours');
      const fteEl = rr.querySelector('.r-fte');
      const ptgeEl = rr.querySelector('.r-ptge');
      if(hrsEl) hrsEl.textContent = hrs.toFixed(2);
      if(fteEl) fteEl.textContent = (MONTHLY_LIMIT ? (hrs / MONTHLY_LIMIT).toFixed(1) : '0.0');
      if(hrsEl) ptgeEl.textContent = (hrs ? (hrs / MAX_FTE_PM * 100).toFixed(1) : '0.0' );
      // if(ptgeEl) hrsEl.textContent = hrs.toFixed(2);
    });

    //JS:
    document.querySelectorAll('#summaryBodyprojectview .alloc-row').forEach(rr => {
        //Project
        //Resource
        //FTE
        //Percentage
          const ldap = (rr.getAttribute('data-ldap')||'').toLowerCase();
      const hrs = totals[ldap] || 0;
      const hrsEl = rr.querySelector('.r-hours');
      const fteEl = rr.querySelector('.r-fte');
      const ptgeEl = rr.querySelector('.r-ptge');

     // fillSubprojectOptions(rr.querySelector('.sel-subproject'), projectId, subprojectSelected);

      if(hrsEl){
            fteEl.textContent = (MONTHLY_LIMIT ? (hrsEl.textContent / MONTHLY_LIMIT).toFixed(1) : '0.0');
            ptgeEl.textContent = (hrsEl.textContent ? (hrsEl.textContent / MAX_FTE_PM * 100).toFixed(1) : '0.0' );
      }
      //if(hrsEl) ptgeEl.textContent = (hrs ? (hrs / MAX_FTE_PM * 100).toFixed(3) : '0.000' );
       // console.log("/////JAYASHREE", fteEl, hrs, hrsEl);

    });
    //JS:

  }

  // Build initial rows from server-provided allocations
  function populateInitialRows(){
    // Guard: if server already rendered rows into #allocBody, do not duplicate.
    if(document.querySelectorAll('#allocBody .alloc-row').length > 0){
      // still ensure subproject selects are filled for those server-rendered rows
      document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
        const projectId = tr.querySelector('.sel-project')?.value;
        const subprojectSelected = tr.getAttribute('data-subproject-id') || tr.querySelector('.sel-subproject')?.value;
        if(projectId){
          fillSubprojectOptions(tr.querySelector('.sel-subproject'), projectId, subprojectSelected);
        } else if(subprojectSelected){
          // if project missing but subproject present, attempt to find project and select it
          try {
            const sp = SUBPROJECTS.find(s => String(s.id) === String(subprojectSelected));
            if(sp && sp.project_id){
              // try to set project select element to matching value
              const projSel = tr.querySelector('.sel-project');
              if(projSel){
                const opt = Array.from(projSel.options).find(o => String(o.value) === String(sp.project_id));
                if(opt) projSel.value = opt.value;
              }
              // now fill subprojects for the selected project
              fillSubprojectOptions(tr.querySelector('.sel-subproject'), tr.querySelector('.sel-project')?.value, subprojectSelected);
            } else {
              // fallback: ensure subproject select still shows the specific subproject if possible
              fillSubprojectOptions(tr.querySelector('.sel-subproject'), '', subprojectSelected);
            }
          } catch(e){}
        }
        updateFTE(tr);
      });
      recomputeSummaryTotals();
      return;
    }

    const initial = {{ allocations|default:"[]"|safe }};
    if(Array.isArray(initial) && initial.length){
      initial.forEach(r => {
        createRow({
          id: r.id || null,
          reportee_ldap: r.reportee_ldap || '',
          project_id: r.project_id || '',
          subproject_id: r.subproject_id || '',
          hours: r.hours || 0,
          week_perc: r.week_perc || [0,0,0,0]
        });
      });
    }
    recomputeSummaryTotals();
  }

//   function gatherAllocations(){
//   const rows = [];
//   document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
//     const tid = tr.getAttribute('data-team-dist-id') || null;
//     const reportee = tr.querySelector('.sel-resource')?.value || '';
//     const project_id = tr.querySelector('.sel-project')?.value || null;
//     const subproject_id = tr.querySelector('.sel-subproject')?.value || null;
//     const hours = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
//
//     // collect all week inputs for this row, read their data-week attribute
//     const weekInputs = Array.from(tr.querySelectorAll('input.wpct'));
//     // produce an array of { week_number, percent } objects sorted by week_number
//     const weeks_payload = weekInputs.map(i => {
//       const wn = parseInt(i.getAttribute('data-week') || '0', 10) || 0;
//       const pv = parseFloat(i.value || 0) || 0;
//       return { week_number: wn, percent: parseFloat(pv.toFixed(2)) };
//     }).sort((a,b) => (a.week_number - b.week_number));
//
//     rows.push({
//       id: tid,
//       reportee: reportee,
//       project_id: project_id,
//       subproject_id: subproject_id,
//       hours: hours,
//       weeks: weeks_payload
//     });
//   });
//   return rows;
// }
//end of the gather allocations function

    function gatherAllocations(tableSelector){
  const rows = [];
  document.querySelectorAll(tableSelector + ' .alloc-row').forEach(tr => {
    const tid = tr.getAttribute('data-team-dist-id') || null;
    const reportee = tr.querySelector('.sel-resource, .sel-resource1')?.value || '';
    const project_id = tr.querySelector('.sel-project')?.value || null;
    const subproject_id = tr.querySelector('.sel-subproject')?.value || null;
    const hours = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
    const weekInputs = Array.from(tr.querySelectorAll('input.wpct'));
    const weeks_payload = weekInputs.map(i => {
      const wn = parseInt(i.getAttribute('data-week') || '0', 10) || 0;
      const pv = parseFloat(i.value || 0) || 0;
      return { week_number: wn, percent: parseFloat(pv.toFixed(2)) };
    }).sort((a,b) => (a.week_number - b.week_number));
    rows.push({
      id: tid,
      reportee: reportee,
      project_id: project_id,
      subproject_id: subproject_id,
      hours: hours,
      weeks: weeks_payload
    });
  });
  return rows;
}


  // Validate monthly limit across all allocations before save.
  // Highlights rows that cause exceedance and returns boolean valid/invalid.
  function validateMonthlyLimit(){
    const totals = {};
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
      if(!ldap) return;
      totals[ldap] = (totals[ldap] || 0) + hrs;
    });

    // Clear all previous highlight states
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => tr.classList.remove('limit-exceeded'));

    let valid = true;
    // For each row, if totals for that resource exceed MONTHLY_LIMIT, mark the row.
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      if(!ldap) return;
      const totalForUser = totals[ldap] || 0;
      if(MONTHLY_LIMIT && totalForUser > MONTHLY_LIMIT){
        tr.classList.add('limit-exceeded');
        valid = false;
      }
    });

    if(!valid){
      // Friendly message (non-blocking except save prevented by caller)
      alert('⚠️ One or more resources exceed the monthly hours limit (' + MONTHLY_LIMIT + ' hrs). Rows highlighted in red.');
    }
    return valid;
  }

  // -----------------------
  // Event wiring / handlers
  // -----------------------

  // Add Resource button
  document.getElementById('btnAddRow').addEventListener('click', function(e){
    e.preventDefault();
    const tr = createRow({});
    // focus on the resource select for quick input
    const sel = tr.querySelector('.sel-resource');
    if(sel) sel.focus();
  });


  // Delegated event handling for dynamic elements:
  // NOTE: for server-rendered rows (which were not created via createRow)
  // we need to call delete endpoint when a DB-backed row is removed.
  document.addEventListener('click', function(e){
    // remove button (any dynamically created or server-rendered .btn-remove)
    if(e.target && e.target.classList && e.target.classList.contains('btn-remove')){
      const row = e.target.closest('.alloc-row');
      if(!row) return;

      const tid = row.getAttribute('data-team-dist-id');
      if(tid){
        // Confirm then call server delete; on success remove row from DOM
        if(!confirm('This allocation exists in the database. Are you sure you want to delete it?')) return;
        fetch("{% url 'projects:delete_team_distribution' %}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
          body: JSON.stringify({id: parseInt(tid,10)})
        }).then(r => r.json()).then(j => {
          if(j && j.ok){
            row.remove();
            recomputeSummaryTotals();
          } else {
            alert('Delete failed: ' + (j && j.error ? j.error : 'unknown'));
          }
        }).catch(err => {
          console.error('Delete error', err);
          alert('Delete request failed — see console.');
        });
      } else {
        // just remove unsaved row
        row.remove();
        recomputeSummaryTotals();
      }
      return;
    }
  });

  // Delegated change handler for select/project/subproject/hours inputs
  document.addEventListener('change', function(e){
    const target = e.target;
    // project changed -> refill subproject options
    if(target && target.classList && target.classList.contains('sel-project')){
      const tr = target.closest('.alloc-row');
      if(tr){
        const selSub = tr.querySelector('.sel-subproject');
        fillSubprojectOptions(selSub, target.value, tr.getAttribute('data-subproject-id') || null);
      }
    }

    // hours changed or resource changed -> recompute totals & fte
    if(target && (target.classList.contains('inp-hours') || target.classList.contains('sel-resource'))){
      const tr = target.closest('.alloc-row');
      if(tr) updateFTE(tr);
      recomputeSummaryTotals();
    }

    // any week percent changes -> nothing special now but can be wired later
  });

  // Save handler: validate monthly limit first, then proceed to post
  document.getElementById('btnSaveAlloc').addEventListener('click', async function(e){
    e.preventDefault();

    recomputeSummaryTotals(); // ensure summary up-to-date
    if(!validateMonthlyLimit()) return; // stop if invalid

    const payload = {
      month: document.getElementById('month')?.value || '{{ billing_month }}',
      allocations: gatherAllocations('#allocBody')
    };

    try {
      const resp = await fetch(window.location.pathname.replace(/\/$/, '') + '/save/', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(data && data.ok){
        // reload to reflect server truth (idempotent upserts on server)
        location.reload();
      } else {
        alert('Save failed: ' + (data && data.error ? data.error : 'Unknown error'));
      }
    } catch(err){
      console.error('Save error', err);
      alert('Save failed (network or server error). See console for details.');
    }
  });
  //end of save handler

// Save handler for allocation by project tab: validate monthly limit first, then proceed to post
  document.getElementById('btnSaveAlloc-project').addEventListener('click', async function(e){
    e.preventDefault();

    recomputeSummaryTotals(); // ensure summary up-to-date
    if(!validateMonthlyLimit()) return; // stop if invalid

    const payload = {
      month: document.getElementById('month')?.value || '{{ billing_month }}',
      allocations: gatherAllocations('#allocBodyByProject')
    };

    try {
      const resp = await fetch(window.location.pathname.replace(/\/$/, '') + '/save/', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(data && data.ok){
        // reload to reflect server truth (idempotent upserts on server)
        location.reload();
      } else {
        alert('Save failed: ' + (data && data.error ? data.error : 'Unknown error'));
      }
    } catch(err){
      console.error('Save error', err);
      alert('Save failed (network or server error). See console for details.');
    }
  });
  //end of save handler for allocation by project tab

  // Initialise: populate rows (but guarded to avoid duplicates)
  document.addEventListener('DOMContentLoaded', function(){
    populateInitialRows();
    // Ensure subproject selects for any server-rendered rows are filled
    document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
      const projectId = tr.querySelector('.sel-project')?.value;
      const subprojectSelected = tr.getAttribute('data-subproject-id') || tr.querySelector('.sel-subproject')?.value;
      if(projectId){
        fillSubprojectOptions(tr.querySelector('.sel-subproject'), projectId, subprojectSelected);
      } else if(subprojectSelected){
        fillSubprojectOptions(tr.querySelector('.sel-subproject'), '', subprojectSelected);
      }
      updateFTE(tr);
    });
    recomputeSummaryTotals();
  });


   document.addEventListener('DOMContentLoaded', function(){
    populateInitialRows();
    // Ensure subproject selects for any server-rendered rows are filled
    document.querySelectorAll('#allocBodyByProject .alloc-row').forEach(tr => {
      const projectId = tr.querySelector('.sel-project')?.value;
      const subprojectSelected = tr.getAttribute('data-subproject-id') || tr.querySelector('.sel-subproject')?.value;
      if(projectId){
        fillSubprojectOptions(tr.querySelector('.sel-subproject'), projectId, subprojectSelected);
      } else if(subprojectSelected){
        fillSubprojectOptions(tr.querySelector('.sel-subproject'), '', subprojectSelected);
      }
      updateFTE(tr);
    });
    recomputeSummaryTotals();
  });

//start of export to excel for both tabs
function handleExportExcel(e, byProject) {
  e.preventDefault();
  const month = document.getElementById("month")?.value || "{{ billing_month }}";
  let url = "{% url 'projects:export_tl_allocations_excel' %}?month=" + encodeURIComponent(month);
  if (byProject) url += "&by_project=1";
  window.location.href = url;
}

document.getElementById("btnExportExcel").addEventListener("click", function(e){
  handleExportExcel(e, false);
});
document.getElementById("btnExportExcel-project").addEventListener("click", function(e){
  handleExportExcel(e, true);
});
    // end of excel to export for both tabs

//export to excel origional code (allocation by team member tab only)
// document.getElementById("btnExportExcel").addEventListener("click", function(e){
//   e.preventDefault();
//   const month = document.getElementById("month")?.value || "{{ billing_month }}";
//   window.location.href = "{% url 'projects:export_tl_allocations_excel' %}?month=" + encodeURIComponent(month);
// });
// ----- ensure this runs inside your IIFE ----- //
const WEEKS = JSON.parse('{{ weeks_info_json|default:"[]"|escapejs }}' || '[]');

function mkWeekInput(weekNum, maxPct, initialValue){
  const inp = document.createElement('input');
  inp.type = 'number';
  inp.min = 0;
  inp.max = 100;
  inp.step = 0.01;
  inp.className = 'input wpct';
  inp.setAttribute('data-week', String(weekNum));
  inp.setAttribute('data-max', String(maxPct));
  inp.value = (initialValue !== undefined && initialValue !== null) ? String(initialValue) : '0.00';
  inp.addEventListener('input', function(e){
    // clamp to data-max visually; exact validation on save will run as before
    const maxv = parseFloat(inp.getAttribute('data-max')||'100');
    let v = parseFloat(inp.value||'0') || 0;
    if(v > maxv){ inp.value = String(maxv.toFixed(2)); inp.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.06)'; }
    else inp.style.boxShadow = '';
    // recompute row totals if you have such logic:
    const r = inp.closest('tr.alloc-row'); if(r) validateTotalPctForRow(r);
  });
  return inp;
}

function populateWeekInputsForRow(tr, existingValues){
  // remove any placeholder week tds first
  Array.from(tr.querySelectorAll('td.td-week')).forEach(td => td.remove());
  // insert each week cell before the action cell (if exists), else append
  const actionCell = tr.querySelector('.action-cell');
  WEEKS.forEach(w => {
    const td = document.createElement('td');
    td.className = 'td-week text-center';
    const initial = (existingValues && typeof existingValues[String(w.num)] !== 'undefined') ? existingValues[String(w.num)] : (w.percent || '0.00');
    const inp = mkWeekInput(w.num, w.max_pct || w.max_percent || 100, initial);
    td.appendChild(inp);
    if(actionCell) tr.insertBefore(td, actionCell);
    else tr.appendChild(td);
  });
}

// expose helper globally so the add-row handler can call it
window.tl_alloc_helpers = window.tl_alloc_helpers || {};
window.tl_alloc_helpers.populateWeekInputsForRow = populateWeekInputsForRow;
window.tl_alloc_helpers.WEEKS = WEEKS;

// --- early in the IIFE / after WEEKS and window.tl_alloc_helpers are defined ---
const SERVER_ALLOCATIONS = JSON.parse('{{ allocations_json|default:"[]"|escapejs }}' || '[]');

// build a map for quick lookup by team_distribution id (string keys)
const ALLOC_BY_ID = {};
if (Array.isArray(SERVER_ALLOCATIONS)) {
  SERVER_ALLOCATIONS.forEach(a => {
    if (a && (a.id !== null && typeof a.id !== 'undefined')) {
      ALLOC_BY_ID[String(a.id)] = a;
    }
  });
}

// helper to update visual classes on a wpct input
function updateWpctStyling(inp) {
  const val = parseFloat(inp.value || 0) || 0;
  inp.classList.remove('filled', 'zero');
  if (val > 0.0001) inp.classList.add('filled');
  else inp.classList.add('zero');
}

// Common function to populate week inputs for any allocation table
function populateWeekInputsFromAllocations(tableSelector) {
  document.querySelectorAll(tableSelector + ' .alloc-row').forEach(tr => {
    const tdid = tr.getAttribute('data-team-dist-id') || tr.dataset.teamDistId || null;
    if (!tdid) {
      tr.querySelectorAll('input.wpct').forEach(i => updateWpctStyling(i));
      return;
    }
    const alloc = ALLOC_BY_ID[String(tdid)];
    if (!alloc) {
      tr.querySelectorAll('input.wpct').forEach(i => updateWpctStyling(i));
      return;
    }
    if (Array.isArray(alloc.week_perc)) {
      alloc.week_perc.forEach((val, idx) => {
        const weekNum = (WEEKS[idx] && WEEKS[idx].num) ? WEEKS[idx].num : (idx + 1);
        const input = tr.querySelector('input.wpct[data-week="' + weekNum + '"]');
        if (input) {
          input.value = (typeof val === 'number') ? val.toFixed(2) : String(val || 0);
          updateWpctStyling(input);
        }
      });
    } else {
      tr.querySelectorAll('input.wpct').forEach(i => updateWpctStyling(i));
    }
  });
  try { recomputeSummaryTotals(); } catch(e) { /* ignore if not present */ }
}

// Call for both tables on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function(){
  populateWeekInputsFromAllocations('#allocBody');
  populateWeekInputsFromAllocations('#allocBodyByProject');
});


// start of working code for allocation by team member tab- Fill server-rendered week inputs from allocations_json if they are blank
// document.addEventListener('DOMContentLoaded', function(){
//   // (you probably already call populateInitialRows() here — keep that)
//   try {
//     // For each server-rendered row with a data-team-dist-id attribute, fill week inputs
//     document.querySelectorAll('#allocBody .alloc-row').forEach(tr => {
//       const tdid = tr.getAttribute('data-team-dist-id') || tr.dataset.teamDistId || null;
//       if (!tdid) {
//         // nothing to populate for unsaved rows - but ensure JS will create inputs on add-row
//         // also mark any present wpct inputs as zero for styling
//         tr.querySelectorAll('input.wpct').forEach(i => updateWpctStyling(i));
//         return;
//       }
//       const alloc = ALLOC_BY_ID[String(tdid)];
//       if (!alloc) {
//         // no allocation object found — just style existing inputs
//         tr.querySelectorAll('input.wpct').forEach(i => updateWpctStyling(i));
//         return;
//       }
//
//       // alloc.week_perc is expected as an array aligned to WEEKS order
//       if (Array.isArray(alloc.week_perc)) {
//         // for each week index, find the corresponding input by data-week and set value
//         alloc.week_perc.forEach((val, idx) => {
//           // corresponding week number (safe fallback to index+1)
//           const weekNum = (WEEKS[idx] && WEEKS[idx].num) ? WEEKS[idx].num : (idx + 1);
//           const input = tr.querySelector('input.wpct[data-week="' + weekNum + '"]');
//           if (input) {
//             // set value to fixed 2 decimals for consistency
//             input.value = (typeof val === 'number') ? val.toFixed(2) : String(val || 0);
//             updateWpctStyling(input);
//           }
//         });
//       } else {
//         // no week_perc array — just style present inputs
//         tr.querySelectorAll('input.wpct').forEach(i => updateWpctStyling(i));
//       }
//     });
//   } catch (err) {
//     console.error('Error populating week pct inputs from allocations_json', err);
//   }
//
//   // Recompute FTEs/totals if you need (call your existing helpers)
//   try { recomputeSummaryTotals(); } catch(e) { /* ignore if not present */ }
// });

})();
//end of server-rendered week inputs population-> working code for allocation by team member tab




//Tab handling JS for multiple tab sets
(function(){
  document.querySelectorAll('.feas-tabs').forEach(root => {
    const btns = Array.from(root.querySelectorAll('.feas-tab-btn'));
    const panels = {};
    btns.forEach(b => {
      const pid = b.getAttribute('aria-controls');
      panels[pid] = root.querySelector('#' + pid);
    });
    function activate(button){
      btns.forEach(b => {
        b.classList.toggle('active', b === button);
        b.setAttribute('aria-selected', b === button ? 'true' : 'false');
      });
      Object.values(panels).forEach(p => p.hidden = true);
      const targetId = button.getAttribute('aria-controls');
      panels[targetId].hidden = false;
      panels[targetId].focus({ preventScroll: true });
    }
    btns.forEach(b => b.addEventListener('click', () => activate(b)));
    btns.forEach((b, idx) => {
      b.addEventListener('keydown', (e) => {
        if (!['ArrowLeft','ArrowRight'].includes(e.key)) return;
        e.preventDefault();
        const next = e.key === 'ArrowRight' ? (idx + 1) % btns.length : (idx - 1 + btns.length) % btns.length;
        btns[next].focus();
        activate(btns[next]);
      });
    });
  });
})();
//End of tab handling JS


// Add Resource button in allocation by project tab
document.getElementById('btnAddRow-project').addEventListener('click', function(e){
  e.preventDefault();
  const tpl = document.getElementById('tpl-alloc-row-by-project');
  const node = tpl.content.cloneNode(true);
  const tr = node.querySelector('tr');

  // Wire up subproject select population
  const selProj = tr.querySelector('.sel-project');
  const selSub  = tr.querySelector('.sel-subproject');
  selProj.addEventListener('change', function(){
    fillSubprojectOptions(selSub, this.value, null);
  });

  // Wire up FTE calculation
  tr.querySelector('.inp-hours').addEventListener('input', function(){ updateFTE(tr); });

  // Wire up remove button
  tr.querySelector('.btn-remove').addEventListener('click', function(ev){
    ev.preventDefault();
    tr.remove();
  });

  // Populate week inputs
  if(window.tl_alloc_helpers && typeof window.tl_alloc_helpers.populateWeekInputsForRow === 'function'){
    tl_alloc_helpers.populateWeekInputsForRow(tr, {});
  }

  // Append to project allocation table
  document.getElementById('allocBodyByProject').appendChild(tr);

  // Focus resource select for quick input
  const sel = tr.querySelector('.sel-resource1');
  if(sel) sel.focus();
});
function recomputeSummaryTotals(){
    const totals = {};
    document.querySelectorAll('#allocBodyByProject .alloc-row').forEach(tr => {
      const ldap = (tr.querySelector('.sel-resource')?.value || '').toLowerCase();
      const hrs = parseFloat(tr.querySelector('.inp-hours')?.value || 0) || 0;
      if(!ldap) return;
      totals[ldap] = (totals[ldap] || 0) + hrs;
    });


    document.querySelectorAll('#summaryBody .reportee-row').forEach(rr => {
      const ldap = (rr.getAttribute('data-ldap')||'').toLowerCase();
      const hrs = totals[ldap] || 0;
      const hrsEl = rr.querySelector('.r-hours');
      const fteEl = rr.querySelector('.r-fte');
      const ptgeEl = rr.querySelector('.r-ptge');
      if(hrsEl) hrsEl.textContent = hrs.toFixed(2);
      if(fteEl) fteEl.textContent = (MONTHLY_LIMIT ? (hrs / MONTHLY_LIMIT).toFixed(3) : '0.000');
      if(hrsEl) ptgeEl.textContent = (hrs ? (hrs / MAX_FTE_PM * 100).toFixed(3) : '0.000' );
      // if(ptgeEl) hrsEl.textContent = hrs.toFixed(2);
    });

    //JS:
    //document.querySelectorAll('#summaryBodyallottmentview .reportee-row').forEach(rr => {

  }

//   function loadAllotmentView() {
//   const month = document.getElementById("month")?.value || "{{ billing_month }}";
//     console.log("JS: Loading Allotment View Data...",month);
//   fetch("{% url 'projects:view_allotment' %}?month=" + encodeURIComponent(month))
//     .then(r => r.json())
//     .then(j => {
//       const tbody = document.getElementById("summaryBodyallottmentview");
//       tbody.innerHTML = "";
//       if (j.data && j.data.length) {
//         j.data.forEach(row => {
//           const tr = document.createElement("tr");
//           tr.innerHTML = `
//             <td>${row.project || ""}</td>
//             <td>${row.subproject || ""}</td>
//             <td>${row.resource || ""}</td>
//             <td>${row.allocated_hrs || "0.00"}</td>
//             <td>${row.fte || "0.000"}</td>
//             <td>${row.wbs || ""}</td>
//           `;
//           tbody.appendChild(tr);
//         });
//       } else {
//         tbody.innerHTML = `<tr><td colspan="6" class="small-muted">No allotments found.</td></tr>`;
//       }
//     });
// }

// Load data when the tab is activated
document.querySelector('[aria-controls="panel-three"]').addEventListener('click', loadAllotmentView);

// Optionally, reload when month changes
document.getElementById("month").addEventListener("change", function() {
  if (document.querySelector('[aria-controls="panel-three"]').classList.contains("active")) {
    loadAllotmentView();
  }
});


document.getElementById('btnMyApproval').addEventListener('click', function(e){
  e.preventDefault();
  window.location.href = "{% url 'projects:tl_punch_review' %}";
});

// Sort Project View tab by Program column (first column)
// document.addEventListener('DOMContentLoaded', function() {
//   const tbody = document.getElementById('summaryBodyprojectview');
//   if (!tbody) return;
//   const rows = Array.from(tbody.querySelectorAll('tr'));
//   rows.sort((a, b) => {
//     const progA = (a.cells[0]?.textContent || '').toLowerCase();
//     const progB = (b.cells[0]?.textContent || '').toLowerCase();
//     return progA.localeCompare(progB);
//   });
//   rows.forEach(row => tbody.appendChild(row));
// });

document.addEventListener('DOMContentLoaded', function() {
  const tbody = document.getElementById('summaryBodyprojectview');
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.sort((a, b) => {
    const progA = (a.cells[0]?.textContent || '').toLowerCase();
    const progB = (b.cells[0]?.textContent || '').toLowerCase();
    return progA.localeCompare(progB);
  });

  const seenPrograms = new Set();
  const seenProjects = new Set();
  rows.forEach(row => {
    // Program column (first cell)
    const progCell = row.cells[0];
    const progName = (progCell?.textContent || '').trim();
    if (seenPrograms.has(progName)) {
      progCell.textContent = '';
    } else if (progName) {
      seenPrograms.add(progName);
    }
    // Project column (second cell)
    const projCell = row.cells[1];
    const projName = (projCell?.textContent || '').trim();
    if (seenProjects.has(projName)) {
      projCell.textContent = '';
    } else if (projName) {
      seenProjects.add(projName);
    }
    tbody.appendChild(row);
  });
});

function loadAllotmentView() {
  const month = document.getElementById("month")?.value || "{{ billing_month }}";
  fetch("{% url 'projects:view_allotment' %}?month=" + encodeURIComponent(month))
    .then(r => r.json())
    .then(j => {
      const tbody = document.getElementById("summaryBodyallottmentview");
      tbody.innerHTML = "";
      if (j.data && j.data.length) {
        // Sort by Program and Project
        j.data.sort((a, b) => {
          const progA = (a.project || "").toLowerCase();
          const progB = (b.project || "").toLowerCase();
          const projA = (a.subproject || "").toLowerCase();
          const projB = (b.subproject || "").toLowerCase();
          if (progA === progB) return projA.localeCompare(projB);
          return progA.localeCompare(progB);
        });

        // Track seen Program and Project names
        const seenPrograms = new Set();
        const seenProjects = new Set();
        j.data.forEach(row => {
          const progName = row.project || "";
          const projName = row.subproject || "";
          const showProg = !seenPrograms.has(progName);
          const showProj = !seenProjects.has(projName);
          seenPrograms.add(progName);
          seenProjects.add(projName);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${showProg ? progName : ""}</td>
            <td>${showProj ? projName : ""}</td>
            <td>${row.resource || ""}</td>
            <td>${row.allocated_hrs || "0.00"}</td>
            <td>${row.fte || "0.000"}</td>
            <td>${row.wbs || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="6" class="small-muted">No allotments found.</td></tr>`;
      }
    });
}

// JS: Add Project for Resource button handler (insert below current row)
document.addEventListener('click', function(e){
  if (e.target && e.target.id === 'btnAddProjectForResource') {
    e.preventDefault();
    const currentTr = e.target.closest('tr.alloc-row');
    if (!currentTr) return;

    // Get the selected resource in this row
    const selResource = currentTr.querySelector('.sel-resource');
    const selectedResource = selResource ? selResource.value : '';

    if (!selectedResource) {
      alert('Please select a resource in this row before adding a project for that resource.');
      return;
    }

    // Create a new row with the same resource pre-selected
    const newTr = createRow({ reportee_ldap: selectedResource });

    // Insert the new row right after the current row
    currentTr.parentNode.insertBefore(newTr, currentTr.nextSibling);

    // Focus on the project select for quick input
    const selProj = newTr.querySelector('.sel-project');
    if (selProj) selProj.focus();
  }
});

// Sort Allocation by Team Member tab by Resource column
// document.addEventListener('DOMContentLoaded', function() {
//   function sortAllocBodyByResource() {
//     const tbody = document.getElementById('allocBody');
//     if (!tbody) return;
//     const rows = Array.from(tbody.querySelectorAll('tr.alloc-row'));
//     rows.sort((a, b) => {
//       const resA = a.querySelector('.sel-resource option:checked')?.textContent.trim().toLowerCase() || '';
//       const resB = b.querySelector('.sel-resource option:checked')?.textContent.trim().toLowerCase() || '';
//       return resA.localeCompare(resB);
//     });
//     rows.forEach(row => tbody.appendChild(row));
//   }
//   sortAllocBodyByResource();
//
//   // Optionally, re-sort after adding a row
//   //document.getElementById('btnAddRow').addEventListener('click', function() {
//    // setTimeout(sortAllocBodyByResource, 100); // Delay to allow row insertion
//   //});
// });

document.addEventListener('DOMContentLoaded', function() {
  function sortAndHideDuplicateResources() {
    const tbody = document.getElementById('allocBody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr.alloc-row'));
    // Sort rows by resource name
    rows.sort((a, b) => {
      const resA = a.querySelector('.sel-resource option:checked')?.textContent.trim().toLowerCase() || '';
      const resB = b.querySelector('.sel-resource option:checked')?.textContent.trim().toLowerCase() || '';
      return resA.localeCompare(resB);
    });
    // Hide duplicate resource names
    const seenResources = new Set();
    rows.forEach(row => {
      const resCell = row.querySelector('td');
      const resName = row.querySelector('.sel-resource option:checked')?.textContent.trim() || '';
      if (seenResources.has(resName)) {
        if (resCell) resCell.style.visibility = 'hidden';
      } else if (resName) {
        seenResources.add(resName);
        if (resCell) resCell.style.visibility = '';
      }
      tbody.appendChild(row);
    });
  }
  sortAndHideDuplicateResources();
});




// Sort Allocation by Project tab by Program column (first column)
document.addEventListener('DOMContentLoaded', function() {
  function sortAllocBodyByProgram() {
    const tbody = document.getElementById('allocBodyByProject');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr.alloc-row'));
    rows.sort((a, b) => {
      const progA = a.querySelector('.sel-project option:checked')?.textContent.trim().toLowerCase() || '';
      const progB = b.querySelector('.sel-project option:checked')?.textContent.trim().toLowerCase() || '';
      return progA.localeCompare(progB);
    });
    rows.forEach(row => tbody.appendChild(row));
  }
  sortAllocBodyByProgram();
});


// JS: Add Resource for Project button handler (insert below current row in Allocation by Project tab)

document.addEventListener('click', function(e){
  if (e.target && e.target.classList.contains('btn-add-resource-for-project')) {
    e.preventDefault();
    const currentTr = e.target.closest('tr.alloc-row');
    if (!currentTr) return;

    // Get the selected project and resource in this row
    const selProject = currentTr.querySelector('.sel-project');
    const selResource = currentTr.querySelector('.sel-resource1');
    const selectedProject = selProject ? selProject.value : '';
    const selectedResource = selResource ? selResource.value : '';

    if (!selectedResource) {
      alert('Please select resource in this row before adding another allocation.');
      return;
    }

    // Create a new row with the same project and resource pre-selected
    const newTr = createRowByProject({
      project_id: selectedProject,
      reportee_ldap: selectedResource
    });

    // Insert the new row right after the current row
    currentTr.parentNode.insertBefore(newTr, currentTr.nextSibling);

    // Focus on the subproject select for quick input
    const selSub = newTr.querySelector('.sel-subproject');
    if (selSub) selSub.focus();
  }
});

// Hide duplicate Program and Project names in Allocation by Project tab
document.addEventListener('DOMContentLoaded', function() {
  const tbody = document.getElementById('allocBodyByProject');
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr.alloc-row'));
  let seenPrograms = new Set();
  let seenProjects = new Set();

  rows.forEach(row => {
    // Program column (first cell)
    const progCell = row.cells[0];
    const progName = progCell?.querySelector('select option:checked')?.textContent.trim() || '';
    if (seenPrograms.has(progName)) {
      progCell.style.visibility = 'hidden';
    } else if (progName) {
      seenPrograms.add(progName);
      progCell.style.visibility = '';
    }
    // Project column (second cell)
    const projCell = row.cells[1];
    const projName = projCell?.querySelector('select option:checked')?.textContent.trim() || '';
    if (seenProjects.has(projName)) {
      projCell.style.visibility = 'hidden';
    } else if (projName) {
      seenProjects.add(projName);
      projCell.style.visibility = '';
    }
  });
});





</script>

{% endblock %}
