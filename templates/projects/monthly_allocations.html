{% extends "base.html" %}
{% load static %}
{% block title %}Monthly Allocations{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'projects/css/monthly_allocations.css' %}">

<style>
/* Local styles (kept compact) */
.container-page { max-width:1180px; margin:20px auto; }
.card-panel { background:#fff; border-radius:12px; padding:22px; box-shadow:0 8px 30px rgba(2,6,23,0.06); }
.header-title { font-size:1.6rem; font-weight:700; color:#0b2447; margin-bottom:6px; }
.header-sub { color:#6b7280; margin-bottom:18px; }

.controls { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px; }
.control { min-width:220px; }
.control label { display:block; color:#475569; font-weight:600; margin-bottom:6px; }
.form-control, .form-select { padding:9px 12px; border-radius:8px; border:1px solid #e6eef7; min-height:40px; background:#fff; width:100%; box-sizing:border-box; }

.btn { padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; border:none; }
.btn-primary { background:#0b5ed7; color:#fff; }
.btn-outline { background:transparent; border:1px solid #cfe3ff; color:#0b5ed7; }
.small-muted { color:#6b7280; font-size:0.92rem; }

.iom-card { margin-top:12px; padding:14px; border-radius:10px; background:#f8fbff; border:1px solid #eaf6ff; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
.iom-left { flex:1; }
.iom-title { font-weight:700; color:#0b2447; margin-bottom:6px; }
.iom-meta { color:#475569; margin-top:6px; line-height:1.5; }

.iom-right { width:260px; text-align:right; color:#475569; }
.iom-right .stat { margin-bottom:6px; }
.badge-remaining { display:inline-block; margin-top:8px; background:#eff6ff; color:#0b53a0; padding:8px 12px; border-radius:999px; font-weight:700; border:1px solid #e6f0ff; }

.alloc-section { margin-top:18px; }
.alloc-table-wrap { background:#fff; padding:12px; border-radius:8px; border:1px solid #eef7ff; }
.table { width:100%; border-collapse:collapse; margin-top:12px; }
.table th { text-align:left; background:#f1f8ff; padding:10px; font-weight:700; color:#0b2447; border-bottom:1px solid #edf2f7; }
.table td { padding:10px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
.input-small { width:120px; }

.row-over { background:#fff4f6 !important; }
.readonly { background:#f8fafc; color:#0b2447; }

.toast { position:fixed; bottom:18px; right:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index:9999; }

@media (max-width:900px) {
  .iom-right { width:100%; text-align:left; margin-top:8px; }
  .controls { flex-direction:column; align-items:stretch; }
}
</style>

<div class="container-page">
  <div class="card-panel" role="main" aria-labelledby="ma-title">
    <h1 id="ma-title" class="header-title">Monthly Allocations</h1>
    <div class="header-sub">Manage resources and FTE per IOM</div>

    <!-- Filters / Controls -->
    <div class="controls" role="region" aria-label="Filters">
      <div class="control">
        <label for="projectSelect">Project</label>
        <select id="projectSelect" class="form-select">
          <option value="">-- Select Program --</option>
          {% for p in projects %}
            {# include bg_code in data-bg if available in project dict #}
            <option value="{{ p.id }}" data-bg="{{ p.bg_code|default:''|escape }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="control">
        <label for="subprojectSelect">Project</label>
        <select id="subprojectSelect" class="form-select">
          <option value="">-- Select Project --</option>
        </select>
      </div>

      <div class="control">
        <label for="yearInput">Year</label>
        <input id="yearInput" type="number" class="form-control" value="{{ now.year }}">
      </div>

      <div class="control">
        <label for="monthSelect">Month</label>
        <select id="monthSelect" class="form-select">
          <option value="1" {% if now.month == 1 %}selected{% endif %}>January</option>
          <option value="2" {% if now.month == 2 %}selected{% endif %}>February</option>
          <option value="3" {% if now.month == 3 %}selected{% endif %}>March</option>
          <option value="4" {% if now.month == 4 %}selected{% endif %}>April</option>
          <option value="5" {% if now.month == 5 %}selected{% endif %}>May</option>
          <option value="6" {% if now.month == 6 %}selected{% endif %}>June</option>
          <option value="7" {% if now.month == 7 %}selected{% endif %}>July</option>
          <option value="8" {% if now.month == 8 %}selected{% endif %}>August</option>
          <option value="9" {% if now.month == 9 %}selected{% endif %}>September</option>
          <option value="10" {% if now.month == 10 %}selected{% endif %}>October</option>
          <option value="11" {% if now.month == 11 %}selected{% endif %}>November</option>
          <option value="12" {% if now.month == 12 %}selected{% endif %}>December</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <button id="loadIomsBtn" class="btn btn-primary">Load IOMs</button>
      </div>
    </div>

    <!-- IOM Selection and Search -->
    <div style="display:flex;gap:12px;align-items:flex-start;margin-top:8px;flex-wrap:wrap;">
      <div style="flex:1;min-width:360px;">
        <label for="iomsDropdown">Applicable IOMs</label>
        <div style="display:flex;gap:8px;">
          <select id="iomsDropdown" class="form-select" style="flex:1;">
            <option value="">-- Load IOMs then select --</option>
          </select>
          <button id="addIomBtn" class="btn btn-outline">Add Selected IOM</button>
        </div>
      </div>

      <div style="min-width:260px;">
        <label for="searchIom">Search IOM / Dept</label>
        <input id="searchIom" class="form-control" placeholder="iom id or department">
      </div>
    </div>

    <!-- IOM Detail Card -->
<div id="iomDetailWrap" style="display:none;">
  <div class="iom-card" role="region" aria-live="polite"
       style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:20px; padding:15px 20px;
              border:1px solid var(--border-color,#ddd); border-radius:10px; background:var(--card-bg,#fafafa);">

    <!-- Left side: Project metadata -->
    <div class="iom-left" style="flex:1 1 55%; min-width:300px;">
      <div id="iomTitle" class="iom-title" style="font-weight:600; font-size:1.1rem; margin-bottom:8px;">IOM: —</div>

      <div class="iom-meta" style="margin-bottom:4px;">Project:
        <strong id="iomProjectName">—</strong>
      </div>

      <div class="iom-meta" style="margin-bottom:4px;">Department:
        <strong id="iomDept">—</strong>
      </div>

      <div class="iom-meta" style="margin-bottom:4px;">Buyer WBS:
        <strong id="iomBuyerWbs">—</strong>
      </div>

      <div class="iom-meta" style="margin-bottom:4px;">Seller WBS:
        <strong id="iomSellerWbs">—</strong>
      </div>

      <div class="iom-meta" style="margin-bottom:4px;">Site:
        <strong id="iomSite">—</strong>
      </div>

      <div class="iom-meta" style="margin-bottom:4px;">Function:
        <strong id="iomFunction">—</strong>
      </div>
    </div>

    <!-- Right side: Stats -->
    <div class="iom-right" style="flex:1 1 40%; min-width:260px; border-left:1px solid var(--border-color,#ddd);
                                   padding-left:15px; display:flex; flex-direction:column; gap:6px;">
      <div class="stat">Month FTE: <strong id="iomMonthFte">0.00</strong></div>
      <div class="stat">Month Hrs: <strong id="iomMonthHrs">0.00</strong></div>
      <div class="stat">Remaining FTE: <strong id="iomRemFte">0.00</strong></div>
      <div class="stat">Remaining Hrs: <strong id="iomRemHrs">0.00</strong></div>
      <div class="badge-remaining" id="remainingBadge" style="font-weight:600; margin-top:6px;">
        Remaining: 0.00h
      </div>
    </div>
  </div>
</div>


    <!-- Allocations -->
    <div class="alloc-section">
      <h3 style="margin-top:18px;">Resource Allocations</h3>
      <div class="alloc-table-wrap">
        <table class="table" id="allocTable" aria-describedby="allocations-for-iom">
          <thead>
            <tr>
              <th style="width:58%;">Lead Name / Resource
                <div class="small-muted" style="font-weight:600;font-size:0.9rem;">type 3+ chars to search</div>
              </th>
              <th style="width:18%;">Total Hours</th>
              <th style="width:14%;">FTE</th>
              <th style="width:10%;">Actions</th>
            </tr>
          </thead>
          <tbody id="allocBody">
            <tr class="empty-state"><td colspan="4" class="small-muted">No resources added yet. Add Selected IOM or use Add Resource.</td></tr>
          </tbody>
        </table>

        <div style="display:flex;gap:10px;align-items:center;margin-top:12px;">
          <button id="addResourceBtn" class="btn btn-outline">Add Resource</button>
          <div class="save-tooltip" style="position:relative;">
            <button id="saveBtn" class="btn btn-primary" disabled aria-disabled="true">Save</button>
            <div class="small-muted" id="saveHint" style="margin-left:8px;"></div>
          </div>
          <button id="exportBtn" class="btn btn-outline">Export Excel</button>
        </div>
      </div>
    </div>

    {# CSRF token hidden for JS use #}
    <div style="display:none;">{% csrf_token %}</div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* Monthly Allocations — complete, hardened client-side JS
   Replace existing script block with this one.
   Ensure the template defines the URL constants used below (or replace them with literal URLs).
*/

(function () {
  // ----- Configure these URL tokens to match your Django url names in the template -----
  const GET_SUBPROJECTS_URL = '{% url "projects:api_subprojects" %}';
  const GET_IOMS_URL = '{% url "projects:get_applicable_ioms" %}';
  const GET_IOM_DETAILS_URL = '{% url "projects:get_iom_details" %}';
  const GET_SAVED_ALLOC_URL = '{% url "projects:get_allocations_for_iom" %}';
  const SAVE_ALLOC_URL = '{% url "projects:save_monthly_allocations" %}';
  const EXPORT_URL = '{% url "projects:export_allocations" %}';
  // LDAP search url if you have one (optional)
  const LDAP_ENDPOINT = '{% url "projects:allocations_ldap_search" %}';

  // ----- DOM references -----
  const projectSelect = document.getElementById('projectSelect');
  const subprojectSelect = document.getElementById('subprojectSelect');
  const yearInput = document.getElementById('yearInput');
  const monthSelect = document.getElementById('monthSelect');
  const loadIomsBtn = document.getElementById('loadIomsBtn');
  const iomsDropdown = document.getElementById('iomsDropdown');
  const addIomBtn = document.getElementById('addIomBtn');
  const searchIom = document.getElementById('searchIom');

  const iomDetailWrap = document.getElementById('iomDetailWrap');
  const iomTitle = document.getElementById('iomTitle');
  const iomProjectName = document.getElementById('iomProjectName');
  const iomDept = document.getElementById('iomDept');
  const iomWbs = document.getElementById('iomWbs');
  const iomSite = document.getElementById('iomSite');
  const iomFunction = document.getElementById('iomFunction');
  const iomMonthFte = document.getElementById('iomMonthFte');
  const iomMonthHrs = document.getElementById('iomMonthHrs');
  const iomRemFte = document.getElementById('iomRemFte');
  const iomRemHrs = document.getElementById('iomRemHrs');
  const remainingBadge = document.getElementById('remainingBadge');

  const allocBody = document.getElementById('allocBody');
  const addResourceBtn = document.getElementById('addResourceBtn');
  const saveBtn = document.getElementById('saveBtn');
  const saveHint = document.getElementById('saveHint');
  const exportBtn = document.getElementById('exportBtn');

  const toast = document.getElementById('toast');

  // ----- State -----
  let CURRENT_IOM = null; // server canonical object from get_iom_details
  let BILLING_HOURS = parseFloat("{{ hours_available|default:'183.75' }}") || 183.75;
  const DEFAULT_BILLING_HOURS = BILLING_HOURS;

  // ----- Utilities -----
  function getCsrfToken() {
    const el = document.querySelector('[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
  }
  function showToast(msg, timeout = 2500) {
    if (!toast) return console.log('toast:', msg);
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, timeout);
  }
  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function safeText(node, text) { if (!node) return; node.textContent = (text !== undefined && text !== null) ? String(text) : '—'; }

  // ----- Clear / helpers for allocation rows -----
  function clearAllocRows() {
    if (!allocBody) return;
    allocBody.innerHTML = '<tr class="empty-state"><td colspan="4" class="small-muted">No resources added yet. Add Selected IOM or use Add Resource.</td></tr>';
  }

  function computeFteForValue(hours) {
    const bh = parseFloat(BILLING_HOURS) || DEFAULT_BILLING_HOURS;
    if (!bh || bh <= 0) return 0.0;
    return parseFloat(hours) / bh;
  }

  // Replace your existing createAllocRow() with this entire function
function createAllocRow(user_ldap = '', hours = 0) {
  const tr = document.createElement('tr');
  tr.className = 'alloc-row';

  // Build HTML structure
  tr.innerHTML = `
    <td>
      <div class="input-group">
        <input type="text" class="user-ldap form-control"
               placeholder="Type 3+ chars to search"
               list="ldap-${Date.now()}-${Math.floor(Math.random()*1000)}"
               value="${escapeHtml(user_ldap)}" />
        <datalist id=""></datalist>
      </div>
    </td>
    <td style="width:160px;">
      <input type="number" step="0.25" min="0"
             class="hours-input form-control"
             value="${Number(hours || 0).toFixed(2)}" />
    </td>
    <td style="width:160px;">
      <input type="text" class="fte-display form-control" readonly />
    </td>
    <td style="width:110px;">
      <button type="button" class="remove-row btn btn-outline-danger btn-sm">Remove</button>
    </td>
  `;

  const userInput = tr.querySelector('.user-ldap');
  const dataList = tr.querySelector('datalist');
  const hoursInput = tr.querySelector('.hours-input');
  const fteDisplay = tr.querySelector('.fte-display');
  const removeBtn = tr.querySelector('.remove-row');

  // Link datalist id correctly (random to avoid duplicates)
  const dlId = `ldap-${Date.now()}-${Math.floor(Math.random() * 9999)}`;
  dataList.id = dlId;
  userInput.setAttribute('list', dlId);

  // Initial FTE display
  fteDisplay.value = computeFteForValue(hours).toFixed(4);

  // Hours → recompute FTE
  hoursInput.addEventListener('input', () => {
    const hrs = parseFloat(hoursInput.value || 0) || 0;
    fteDisplay.value = computeFteForValue(hrs).toFixed(4);
    validateAll();
  });

  // Remove row
  removeBtn.addEventListener('click', () => {
    tr.remove();
    if (!allocBody.querySelectorAll('tr.alloc-row').length) clearAllocRows();
    validateAll();
  });

  // --- LDAP Autocomplete (local) ---
  if (typeof LDAP_ENDPOINT === 'string' && LDAP_ENDPOINT) {
    let timer = null;
    userInput.addEventListener('input', (ev) => {
      const q = ev.target.value.trim();
      if (q.length < 3) return;
      if (timer) clearTimeout(timer);
      timer = setTimeout(async () => {
        try {
          const res = await fetch(LDAP_ENDPOINT + '?q=' + encodeURIComponent(q), { credentials: 'same-origin' });
          const data = await res.json();
          if (!data || !data.results || !Array.isArray(data.results)) return;
          // Clear old options
          dataList.innerHTML = '';
          data.results.forEach(item => {
            // Support dict or string
            const mail = item.mail || item.email || '';
            const cn = item.cn || item.name || '';
            const title = item.title || '';
            const text = mail || cn;
            const label = cn
              ? `${cn}${mail ? ' - ' + mail : ''}${title ? ' (' + title + ')' : ''}`
              : mail;
            const opt = document.createElement('option');
            opt.value = text;
            opt.label = label;
            dataList.appendChild(opt);
          });
        } catch (err) {
          console.warn('LDAP fetch failed', err);
        }
      }, 400);
    });
  }

  return tr;
}


  // ----- Validation -----
  function validateAll() {
    if (!allocBody) return false;
    const rows = Array.from(allocBody.querySelectorAll('tr.alloc-row'));
    let sum = 0;
    let valid = true;
    let hint = '';

    rows.forEach(r => {
      const hours = parseFloat((r.querySelector('.hours-input') || {}).value || 0) || 0;
      sum += hours;
    });

    let iomTotal = 0;
    if (CURRENT_IOM && (CURRENT_IOM.month_hours !== undefined)) {
      iomTotal = parseFloat(CURRENT_IOM.month_hours || 0) || 0;
    }

    if (iomTotal > 0 && sum > iomTotal + 0.0001) {
      valid = false;
      hint = `Total allocated ${sum.toFixed(2)}h exceeds IOM total ${iomTotal.toFixed(2)}h`;
      rows.forEach(r => r.classList.add('row-over'));
    } else {
      rows.forEach(r => r.classList.remove('row-over'));
    }

    // per-row validations: user present and hours > 0
    for (const r of rows) {
      const user = (r.querySelector('.user-ldap') || {}).value || '';
      const hours = parseFloat((r.querySelector('.hours-input') || {}).value || 0) || 0;
      if (!user || !(hours > 0)) {
        valid = false;
        hint = hint || 'Each row must have a resource and hours > 0';
      }
    }

    saveBtn.disabled = !valid;
    saveBtn.setAttribute('aria-disabled', (!valid).toString());
    if (saveHint) saveHint.textContent = hint;
    return valid;
  }

  // ----- Load Subprojects -----
  async function loadSubprojects(project_id, preserveValue) {
    try {
      subprojectSelect.innerHTML = '<option value="">Loading...</option>';
      if (!project_id) {
        subprojectSelect.innerHTML = '<option value="">-- Select Project --</option>';
        return;
      }
      const params = new URLSearchParams({ project_id });
      const res = await fetch(GET_SUBPROJECTS_URL + '?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();
      subprojectSelect.innerHTML = '<option value="">-- Select Project --</option>';
      if (data && Array.isArray(data.subprojects) && data.subprojects.length) {
        for (const s of data.subprojects) {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = (s.name || '') + (s.mdm_code ? (' · ' + s.mdm_code) : '');
          subprojectSelect.appendChild(opt);
        }
        if (preserveValue) subprojectSelect.value = preserveValue;
      } else {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- No subprojects found --';
        subprojectSelect.appendChild(opt);
      }
    } catch (err) {
      console.error('loadSubprojects', err);
      subprojectSelect.innerHTML = '<option value="">-- Error loading --</option>';
      showToast('Failed to load subprojects');
    }
  }

  // ----- Load IOMs -----
  async function loadIoms() {
    try {
      const project_id = projectSelect.value;
      if (!project_id) { showToast('Select a project first'); return; }
      const year = yearInput.value || new Date().getFullYear();
      const month = monthSelect.value || (new Date()).getMonth() + 1;
      const search = (searchIom && searchIom.value) ? searchIom.value.trim() : '';
      const subproject_id = subprojectSelect.value || '';

      const params = new URLSearchParams({ project_id, year, month });
      if (search) params.set('search', search);
      if (subproject_id) params.set('subproject_id', subproject_id);

      iomsDropdown.innerHTML = '<option value="">Loading IOMs...</option>';
      const res = await fetch(GET_IOMS_URL + '?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();
      if (!data || !data.ok) {
        iomsDropdown.innerHTML = '<option value="">-- Failed to load --</option>';
        showToast('Failed to load IOMs');
        return;
      }
      iomsDropdown.innerHTML = '<option value="">-- Choose IOM --</option>';
      (data.ioms || []).forEach(iom => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(iom);
        opt.textContent = `${iom.iom_id} · Dept:${iom.department || '-'} · Hrs:${(parseFloat(iom.month_hours||0)).toFixed(2)}`;
        iomsDropdown.appendChild(opt);
      });

      // reload subprojects for the chosen project and preserve selection
      await loadSubprojects(project_id, subprojectSelect.value || '');
      showToast('IOMs loaded', 1200);
    } catch (err) {
      console.error('loadIoms', err);
      iomsDropdown.innerHTML = '<option value="">-- Error loading --</option>';
      showToast('Error loading IOMs');
    }
  }

  // ----- Fetch canonical IOM details (server authoritative) -----
  async function fetchIomDetails(iom_row_id) {
    try {
      const project_id = projectSelect.value;
      if (!project_id || !iom_row_id) { showToast('Select project and IOM'); return; }
      const year = yearInput.value || (new Date()).getFullYear();
      const month = monthSelect.value || (new Date()).getMonth() + 1;
      const subproject_id = subprojectSelect.value || '';

      const params = new URLSearchParams({ project_id, iom_row_id, year, month });
      if (subproject_id) params.set('subproject_id', subproject_id);

      const res = await fetch(GET_IOM_DETAILS_URL + '?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();
      if (!data || !data.ok || !data.iom) {
        showToast('Could not fetch IOM details');
        console.warn('get_iom_details', data);
        return;
      }

      CURRENT_IOM = data.iom;
      BILLING_HOURS = parseFloat(CURRENT_IOM.month_limit || DEFAULT_BILLING_HOURS) || DEFAULT_BILLING_HOURS;

      // populate header UI - preserve consistent fallback '—'
      iomDetailWrap.style.display = 'block';
      safeText(iomTitle, CURRENT_IOM.iom_id || '—');
      // project name displayed from selected project option text if available
      safeText(iomProjectName, projectSelect.selectedOptions?.[0]?.text || '—');
      safeText(iomProjectName, projectSelect.selectedOptions?.[0]?.text || '—');
        safeText(iomDept, CURRENT_IOM.department || '—');
        safeText(iomBuyerWbs, CURRENT_IOM.buyer_wbs_cc || '—');
        safeText(iomSellerWbs, CURRENT_IOM.seller_wbs_cc || '—');
        safeText(iomSite, CURRENT_IOM.site || '—');
        safeText(iomFunction, CURRENT_IOM.function || '—');


      safeText(iomMonthFte, (CURRENT_IOM.month_fte || 0).toFixed ? (CURRENT_IOM.month_fte || 0).toFixed(2) : String(CURRENT_IOM.month_fte || 0));
      safeText(iomMonthHrs, (CURRENT_IOM.month_hours || 0).toFixed(2));
      safeText(iomRemFte, (CURRENT_IOM.remaining_fte || 0).toFixed(2));
      safeText(iomRemHrs, (CURRENT_IOM.remaining_hours || 0).toFixed(2));
      safeText(remainingBadge, `Remaining: ${(CURRENT_IOM.remaining_hours || 0).toFixed(2)}h`);

      // load saved allocations for this IOM (include subproject)
      await loadSavedAllocations(CURRENT_IOM.iom_id);
    } catch (err) {
      console.error('fetchIomDetails', err);
      showToast('Failed to fetch IOM details');
    }
  }

  // ----- Load saved allocations for an IOM (respects subproject_id) -----
  async function loadSavedAllocations(iom_id) {
    try {
      if (!iom_id) return;
      const project_id = projectSelect.value;
      // If CURRENT_IOM.billing_start is set, use it; fall back to the month input if needed
      const month_start = (CURRENT_IOM && CURRENT_IOM.billing_start) ? CURRENT_IOM.billing_start : (monthSelect ? monthSelect.value : '');
      const subproject_id = subprojectSelect.value || '';

      const params = new URLSearchParams({ project_id, iom_row_id: iom_id, month_start });
      if (subproject_id) params.set('subproject_id', subproject_id);

      const res = await fetch(GET_SAVED_ALLOC_URL + '?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();

      if (!data || !data.ok) {
        // Support both styles where server may return ok:false or HTTP 200 with rows
        // If server returned rows without ok flag, continue below (we will normalize)
        if (!data || (data.ok === false && !data.rows && !data.saved_items)) {
          showToast('Failed to load saved allocations');
          console.warn('get_allocations_for_iom', data);
          return;
        }
      }

      // Normalize server response: allow either { saved_items: [...] } OR { rows: [...] }
      // rows[] may contain full row objects; convert to expected { user_ldap, total_hours, fte }
      let saved = [];
      if (Array.isArray(data.saved_items)) {
        saved = data.saved_items;
      } else if (Array.isArray(data.rows)) {
        // rows may have month_start as ISO string; total_hours may be Decimal or string
        for (const r of data.rows) {
          const user = r.user_ldap || r.user || '';
          let th = r.total_hours;
          if (th === null || th === undefined) th = 0;
          // ensure numeric
          th = (typeof th === 'string') ? parseFloat(th) || 0 : (Number(th) || 0);
          // compute FTE if server didn't include it but returned month_start
          let fte = r.fte;
          if ((fte === undefined || fte === null) && r.month_start) {
            const billingHours = parseFloat(BILLING_HOURS) || DEFAULT_BILLING_HOURS;
            fte = billingHours > 0 ? (th / billingHours) : 0;
            fte = Number(fte.toFixed(4));
          }
          saved.push({ user_ldap: user, total_hours: th, fte: fte });
        }
      } else if (data.saved_items && typeof data.saved_items === 'object') {
        // defensive: saved_items might be object with keys — convert values to array
        saved = Object.values(data.saved_items).flat();
      }

      // populate allocation table
      allocBody.innerHTML = '';
      if (saved.length) {
        for (const it of saved) {
          const row = createAllocRow(it.user_ldap || '', it.total_hours || 0);
          // set fte if server provided or computed above
          const fteInput = row.querySelector('.fte-display');
          if (fteInput && (it.fte !== undefined && it.fte !== null)) {
            fteInput.value = parseFloat(it.fte).toFixed(4);
          }
          allocBody.appendChild(row);
        }
      } else {
        clearAllocRows();
      }
      validateAll();
    } catch (err) {
      console.error('loadSavedAllocations', err);
      showToast('Failed to load saved allocations');
    }
  }

  // ----- Save allocations ----- (small addition to handle different response shapes)
  async function saveAllocations() {
    try {
      if (!CURRENT_IOM) { showToast('Select IOM first'); return; }
      if (!validateAll()) { alert('Fix validation errors before saving'); return; }

      const project_id = projectSelect.value;
      const subproject_id = subprojectSelect.value || null;
      const month_start = (CURRENT_IOM && CURRENT_IOM.billing_start) ? CURRENT_IOM.billing_start : null;

      const rows = Array.from(allocBody.querySelectorAll('tr.alloc-row'));
      const items = [];
      for (const r of rows) {
        const user = (r.querySelector('.user-ldap') || {}).value || '';
        const hrs = parseFloat((r.querySelector('.hours-input') || {}).value || 0) || 0;
        if (user && hrs > 0) {
          items.push({ iom_id: CURRENT_IOM.iom_id, user_ldap: user, total_hours: hrs });
        }
      }
      if (!items.length) { showToast('Add at least one resource'); return; }

      const payload = { project_id, subproject_id, month_start, items };
      const res = await fetch(SAVE_ALLOC_URL, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data || (data.ok === false && !data.saved_items && !data.rows)) {
        console.warn('save_monthly_allocations', data);
        alert('Save failed: ' + (data.error || 'server error'));
        return;
      }

      // Normalize response and refresh UI from server data (use the newer loadSavedAllocations to re-fetch)
      // If server returned saved_items or rows directly, populate immediately; otherwise re-fetch canonical data.
      if (Array.isArray(data.saved_items) || Array.isArray(data.rows)) {
        // Use the same normalization as loadSavedAllocations (we can reuse it by calling loadSavedAllocations)
        await loadSavedAllocations(CURRENT_IOM.iom_id);
      } else {
        // fallback: re-fetch server canonical response
        await loadSavedAllocations(CURRENT_IOM.iom_id);
      }

      showToast('Allocations saved', 2000);
    } catch (err) {
      console.error('saveAllocations', err);
      alert('Save failed: ' + (err && err.message ? err.message : 'unknown error'));
    }
  }
  // ----- Export allocations -----
  function exportAllocations() {
    if (!CURRENT_IOM) { showToast('Select IOM first'); return; }
    const params = new URLSearchParams({
      project_id: projectSelect.value,
      iom_id: CURRENT_IOM.iom_id,
      month_start: (CURRENT_IOM.billing_start || '')
    });
    if (subprojectSelect.value) params.set('subproject_id', subprojectSelect.value);
    // open export in new tab to trigger file download
    window.open(EXPORT_URL + '?' + params.toString(), '_blank');
  }

  // ----- Event bindings -----
  // Load subprojects on project change
  if (projectSelect) {
    projectSelect.addEventListener('change', async () => {
      const pid = projectSelect.value;
      // clear current IOM selections/UI
      CURRENT_IOM = null;
      iomDetailWrap.style.display = 'none';
      clearAllocRows();
      iomsDropdown.innerHTML = '<option value="">-- Load IOMs then select --</option>';
      await loadSubprojects(pid, '');
    });
  }

  if (loadIomsBtn) loadIomsBtn.addEventListener('click', loadIoms);
  if (iomsDropdown) {
    iomsDropdown.addEventListener('change', function () {
      if (!this.value) {
        CURRENT_IOM = null;
        iomDetailWrap.style.display = 'none';
        clearAllocRows();
        return;
      }
      try {
        const obj = JSON.parse(this.value);
        fetchIomDetails(obj.iom_id);
      } catch (err) {
        console.error('invalid iom dropdown value', err);
      }
    });
  }
  if (addIomBtn) addIomBtn.addEventListener('click', () => {
    if (!iomsDropdown.value) { showToast('Choose an IOM to add'); return; }
    try {
      const obj = JSON.parse(iomsDropdown.value);
      fetchIomDetails(obj.iom_id);
    } catch (err) {
      console.error('addIomBtn', err);
    }
  });

  // Add Resource button — now works: appends an editable row and focuses user input
  if (addResourceBtn) {
    addResourceBtn.addEventListener('click', (e) => {
      // if empty-state present, remove it
      const empty = allocBody.querySelector('tr.empty-state');
      if (empty) empty.remove();
      const row = createAllocRow('', 0);
      allocBody.appendChild(row);
      const u = row.querySelector('.user-ldap');
      if (u) {
        u.focus();
        u.select && u.select();
      }
      validateAll();
    });
  }

  // Save / Export
  if (saveBtn) saveBtn.addEventListener('click', saveAllocations);
  if (exportBtn) exportBtn.addEventListener('click', exportAllocations);

  // Recompute when month changed (billing may differ)
  if (monthSelect) monthSelect.addEventListener('change', () => {
    if (CURRENT_IOM && CURRENT_IOM.iom_id) fetchIomDetails(CURRENT_IOM.iom_id);
    else validateAll();
  });

  // initial setup: clear rows and ensure save disabled until valid
  clearAllocRows();
  saveBtn.disabled = true;
  saveBtn.setAttribute('aria-disabled', 'true');

  // Load subprojects for pre-selected project on page load
  (async function init() {
    try {
      if (projectSelect && projectSelect.value) {
        await loadSubprojects(projectSelect.value, subprojectSelect.value || '');
      }
    } catch (err) {
      console.error('init', err);
    }
  })();

})();
</script>


{% endblock %}
