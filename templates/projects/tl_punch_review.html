{% extends "base.html" %}
{% load dict_extras %}
{% block content %}
<div class="container-fluid mt-4">
 <div class="row justify-content-center">
     <div class="col-lg-10 col-xl-9">
         <div class="card shadow-sm">
             <div class="card-body">
                 <h2 class="mb-4 font-weight-bold">Team Lead Punch Review</h2>
                 <form method="get" class="form-inline mb-4" autocomplete="off">
                     <label for="month" class="mr-2 font-weight-medium">Month:</label>
                     <input type="month" id="month" name="month" value="{{ month_str }}" class="form-control mr-2" onchange="this.form.submit()" style="max-width: 200px;" aria-label="Select month">
                 </form>
                 <div class="accordion" id="reporteeAccordion">
                     {% for rep in reportees %}
                     <div class="card mb-2 border-0 shadow-xs">
                         <div class="card-header bg-light d-flex justify-content-between align-items-center" id="heading-{{ rep.ldap }}">
                             <span>
                                 <strong class="text-dark">{{ rep.cn }}</strong>
                                 <small class="text-muted">&lt;{{ rep.mail }}&gt;</small>
                                 <span class="badge badge-info ml-2">FTE: {{ fte_totals|get_item:rep.ldap|floatformat:2 }}</span>
                             </span>
                             <button class="btn btn-sm btn-outline-primary expand-btn" type="button"
                                 data-toggle="collapse"
                                 data-target="#collapse-{{ rep.ldap }}"
                                 aria-expanded="false"
                                 aria-controls="collapse-{{ rep.ldap }}"
                                 aria-label="Expand or collapse reportee section"
                             >
                                 <span class="fa fa-chevron-down" aria-hidden="true"></span>
                                 <span class="expand-text">Expand</span>
                             </button>
                         </div>
                         <div id="collapse-{{ rep.ldap }}" class="collapse" data-parent="#reporteeAccordion">
                             <div class="card-body bg-white">
                                 {% with rep_punch_rows=punch_rows|get_item:rep.ldap %}
                                 {% if rep_punch_rows %}
                                 <div class="table-responsive">
                                     <table class="table table-bordered table-sm punch-table-modern mb-0">
                                         <thead class="thead-light">
                                             <tr>
                                                 <th scope="col">
                                                     <input type="checkbox" class="select-all" data-rep="{{ rep.ldap }}" aria-label="Select all for {{ rep.cn }}">
                                                 </th>
                                                 <th scope="col">Project</th>
                                                 <th scope="col">Subproject</th>
                                                 <th scope="col">Week</th>
                                                 <th scope="col">Allocated</th>
                                                 <th scope="col">Punched</th>
                                                 <th scope="col">Leave</th>
                                                 <th scope="col">Status</th>
                                                 <th scope="col">Action</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                                         {% for row in rep_punch_rows %}
                                         <tr>
                                             <td>
                                                 <input type="checkbox" class="row-select" data-rep="{{ rep.ldap }}" data-punch-id="{{ row.punch_id }}" aria-label="Select row for punch {{ row.punch_id }}">
                                             </td>
                                             <td>{{ row.project_name|default:"None" }}</td>
                                             <td>{{ row.subproject_name|default:"None" }}</td>
                                             <td>W{{ row.week_number }}</td>
                                             <td>{{ row.allocated_hours|default:"" }}</td>
                                             <td>
                                                 <input type="number" step="0.01" min="0" class="form-control form-control-sm punch-input"
                                                     value="{{ row.punched_hours|default_if_none:'' }}"
                                                     data-punch-id="{{ row.punch_id }}"
                                                     data-week="{{ row.week_number }}"
                                                     style="width:80px;"
                                                     {% if row.status == "APPROVED" %}readonly{% endif %}
                                                     aria-label="Punched hours for week {{ row.week_number }}"
                                                 >
                                             </td>
                                             <td>
                                                 {{ row.leave_hours|default_if_none:"" }}
                                             </td>
                                             <td>
                                                 {{ row.status|default:"" }}
                                             </td>
                                             <td>
                                                 {% if row.status == "APPROVED" %}
                                                     <button class="btn btn-light btn-sm approve-btn approved-inactive" disabled aria-disabled="true" tabindex="-1">
                                                         <span class="fa fa-check-circle text-success mr-1" aria-hidden="true"></span>
                                                         <strong>Approved</strong>
                                                     </button>
                                                 {% else %}
                                                     <button class="btn btn-primary btn-sm approve-btn font-weight-bold" data-punch-id="{{ row.punch_id }}" type="button">
                                                         <span class="fa fa-check mr-1" aria-hidden="true"></span>
                                                         Approve
                                                     </button>
                                                 {% endif %}
                                             </td>
                                         </tr>
                                         {% endfor %}
                                         </tbody>
                                     </table>
                                     <button class="btn bulk-approve mt-4 mb-2 px-4 fw-semibold float-end d-flex align-items-center gap-2 shadow-sm"
                                             data-rep="{{ rep.ldap }}" type="button">
                                         <span class="fa fa-check-circle text-primary" style="font-size:1.2em;" aria-hidden="true"></span>
                                         <span class="text-dark">Approve Selected</span>
                                     </button>
                                 </div>
                                 {% else %}
                                 <div class="text-muted py-3">No punch data for this reportee.</div>
                                 {% endif %}
                                 {% endwith %}
                             </div>
                         </div>
                     </div>
                     {% endfor %}
                 </div>
             </div>
         </div>
     </div>
 </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
 // Accordion expand/collapse
 document.querySelectorAll(".expand-btn").forEach(function(btn) {
     btn.addEventListener("click", function() {
         var target = document.querySelector(btn.getAttribute("data-target"));
         var icon = btn.querySelector(".fa");
         var text = btn.querySelector(".expand-text");
         var expanded = target.classList.contains("show");
         // Collapse all others
         document.querySelectorAll(".collapse.show").forEach(function(open) {
             if (open !== target) open.classList.remove("show");
         });
         if (expanded) {
             target.classList.remove("show");
             icon.classList.remove("fa-chevron-up");
             icon.classList.add("fa-chevron-down");
             text.textContent = "Expand";
             btn.setAttribute("aria-expanded", "false");
         } else {
             target.classList.add("show");
             icon.classList.remove("fa-chevron-down");
             icon.classList.add("fa-chevron-up");
             text.textContent = "Collapse";
             btn.setAttribute("aria-expanded", "true");
         }
     });
 });

 // Approve button handler
 document.querySelectorAll(".approve-btn").forEach(function(btn) {
     btn.addEventListener("click", function(e) {
         if (btn.hasAttribute("disabled")) return;
         var punchId = btn.getAttribute("data-punch-id");
         var input = document.querySelector('.punch-input[data-punch-id="' + punchId + '"]');
         var punchedHours = input.value;
         if (punchedHours === "" || isNaN(punchedHours) || Number(punchedHours) < 0) {
             alert("Please enter a valid punched hours value.");
             return;
         }
         var comments = prompt("Optional: Add comments for approval", "");
         btn.disabled = true;
         fetch("{% url 'projects:tl_punch_approve' %}", {
             method: "POST",
             headers: {
                 "X-CSRFToken": "{{ csrf_token }}",
                 "Content-Type": "application/json"
             },
             body: JSON.stringify({
                 punch_id: punchId,
                 punched_hours: punchedHours,
                 comments: comments
             })
         }).then(resp => resp.json()).then(data => {
             if (data.ok) {
                 input.setAttribute("readonly", "readonly");
                 var statusCell = btn.closest("td").previousElementSibling;
                 if (statusCell) {
                     statusCell.textContent = "APPROVED";
                 }
                 btn.remove();
             } else {
                 alert("Error: " + (data.error || "Approval failed."));
                 btn.disabled = false;
             }
         }).catch(function() {
             alert("Network error. Please try again.");
             btn.disabled = false;
         });
     });
 });

 // Select all checkboxes
 document.querySelectorAll(".select-all").forEach(function(selectAll) {
     selectAll.addEventListener("change", function() {
         var rep = selectAll.getAttribute("data-rep");
         document.querySelectorAll('.row-select[data-rep="' + rep + '"]').forEach(function(cb) {
             cb.checked = selectAll.checked;
         });
     });
 });

 // Bulk approve
 document.querySelectorAll(".bulk-approve").forEach(function(btn) {
     btn.addEventListener("click", function() {
         var rep = btn.getAttribute("data-rep");
         var punchIds = Array.from(document.querySelectorAll('.row-select[data-rep="' + rep + '"]:checked'))
             .map(cb => cb.getAttribute("data-punch-id"));
         if (punchIds.length === 0) {
             alert("Select at least one row to approve.");
             return;
         }
         btn.disabled = true;
         fetch("{% url 'projects:tl_punch_bulk_approve' %}", {
             method: "POST",
             headers: {
                 "X-CSRFToken": "{{ csrf_token }}",
                 "Content-Type": "application/json"
             },
             body: JSON.stringify({ punch_ids: punchIds })
         }).then(resp => resp.json()).then(data => {
             if (data.ok) {
                 punchIds.forEach(function(id) {
                     var row = document.querySelector('.row-select[data-punch-id="' + id + '"]').closest("tr");
                     var approveBtn = row.querySelector(".approve-btn");
                     if (approveBtn) approveBtn.remove();
                     row.querySelector("td:nth-last-child(2)").textContent = "APPROVED";
                     var input = row.querySelector(".punch-input");
                     if (input) input.setAttribute("readonly", "readonly");
                 });
             } else {
                 alert("Error in bulk approval: " + (data.error || ""));
             }
             btn.disabled = false;
         }).catch(function() {
             alert("Network error. Please try again.");
             btn.disabled = false;
         });
     });
 });

 // Keyboard accessibility for checkboxes and buttons
 document.querySelectorAll("input[type=checkbox], button").forEach(function(el) {
     el.addEventListener("keyup", function(e) {
         if (e.key === "Enter" || e.key === " ") {
             el.click();
         }
     });
 });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
body {
 background: #f5f7fa;
 font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
 color: #222;
}
.container-fluid {
 margin-top: 2.5rem;
}
.card {
 border-radius: 16px;
 box-shadow: 0 2px 12px rgba(31, 111, 235, 0.07), 0 1.5px 4px rgba(0,0,0,0.04);
 border: none;
 background: #fff;
}
.card-header {
 background: #f3f6fa;
 border-radius: 16px 16px 0 0;
 padding: 1.1rem 1.5rem;
 font-size: 1.08rem;
 font-weight: 600;
 border-bottom: 1px solid #e3e8ee;
}
.card-body {
 border-radius: 0 0 16px 16px;
 padding: 2rem 1.5rem 1.5rem 1.5rem;
}
h2 {
 font-size: 2rem;
 font-weight: 700;
 color: #1f6feb;
 margin-bottom: 1.5rem;
}
.form-inline label {
 font-size: 1.08rem;
 font-weight: 500;
 margin-right: 0.5rem;
}
input[type="month"] {
 border: 1px solid #d1d9e6;
 border-radius: 6px;
 padding: 0.35rem 0.7rem;
 font-size: 1.05rem;
 background: #f8fafc;
 transition: border 0.2s;
 margin-right: 0.5rem;
}
input[type="month"]:focus {
 border-color: #1f6feb;
 outline: none;
}
.accordion .card {
 margin-bottom: 0.7rem;
 border-radius: 14px;
}
.accordion .card-header {
 background: #f8fafd;
 border-radius: 14px 14px 0 0;
 font-size: 1.08rem;
 font-weight: 600;
 color: #1f2937;
 display: flex;
 align-items: center;
 justify-content: space-between;
 padding: 1rem 1.3rem;
}
.accordion .card-header strong {
 font-weight: 700;
 color: #1f6feb;
 font-size: 1.08rem;
 letter-spacing: 0.01em;
}
.accordion .card-header small {
 color: #6b7280;
 font-size: 0.98rem;
 margin-left: 0.5rem;
}
.accordion .btn-outline-primary {
 border: 1.5px solid #1f6feb;
 color: #1f6feb;
 background: #f8fafc;
 border-radius: 6px;
 padding: 0.25rem 0.9rem;
 font-weight: 500;
 transition: background 0.2s, color 0.2s;
}
.accordion .btn-outline-primary:hover, .accordion .btn-outline-primary:focus {
 background: #1f6feb;
 color: #fff;
 outline: none;
}
.collapse .card-body {
 background: #fff;
 border-radius: 0 0 14px 14px;
 padding: 1.2rem 1.3rem 1.1rem 1.3rem;
}
.table-responsive {
 margin-top: 0.7rem;
}
.punch-table-modern {
 background: #fff;
 border-radius: 18px;
 box-shadow: 0 2px 16px rgba(31,111,235,0.08), 0 1.5px 4px rgba(0,0,0,0.04);
 overflow: hidden;
 margin-bottom: 1.5rem;
 font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
}
.punch-table-modern th, .punch-table-modern td {
 font-size: 15px;
 text-align: center;
 vertical-align: middle;
}
.punch-table-modern th {
 background: linear-gradient(90deg, #6a8dff 0%, #4f6bed 100%);
 color: #fff;
 font-weight: 600;
 font-size: 1.06rem;
 border: none;
 padding: 0.85rem 0.7rem;
 letter-spacing: 0.01em;
}
.punch-table-modern td {
 background: #fff;
 color: #222;
 font-size: 1.04rem;
 border-top: 1px solid #f0f3fa;
 padding: 0.75rem 0.7rem;
 vertical-align: middle;
 transition: background 0.2s;
}
.punch-table-modern tr:hover td {
 background: #f5f8ff;
}
.punch-input {
 width: 80px;
 border: 1px solid #d1d9e6;
 border-radius: 5px;
 padding: 0.25rem 0.5rem;
 font-size: 1.01rem;
 background: #f8fafc;
 transition: border 0.2s;
}
.punch-input:focus {
 border-color: #1f6feb;
 background: #eaf1fb;
 outline: none;
}
.punch-input[readonly] {
 background: #e9ecef;
 color: #6b7280;
 border-color: #d1d9e6;
}
.bulk-approve {
 background: #eaf1fb;
 color: #1f2937;
 border: none;
 border-radius: 24px;
 font-size: 1.04rem;
 letter-spacing: 0.01em;
 box-shadow: 0 2px 8px 8px rgba(31,111,235,0.10);
 transition: background 0.2s, box-shadow 0.2s;
 margin-right: 0.5rem;
 padding-top: 0.45rem;
 padding-bottom: 0.45rem;
}
.bulk-approve:active, .bulk-approve:focus {
 outline: none;
 box-shadow: 0 0 0 2px #b6d4fe;
}
.approved-inactive {
 background: #e6f4ea !important;
 color: #198754 !important;
 border: 1.5px solid #b6e2c6 !important;
 font-weight: 700;
 opacity: 1 !important;
 cursor: not-allowed;
}
.btn-primary.btn-sm.approve-btn {
 background: #1f6feb;
 border: none;
 color: #fff;
 font-weight: 700;
 border-radius: 5px;
 padding: 0.25rem 1.1rem;
 font-size: 1.01rem;
 box-shadow: 0 1px 4px rgba(31,111,235,0.08);
 transition: background 0.2s;
}
.btn-primary.btn-sm.approve-btn:hover, .btn-primary.btn-sm.approve-btn:focus {
 background: #155ab6;
 outline: none;
}
.text-muted {
 color: #6b7280 !important;
 font-size: 1.01rem;
}
.shadow-xs {
 box-shadow: 0 1.5px 6px rgba(31, 111, 235, 0.08);
}
@media (max-width: 991px) {
 .container-fluid {
     margin-top: 1.2rem;
 }
 .card-body, .collapse .card-body {
     padding: 1.1rem 0.7rem 1rem 0.7rem;
 }
 .card-header {
     padding: 0.8rem 0.7rem;
 }
 h2 {
     font-size: 1.4rem;
 }
}
</style>
{% endblock %}