{% extends "base.html" %}
{% load dict_extras %}
{% block content %}
<input type="hidden" id="hiddenMonthStart" value="{{ billing_start|date:'Y-m-d' }}">
<input type="hidden" id="hiddenWeeksData" value="{{ all_weeks_list_json }}">
<div class="feas-tl-review-bg">
  <div class="feas-tl-review-container">
    <div class="action-bar">
        <div class="page-title">
            <h2 style="color:#fff !important;">Team Lead Punch Review</h2>

            <!-- Example button group -->
            <div class="button-group">
              <button id="global-expand-btn" class="feas-btn1 feas-btn1-blue">
                <i class="fas fa-plus"></i> Show/Hide All
              </button>
              <button id="btnAddAllocation" class="feas-btn1 feas-btn1-orange">
                <i class="fas fa-plus-circle"></i> Add Allocation
              </button>
            </div>
        </div>
         <form method="get" class="feas-tl-review-form" autocomplete="off" style="display: flex; align-items: center; gap: 1.2rem;">
          <label for="month">Month:</label>
          <input type="month" id="month" name="month" value="{{ month_str }}" onchange="this.form.submit()" aria-label="Select month">
          <label for="weekSelector" style="font-weight: 600; margin-left: 20px; margin-right: 8px;">Week:</label>
          <select id="weekSelector" name="week" style="padding: 8px 16px; border-radius: 8px;">
            <option value="all" {% if selected_week == 'all' %}selected{% endif %}>All Weeks</option>
            {% for week in weeks_list %}
              <option value="{{ week.num }}"
                {% if selected_week|stringformat:"s" == week.num|stringformat:"s" %}selected{% endif %}>
                Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}
                {% if week.num == current_week %}★{% endif %}
              </option>
            {% endfor %}
          </select>
        </form>

      </div>

      <div class="accordion" id="reporteeAccordion">
        {% for rep in reportees %}
        <div class="feas-tl-review-reportee-card">
          <div class="feas-tl-review-reportee-header" id="heading-{{ rep.ldap }}">
            <div>
              <span class="feas-tl-review-reportee-name">{{ rep.cn }}</span>
              <span class="feas-tl-review-reportee-mail">&lt;{{ rep.mail }}&gt;</span>
              <span class="feas-tl-review-fte">FTE: {{ fte_totals|get_item:rep.ldap|floatformat:2 }}</span>
            </div>
            <button class="feas-btn feas-btn-outline expand-btn" type="button"
              data-target="#collapse-{{ rep.ldap }}"
              aria-expanded="false"
              aria-controls="collapse-{{ rep.ldap }}"
              aria-label="Expand or collapse reportee section"
            >
              <span class="fa fa-plus expand-icon" aria-hidden="true"></span>
            </button>
          </div>
          <div id="collapse-{{ rep.ldap }}" class="collapse{% if expand_all %} show{% endif %}" data-parent="#reporteeAccordion" {% if not expand_all %}style="display: none;"{% endif %}>
            <div class="feas-tl-review-table-card">
              {% with rep_grouped=grouped|get_item:rep.ldap %}
              {% if rep_grouped %}
              <div class="table-responsive">
                <table class="feas-tl-review-table">
                  <thead>
                    <tr>
                      <th>
                        <input type="checkbox" class="select-all" data-rep="{{ rep.ldap }}" aria-label="Select all rows for {{ rep.cn }}">
                      </th>
                      <th>Week #</th>
                      <th>Project</th>
                      <th>Subproject</th>
                      {% if not is_eu_user %}
                        <th>TL Allocation</th>
                        <th>Act. Effort</th>
                      {% endif %}
                      {% for day in day_names %}
                        <th>
                          {% if is_eu_user %}
                            {{ day }}%
                          {% else %}
                            {{ day }}
                          {% endif %}
                        </th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for week_number, week_data in rep_grouped.items %}
                      {% for project, project_data in week_data.items %}
                        {% for subproject, punch_row in project_data.items %}
                          {% with statuses=punch_row.punch_list|map_filter:"status" %}
                          <tr>
                            <td>
                              <input type="checkbox" class="row-select"
                                  data-rep="{{ rep.ldap }}"
                                  data-punch-ids="{% for punch in punch_row.punch_list %}{{ punch.punch_id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                  aria-label="Select row for all punches in this week/project/subproject">
                            </td>
                            <td>W{{ week_number }}</td>
                            <td>{{ project }}</td>
                            <td>{{ subproject }}</td>
                            {% if not is_eu_user %}
                              <td>{{ punch_row.punch_list.0.tl_allocation|default:"0" }}</td>
                              <td>{{ punch_row.punch_list.0.act_effort|default:"0" }}</td>
                            {% endif %}
                            {% for day in day_names %}
                            <td>
                              {% with punch=punch_row.punches_by_day|get_item:day %}
                                {% if punch %}
                                  <div class="feas-tl-review-punch-cell
                                    {% if punch.status == 'APPROVED' %}approved
                                    {% elif punch.status == 'SUBMITTED' %}submitted
                                    {% elif punch.status == 'DRAFT' %}draft
                                    {% else %}other
                                    {% endif %}">
                                    <input type="number" step="0.01" min="0" class="feas-tl-review-punch-input
                                      {% if punch.status == 'APPROVED' %}status-approved
                                      {% elif punch.status == 'SUBMITTED' %}status-submitted
                                      {% elif punch.status == 'REJECTED' %}status-rejected
                                      {% elif punch.status == 'DRAFT' %}status-draft
                                      {% else %}status-other
                                      {% endif %}"
                                      value="{{ punch.punched_hours|default_if_none:'' }}"
                                      data-punch-id="{{ punch.punch_id }}"
                                      data-week="{{ week_number }}"
                                      {% if punch.status == "APPROVED" %}readonly{% endif %}
                                      aria-label="Punched hours for {{ punch.date|date:'Y-m-d' }}"
                                    >
                                  </div>
                                {% else %}
                                  <div class="feas-tl-review-punch-cell other"></div>
                                {% endif %}
                              {% endwith %}
                            </td>
                            {% endfor %}
                          </tr>
                          {% endwith %}
                        {% endfor %}
                      {% endfor %}
                      <tr class="feas-tl-review-week-separator">
                        <td colspan="14"></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="feas-tl-review-table-actions">
                  <button class="feas-btn feas-btn-approve bulk-approve" data-rep="{{ rep.ldap }}" type="button">
                    <span class="fa fa-check-circle" aria-hidden="true"></span>
                    Approve Selected
                  </button>
                </div>
              </div>
              {% else %}
              <div class="feas-tl-review-no-data">No punch data for this reportee.</div>
              {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
<!-- Add Allocation Modal (Redesigned for Day-wise Punching) -->
<div id="addAllocationModal" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-header">
            <h4 class="modal-title">
                <i class="fas fa-plus-circle"></i>
                Add Self Allocation
            </h4>
            <button class="modal-close" id="btnModalClose" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-section">
                <div class="form-section-title">
                <i class="fas fa-users"></i>
                Reportee Selection
            </div>
            <div class="form-group">
                <label for="modalReportee">
                    Reportee <span style="color: #e53e3e;">*</span>
                </label>
                <select id="modalReportee" required>
                    <option value="">Select Reportee...</option>
                    {% for rep in reportees %}
                        <option value="{{ rep.ldap }}">{{ rep.cn }} &lt;{{ rep.mail }}&gt;</option>
                    {% endfor %}
                </select>
            </div>
                <div class="form-section-title">
                    <i class="fas fa-project-diagram"></i>
                    Project Selection
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalProject">
                            Project <span style="color: #e53e3e;">*</span>
                        </label>
                        <select id="modalProject" required>
                            <option value="">Select Project...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalSubproject">
                            Subproject <span style="color: #e53e3e;">*</span>
                        </label>
                        <select id="modalSubproject" disabled required>
                            <option value="">Select Subproject...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-calendar-week"></i>
                    Day-wise Effort Punching
                </div>
                <div class="form-group">
                    <label for="modalWeekSelector">Select Week</label>
                    <select id="modalWeekSelector" required>
                        <option value="">Select Week...</option>
                        {% for week in all_weeks_list %}
                        <option value="{{ week.num }}">
                            Week {{ week.num }}: {{ week.start|date:"M d" }} - {{ week.end|date:"M d" }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <table class="week-allocation-table" id="modalDayTable">
                    <thead>
                    <tr>
                        <th style="width: 30%;">Day</th>
                        <th style="width: 40%;">Date</th>
                        <th style="width: 30%;">Effort (hours)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Populated by JS based on selected week -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" id="btnModalCancel">Cancel</button>
            <button type="button" class="btn btn-primary" id="btnModalSave">Save Allocation</button>
        </div>
    </div>
</div>
{% endblock %}




{% block extra_js %}
<script>
    function showNotification(message, type) {
            const colors = {
                success: {bg: '#d5f4e6', border: '#0e7c4e', text: '#0e7c4e'},
                error: {bg: '#fadbd8', border: '#a93226', text: '#a93226'},
                warning: {bg: '#fef5e7', border: '#d68910', text: '#d68910'},
                info: {bg: '#d6eaf8', border: '#1a5490', text: '#1a5490'}
            };
            const color = colors[type] || colors.info;
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        max-width: 500px;
        background: ${color.bg};
        color: ${color.text};
        border-left: 4px solid ${color.border};
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
    `;
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            notification.innerHTML = `
        <i class="${icons[type]}" style="font-size: 20px;"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()"
                style="margin-left: auto; background: none; border: none;
                       color: ${color.text}; font-size: 20px; cursor: pointer;
                       opacity: 0.7; padding: 0; width: 24px; height: 24px;">
            ×
        </button>
    `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
document.addEventListener("DOMContentLoaded", function() {
    const btnAddAllocation = document.getElementById('btnAddAllocation');
    const modal = document.getElementById('addAllocationModal');
    const modalProject = document.getElementById('modalProject');
    const modalSubproject = document.getElementById('modalSubproject');
    const btnModalClose = document.getElementById('btnModalClose');
    const btnModalCancel = document.getElementById('btnModalCancel');

    // --- Expand/Collapse Logic ---
    function collapseAll() {
        document.querySelectorAll(".collapse").forEach(function(el) {
            el.classList.remove("show");
            el.style.display = "none";
        });
        document.querySelectorAll(".expand-btn .expand-icon").forEach(function(ic) {
            ic.classList.remove("fa-minus");
            ic.classList.add("fa-plus");
        });
    }
    function expandAll() {
        document.querySelectorAll(".collapse").forEach(function(el) {
            el.classList.add("show");
            el.style.display = "";
        });
        document.querySelectorAll(".expand-btn .expand-icon").forEach(function(ic) {
            ic.classList.remove("fa-plus");
            ic.classList.add("fa-minus");
        });
    }
    collapseAll();

    // Individual expand/collapse
    document.querySelectorAll(".expand-btn").forEach(function(btn) {
        btn.addEventListener("click", function () {
            var targetId = btn.getAttribute("data-target").replace(/^#/, "");
            var target = document.getElementById(targetId);
            if (!target) return;
            var icon = btn.querySelector(".expand-icon");
            var expanded = target.classList.contains("show") || target.style.display !== "none";
            // Collapse all others
            document.querySelectorAll(".collapse").forEach(function(el) {
                if (el !== target) {
                    el.classList.remove("show");
                    el.style.display = "none";
                }
            });
            document.querySelectorAll(".expand-btn .expand-icon").forEach(function(ic) {
                ic.classList.remove("fa-minus");
                ic.classList.add("fa-plus");
            });
            // Toggle current
            if (expanded) {
                target.classList.remove("show");
                target.style.display = "none";
                btn.setAttribute("aria-expanded", "false");
                if (icon) {
                    icon.classList.remove("fa-minus");
                    icon.classList.add("fa-plus");
                }
            } else {
                target.classList.add("show");
                target.style.display = "";
                btn.setAttribute("aria-expanded", "true");
                if (icon) {
                    icon.classList.remove("fa-plus");
                    icon.classList.add("fa-minus");
                }
            }
        });
    });

    // Global expand/collapse
    var globalBtn = document.getElementById("global-expand-btn");
    var globalState = false;
    if (globalBtn) {
        globalBtn.addEventListener("click", function() {
            globalState = !globalState;
            if (globalState) {
                expandAll();
                globalBtn.querySelector(".expand-icon").classList.remove("fa-plus");
                globalBtn.querySelector(".expand-icon").classList.add("fa-minus");
            } else {
                collapseAll();
                globalBtn.querySelector(".expand-icon").classList.remove("fa-minus");
                globalBtn.querySelector(".expand-icon").classList.add("fa-plus");
            }
        });
    }

    // Toggle punch table (if used)
    document.querySelectorAll('.toggle-punch-table').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var target = document.querySelector(btn.getAttribute('data-target'));
            var icon = btn.querySelector('.toggle-icon');
            if (target.style.display === 'none') {
                target.style.display = '';
                icon.textContent = '-';
            } else {
                target.style.display = 'none';
                icon.textContent = '+';
            }
        });
    });

    // Week selector change
    const weekSelector = document.getElementById('weekSelector');
    if (weekSelector) {
        weekSelector.addEventListener('change', function () {
            const url = new URL(window.location.href);
            url.searchParams.set('week', this.value);
            window.location.href = url.toString();
        });
    }

    // EU user percent display
    const isEuUser = {{ is_eu_user|yesno:"true,false" }};
    const HOURS_PER_DAY = 8.75;
    if (isEuUser) {
        document.querySelectorAll('.feas-tl-review-punch-input').forEach(function(input) {
            if (input.value !== '') {
                let hours = parseFloat(input.value);
                let percent = hours > 0 ? (hours / HOURS_PER_DAY) * 100 : 0;
                input.value = percent ? percent.toFixed(2) : '';
            }
            input.addEventListener('blur', function () {
                if (this.value !== '') {
                    this.value = parseFloat(this.value).toFixed(2);
                }
            });
        });
    }

    // --- Calculate and update Act. Effort for each row ---
    document.querySelectorAll(".week-row").forEach(function(row) {
        function updateActualEffort() {
            let sum = 0;
            const tlAllocationCell = row.querySelector(".tl-allocation");
            let tlAllocation = tlAllocationCell ? parseFloat(tlAllocationCell.textContent) : 0;
            row.querySelectorAll(".punch-input").forEach(function(input) {
                sum += parseFloat(input.value) || 0;
            });
            const percent = tlAllocation > 0 ? (sum / tlAllocation) * 100 : 0;
            const cell = row.querySelector(".actual-weekly-effort");
            if (cell) cell.textContent = `${sum.toFixed(2)} (${percent.toFixed(2)}%)`;
        }
        row.querySelectorAll(".punch-input").forEach(function(input) {
            input.addEventListener("input", updateActualEffort);
            input.addEventListener("blur", updateActualEffort);
        });
        updateActualEffort();
    });

    // Approve button handler
    document.querySelectorAll(".approve-btn").forEach(function(btn) {
        btn.addEventListener("click", function(e) {
            if (btn.hasAttribute("disabled")) return;
            var punchId = btn.getAttribute("data-punch-id");
            var input = document.querySelector('.punch-input[data-punch-id="' + punchId + '"]');
            var punchedHours = input.value;
            if (punchedHours === "" || isNaN(punchedHours) || Number(punchedHours) < 0) {
                alert("Please enter a valid punched hours value.");
                return;
            }
            var comments = prompt("Optional: Add comments for approval", "");
            btn.disabled = true;
            fetch("{% url 'projects:tl_punch_approve' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    punch_id: punchId,
                    punched_hours: punchedHours,
                    comments: comments
                })
            }).then(resp => resp.json()).then(data => {
                if (data.ok) {
                    input.setAttribute("readonly", "readonly");
                    var statusCell = btn.closest("td").previousElementSibling;
                    if (statusCell) {
                        statusCell.textContent = "APPROVED";
                    }
                    btn.remove();
                } else {
                    alert("Error: " + (data.error || "Approval failed."));
                    btn.disabled = false;
                }
            }).catch(function() {
                alert("Network error. Please try again.");
                btn.disabled = false;
            });
        });
    });

    // Select all checkboxes
    document.querySelectorAll(".select-all").forEach(function(selectAll) {
        selectAll.addEventListener("change", function() {
            var rep = selectAll.getAttribute("data-rep");
            document.querySelectorAll('.row-select[data-rep="' + rep + '"]').forEach(function(cb) {
                cb.checked = selectAll.checked;
            });
        });
    });

    // Bulk approve
    document.querySelectorAll('.row-select').forEach(function(weekCb) {
        weekCb.addEventListener('change', function() {
            var rep = weekCb.getAttribute('data-rep');
            var week = weekCb.getAttribute('data-week');
            var dayCheckboxes = document.querySelectorAll('.row-select[data-rep="' + rep + '"][data-week="' + week + '"]');
            dayCheckboxes.forEach(function(cb) {
                cb.checked = weekCb.checked;
            });
        });
    });
    document.querySelectorAll(".bulk-approve").forEach(function(btn) {
        btn.addEventListener("click", function() {
            var rep = btn.getAttribute("data-rep");
            var weekCheckboxes = document.querySelectorAll('.week-select[data-rep="' + rep + '"]:checked');
            var punchIds = [];
            weekCheckboxes.forEach(function(weekCb) {
                var week = weekCb.getAttribute("data-week");
                var dayPunches = document.querySelectorAll('.row-select[data-rep="' + rep + '"][data-week="' + week + '"]');
                dayPunches.forEach(function(cb) {
                    punchIds.push(cb.getAttribute("data-punch-id"));
                });
            });
            var dayChecked = document.querySelectorAll('.row-select[data-rep="' + rep + '"]:checked');
            dayChecked.forEach(function(cb) {
                var punchIdsAttr = cb.getAttribute("data-punch-ids");
                if (punchIdsAttr) {
                    punchIdsAttr.split(",").forEach(function(pid) {
                        if (pid && !punchIds.includes(pid)) punchIds.push(pid);
                    });
                }
            });

            if (punchIds.length === 0) {
                alert("Select at least one row to approve.");
                return;
            }
            btn.disabled = true;
            fetch("{% url 'projects:tl_punch_bulk_approve' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ punch_ids: punchIds })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.ok) {
                    punchIds.forEach(function(id) {
                        var rowSelect = document.querySelector('.row-select[data-punch-id="' + id + '"]');
                        if (!rowSelect) return;
                        var row = rowSelect.closest("tr");
                        if (!row) return;
                        var approveBtn = row.querySelector(".approve-btn");
                        if (approveBtn) approveBtn.remove();
                        row.querySelector("td:nth-last-child(2)").textContent = "APPROVED";
                        var input = row.querySelector(".punch-input");
                        if (input) input.setAttribute("readonly", "readonly");
                    });
                    location.reload();
                    alert(data.message || "Efforts Approved for selected weeks");
                } else {
                    alert("Error in bulk approval: " + (data.error || ""));
                }
                btn.disabled = false;
            })
            .catch(function() {
                alert("Network error. Please try again.");
                btn.disabled = false;
            });
        });
    });
    // --- Add Allocation Modal (with day-wise effort) ---
        btnAddAllocation.addEventListener('click', async function () {
            try {
                console.log('Add Allocation button clicked');
                const response = await fetch('{{ get_projects_url }}');
                console.log('Fetch response:', response);
                if (!response.ok) {
                    console.error('Network response was not ok:', response.status, response.statusText);
                }
                const data = await response.json();
                console.log('Response JSON:', data);
                if (data.ok) {
                    console.log('Projects loaded:', data.projects);
                    projectsData = data.projects;
                    modalProject.innerHTML = '<option value="">Select Project...</option>';
                    data.projects.forEach(proj => {
                        modalProject.innerHTML += `<option value="${proj.id}">${proj.name}</option>`;
                    });
                    modalSubproject.innerHTML = '<option value="">Select Subproject...</option>';
                    modalSubproject.disabled = true;
                    modal.classList.add('active');
                    setupModalWeekSelector();
                } else {
                    console.error('Backend returned ok=false:', data);
                    showNotification('Failed to load projects', 'error');
                }
            } catch (err) {
                showNotification('Failed to load projects', 'error');
                console.error('Exception in Add Allocation:', err);
            }
        });

        modalProject.addEventListener('change', function () {
            const projectId = parseInt(this.value);
            const project = projectsData.find(p => p.id === projectId);
            modalSubproject.disabled = !project;
            modalSubproject.innerHTML = '<option value="">Select Subproject...</option>';
            if (project && project.subprojects) {
                project.subprojects.forEach(sub => {
                    modalSubproject.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
            }
        });

        btnModalClose.addEventListener('click', closeModal);
        btnModalCancel.addEventListener('click', closeModal);

        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                closeModal();
            }
        });

        function closeModal() {
            modal.classList.remove('active');
        }
        function buildDaysList(week) {
            // week.start and week.end are ISO strings, convert to Date objects
            const start = new Date(week.start);
            const end = new Date(week.end);
            const days = [];
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                days.push({
                    weekday: d.toLocaleDateString('en-US', { weekday: 'short' }),
                    date: d.toISOString().slice(0, 10)
                });
            }
            return days;
        }
    // --- Modal Week Selector and Day Table ---
        function setupModalWeekSelector() {
            console.log("Setting up modal week selector");
            // Defensive: remove any previous event listeners by replacing the element
            const oldSelector = document.getElementById('modalWeekSelector');
            if (!oldSelector) return;
            const newSelector = oldSelector.cloneNode(true);
            oldSelector.parentNode.replaceChild(newSelector, oldSelector);

            // Populate week selector
            const allWeeksList = JSON.parse(document.getElementById('hiddenWeeksData').value);
            newSelector.innerHTML = '<option value="">Select Week...</option>';
            allWeeksList.forEach(w => {
                newSelector.innerHTML += `<option value="${w.num}">Week ${w.num}: ${w.start} - ${w.end}</option>`;
            });

            // Clear day table
            const dayTable = document.getElementById('modalDayTable');
            if (dayTable) {
                dayTable.querySelector('tbody').innerHTML = '';
            }

            // Attach event listener for week change
            newSelector.addEventListener('change', function () {
                console.log("Week selected:", this.value);
                const weekNum = this.value;
                const week = allWeeksList.find(w => String(w.num) === String(weekNum));
                const tbody = document.getElementById('modalDayTable').querySelector('tbody');
                tbody.innerHTML = '';
                console.log("Populating days for week:", week, weekNum);
                console.log("days_list for week:", week.days_list);
                if (week && (!week.days_list || week.days_list.length === 0)) {
                    week.days_list = buildDaysList(week);
                }
                if (week && week.days_list && week.days_list.length > 0) {
                    week.days_list.forEach(day => {
                        tbody.innerHTML += `
                    <tr>
                        <td>${day.weekday}</td>
                        <td>${day.date}</td>
                        <td>
                            <input type="number"
                                class="modal-day-effort"
                                data-date="${day.date}"
                                min="0"
                                max="24"
                                step="0.01"
                                value="0"
                                placeholder="0.00"
                                style="width: 80px; text-align: right;">
                        </td>
                    </tr>
                `;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#a0aec0;">No days found for this week</td></tr>`;
                }
            });
        }

    // Modal Save/Cancel button handlers
    document.getElementById('btnModalCancel').addEventListener('click', closeModal);
    document.getElementById('btnModalSave').addEventListener('click', async function () {
        const projectId = parseInt(document.getElementById('modalProject').value);
        const subprojectId = parseInt(document.getElementById('modalSubproject').value);
        const weekNum = parseInt(document.getElementById('modalWeekSelector').value);
        const monthStart = document.getElementById('hiddenMonthStart').value; // Get month_start
        // In btnModalSave click handler
        const reporteeLdap = document.getElementById('modalReportee').value;
        // print all above values to console for debugging
        console.log('Saving allocation with values:', {
            reporteeLdap,
            projectId,
            subprojectId,
            weekNum,
            monthStart
        });
        if (!reporteeLdap) {
            showNotification('Please select a reportee', 'warning');
            return;
        }
        if (!projectId || !subprojectId || !weekNum || !monthStart) {
            showNotification('Please select project, subproject, week, and ensure billing period is set', 'warning');
            return;
        }

        const days = [];
        document.querySelectorAll('.modal-day-effort').forEach(input => {
            const hours = parseFloat(input.value) || 0;
            if (hours > 0) {
                days.push({
                    punch_date: input.dataset.date,
                    punched_hours: hours
                });
            }
        });
        if (days.length === 0) {
            showNotification('Please enter effort for at least one day', 'warning');
            return;
        }

        const totalHours = days.reduce((sum, d) => sum + d.punched_hours, 0);
        console.log('Total hours calculated:', totalHours);

        // Get allWeeksList from hidden input
        const allWeeksList = JSON.parse(document.getElementById('hiddenWeeksData').value);
        const week = allWeeksList.find(w => String(w.num) === String(weekNum));

        let daysList = [];
        if (week) {
            // If days_list is missing or empty, build it from start/end
            if (!week.days_list || week.days_list.length === 0) {
                const start = new Date(week.start);
                const end = new Date(week.end);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    daysList.push({ date: d.toISOString().slice(0, 10) });
                }
            } else {
                daysList = week.days_list;
            }
        }

        let workingDays = 0;
        if (daysList.length > 0) {
            workingDays = daysList.filter(day => {
                const d = new Date(day.date);
                return d.getDay() !== 0 && d.getDay() !== 6; // Mon-Fri
            }).length;
        }
        console.log('Working days in selected week:', workingDays);
        const percent = workingDays > 0 ? (totalHours / (8.75 * workingDays)) * 100 : 0;
        console.log('Percent calculated:', percent);

        const payload = {
            reportee_ldap: reporteeLdap,
            project_id: projectId,
            subproject_id: subprojectId,
            month_start: monthStart,
            allocations: [{
                week_number: weekNum,
                hours: totalHours,
                percent: percent,
                days: days
            }]
        };

        try {
            const response = await fetch("{% url 'projects:add_tl_allocation' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.ok) {
                showNotification('Allocation added successfully!', 'success');
                closeModal();
                // setTimeout(() => window.location.reload(), 1500);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        } catch (err) {
            showNotification('Network error occurred', 'error');
            console.error(err);
        }
    });
    // Keyboard accessibility for checkboxes and buttons
    document.querySelectorAll("input[type=checkbox], button").forEach(function(el) {
        el.addEventListener("keyup", function(e) {
            if (e.key === "Enter" || e.key === " ") {
                el.click();
            }
        });
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    body {
      background: #f4f7fb;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      color: #232a36;
    }
    .feas-tl-review-bg {
      min-height: 100vh;
      /*background: #f4f7fb;*/
      padding: 32px 0;
    }
    .feas-tl-review-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 8px;
    }
    .feas-tl-review-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(31, 111, 235, 0.10), 0 1.5px 4px rgba(0,0,0,0.04);
      padding: 2.5rem 2.2rem 2.2rem 2.2rem;
      margin-bottom: 2.5rem;
    }
    .feas-tl-review-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.7rem;
    }
    .feas-tl-review-header h2 {
      font-size: 2.1rem;
      font-weight: 800;
      color: #1f6feb;
      margin: 0;
      letter-spacing: 0.01em;
    }
    .feas-tl-review-form {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    .feas-tl-review-form label {
      font-size: 1.08rem;
      font-weight: 600;
      color: #fff ;
    }
    .feas-tl-review-form input[type="month"] {
      border: 1.5px solid #d1d9e6;
      border-radius: 7px;
      padding: 0.38rem 0.9rem;
      font-size: 1.08rem;
      background: #f8fafc;
      transition: border 0.2s;
      min-width: 170px;
    }
    .feas-tl-review-form input[type="month"]:focus {
      border-color: #1f6feb;
      outline: none;
    }
    .feas-tl-review-reportee-card {
      background: #f8fafd;
      border-radius: 14px;
      margin-bottom: 1rem;
      box-shadow: 0 1.5px 6px rgba(31, 111, 235, 0.07);
    }
    .feas-tl-review-reportee-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 0.8rem;
      border-radius: 14px 14px 0 0;
      font-size: 1.08rem;
      font-weight: 600;
      color: #1f2937;
      border-bottom: 1px solid #e3e8ee;
      background: #f3f6fa;
    }
    .feas-tl-review-reportee-name {
      font-weight: 600;
      color: #1f6feb;
      font-size: 0.8rem;
      letter-spacing: 0.01em;
    }
    .feas-tl-review-reportee-mail {
      color: #6b7280;
      font-size: 0.98rem;
      margin-left: 0.5rem;
    }
    .feas-tl-review-fte {
      background: #eaf1fb;
      color: #1f6feb;
      font-weight: 600;
      border-radius: 6px;
      padding: 0.18rem 0.7rem;
      font-size: 0.8rem;
      margin-left: 0.7rem;
    }
    .feas-tl-review-table-card {
      background: #fff;
      border-radius: 0 0 14px 14px;
      padding: 1.2rem 1.3rem 1.1rem 1.3rem;
    }
    .feas-tl-review-table {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 16px rgba(31,111,235,0.08), 0 1.5px 4px rgba(0,0,0,0.04);
      margin-bottom: 1.2rem;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      border-collapse: separate;
      border-spacing: 0;
    }
    .feas-tl-review-table th {
      background: linear-gradient(90deg, #6a8dff 0%, #4f6bed 100%);
      color: #fff;
      font-weight: 600;
      font-size: 0.8rem;
      border: none;
      padding: 0.4rem 0.4rem;
      letter-spacing: 0.01em;
      line-height: 1.1;
      vertical-align: middle;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .feas-tl-review-table td {
      background: #fff;
      color: #232a36;
      font-size: 0.8rem;
      border-top: 1px solid #f0f3fa;
      padding: 0.4rem 0.4rem;
      vertical-align: middle;
      transition: background 0.2s;
    }
    .feas-tl-review-table tr:hover td {
      background: #f5f8ff;
    }
    .feas-tl-review-punch-cell {
      border-radius: 7px;
      padding: 0.1rem 0.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 70px;
      min-height: 38px;
      transition: background 0.2s;
    }
    .feas-tl-review-punch-cell.approved {
      background: #e6f7e6;
      color: #1a7f37;
      font-weight: 700;
    }
    .feas-tl-review-punch-cell.submitted {
      background: #fff4e5;
      color: #b26a00;
      font-weight: 700;
    }
    .feas-tl-review-punch-cell.draft {
      background: #e6eaf7;
      color: #1a3a7f;
      font-weight: 700;
    }
    .feas-tl-review-punch-cell.other {
      background: #f8f9fa;
      color: #adb5bd;
      font-weight: 700;
    }
    .feas-tl-review-punch-input {
      width: 70px;
      border: 1.5px solid #d1d9e6;
      border-radius: 6px;
      padding: 0.22rem 0.4rem;
      font-size: 0.8rem;
      background: #f8fafc;
      transition: border 0.2s;
      text-align: center;
      font-weight: 600;
    }
    .feas-tl-review-punch-input:focus {
      border-color: #1f6feb;
      background: #eaf1fb;
      outline: none;
    }
    .feas-tl-review-punch-input[readonly] {
      background: #e9ecef;
      color: #6b7280;
      border-color: #d1d9e6;
    }
    .status-approved { background: #e6ffe6; border: 2px solid #28a745; }
    .status-submitted { background: #fffbe6; border: 2px solid #ffc107; }
    .status-rejected { background: #ffe6e6; border: 2px solid #dc3545; }
    .status-draft { background: #f0f0f0; border: 2px solid #6c757d; }
    .status-other { background: #f8f9fa; border: 2px solid #adb5bd; }
    .feas-tl-review-week-separator td {
      border-bottom: 3px solid #1f6feb !important;
      background: #f3f6fa;
      height: 8px;
      padding: 0;
    }
    .feas-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5em;
      border-radius: 7px;
      font-size: 1rem;
      font-weight: 600;
      padding: 0.45rem 1.2rem;
      cursor: pointer;
      border: none;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      box-shadow: 0 1.5px 6px rgba(31, 111, 235, 0.08);
      outline: none;
    }
    .feas-tl-review-table-actions {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-top: 1.1rem;
      margin-bottom: 0.2rem;
      padding-left: 0.1rem;
    }
    .feas-btn-approve {
      float: none;
      margin-right: 0.5rem;
      margin-left: 0;
    }
    .feas-btn-primary {
      background: #1f6feb;
      color: #fff;
      border: none;
    }
    .feas-btn-primary:hover, .feas-btn-primary:focus {
      background: #155ab6;
      color: #fff;
    }
    .feas-btn-outline {
      background: #f8fafc;
      color: #1f6feb;
      border: 1.5px solid #1f6feb;
    }
    .feas-btn-outline:hover, .feas-btn-outline:focus {
      background: #1f6feb;
      color: #fff;
    }
    .feas-btn-approve {
      background: #eaf1fb;
      color: #1f2937;
      border: none;
      border-radius: 24px;
      font-size: 1.04rem;
      letter-spacing: 0.01em;
      box-shadow: 0 2px 8px 8px rgba(31,111,235,0.10);
      margin-right: 0.5rem;
      padding-top: 0.45rem;
      padding-bottom: 0.45rem;
      margin-top: 1.1rem;
      float: right;
    }
    .feas-btn-approve:active, .feas-btn-approve:focus {
      outline: none;
      box-shadow: 0 0 0 2px #b6d4fe;
    }
    .feas-tl-review-no-data {
      color: #6b7280;
      font-size: 1.08rem;
      padding: 1.2rem 0;
      text-align: center;
    }
    @media (max-width: 991px) {
      .feas-tl-review-container {
        padding: 0 4px;
      }
      .feas-tl-review-card {
        padding: 1.1rem 0.7rem 1rem 0.7rem;
      }
      .feas-tl-review-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.1rem;
      }
      .feas-tl-review-header h2 {
        font-size: 1.4rem;
      }
      .feas-tl-review-table th, .feas-tl-review-table td {
        font-size: 0.85rem;
        padding: 0.4rem 0.2rem;
      }
    }
    .action-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
    .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #fff !important;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        }
     .filter-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
            .btn-add-allocation {
            background: #ed8936;
            color: white;
            box-shadow: 0 2px 8px rgba(237, 137, 54, 0.3);
        }

        .btn-add-allocation:hover {
            background: #dd6b20;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.5);
        }
    /* === MODAL OVERLAY === */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.65);
        z-index: 9999;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-dialog {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px 30px;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        color: white;
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }

    .form-section {
        margin-bottom: 25px;
    }

    .form-section-title {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        color: #4a5568;
        margin-bottom: 8px;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group select:disabled {
        background-color: #f7fafc;
        color: #a0aec0;
        cursor: not-allowed;
    }

    .modal-footer {
        padding: 1rem 2rem;
        border-top: 1px solid #eee;
        background: #fff;
    }
    .gap-2 > * { margin-left: 0.5rem; }

    /* --- Day-wise Effort Table Styling --- */
    .week-allocation-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
        margin-top: 10px;
        margin-bottom: 20px;
    }

    .week-allocation-table th, .week-allocation-table td {
        text-align: center;
        font-size: 1rem;
        padding: 8px 0;
        border: none;
        background: transparent;
    }

    .week-allocation-table th {
        color: #4a5568;
        font-weight: 700;
        background: #f7f9fc;
        border-bottom: 2px solid #e2e8f0;
    }

    .week-allocation-table td {
        color: #232a36;
        font-weight: 500;
    }

    .modal-day-effort {
        width: 90px;
        padding: 8px 10px;
        border: 2px solid #e2e8f0;
        border-radius: 7px;
        font-size: 1rem;
        background: #f8fafc;
        text-align: right;
        transition: border 0.2s, box-shadow 0.2s;
    }

    .modal-day-effort:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px #c3dafe;
        outline: none;
        background: #eaf1fb;
    }

    /* --- Modal Footer Buttons --- */
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1.2rem;
        padding: 1.2rem 2rem 1.2rem 2rem;
        background: #f7f9fc;
        border-top: 1px solid #e2e8f0;
    }

    .modal-footer .btn {
        min-width: 120px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        padding: 0.6rem 1.5rem;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }

    .modal-footer .btn-primary {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        border: none;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }

    .modal-footer .btn-primary:hover, .modal-footer .btn-primary:focus {
        background: linear-gradient(90deg, #5a67d8 0%, #6b46c1 100%);
        color: #fff;
    }

    .modal-footer .btn-secondary {
        background: #fff;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .modal-footer .btn-secondary:hover, .modal-footer .btn-secondary:focus {
        background: #f0f4ff;
        color: #4c51bf;
        border-color: #4c51bf;
        text-decoration: underline;
    }
    /* Add to your static/projects/main.css or in a <style> block */
    .button-row {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 16px; /* Adjust gap as needed */
        margin-bottom: 0.5rem;
    }

   /* Place in static/projects/style.css or similar */
    .feas-btn1 {
      display: inline-flex;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      padding: 0.5em 1.2em;
      margin-left: 10px;
      cursor: pointer;
      transition: box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      color: #fff;
    }
    .feas-btn1 i {
      margin-right: 8px;
      font-size: 1.1em;
    }
    .feas-btn1-blue {
      background: #2563eb;
    }
    .feas-btn1-orange {
      background: linear-gradient(90deg, #ffb300 0%, #ff9100 100%);
    }
    .feas-btn1:active {
      box-shadow: 0 1px 4px rgba(0,0,0,0.10);
    }

</style>
{% endblock %}