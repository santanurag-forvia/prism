{% extends "base.html" %}
             {% load dict_extras %}
             {% block content %}
             <div class="container-fluid mt-4">
              <div class="row justify-content-center">
                  <div class="col-lg-10 col-xl-9">
                      <div class="card shadow-sm">
                          <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                  <h2 class="mb-0 font-weight-bold">Team Lead Punch Review
                                 <button id="global-expand-btn" class="btn btn-outline-primary btn-sm d-flex align-items-center" type="button" aria-label="Expand or collapse all reportees" style="background: #0b5cff;color: #fff; box-shadow: 0 6px 18px rgba(11, 92, 255, 0.12);width:150px">
    <span class="fa fa-plus expand-icon" aria-hidden="true"></span> Show/Hide All
                                 </button></h2>
                              </div>
                              <form method="get" class="form-inline mb-4" autocomplete="off">
                                  <label for="month" class="mr-2 font-weight-medium">Month:</label>
                                  <input type="month" id="month" name="month" value="{{ month_str }}" class="form-control mr-2" onchange="this.form.submit()" style="max-width: 200px;" aria-label="Select month">
                              </form>
                              <div class="accordion" id="reporteeAccordion">

                                  {% for rep in reportees %}
                                  <div class="card mb-2 border-0 shadow-xs">
                                      <div class="card-header bg-light d-flex justify-content-between align-items-center" id="heading-{{ rep.ldap }}">
                                          <span>
                                              <strong class="text-dark">{{ rep.cn }}</strong>
                                              <small class="text-muted">&lt;{{ rep.mail }}&gt;</small>
                                              <span class="badge badge-info ml-2">FTE: {{ fte_totals|get_item:rep.ldap|floatformat:2 }}</span>
                                          </span>
                                          <button class="btn btn-sm btn-outline-primary expand-btn" type="button"
                                              data-target="#collapse-{{ rep.ldap }}"
                                              aria-expanded="false"
                                              aria-controls="collapse-{{ rep.ldap }}"
                                              aria-label="Expand or collapse reportee section"
                                          >
                                              <span class="fa fa-plus expand-icon" aria-hidden="true"></span>
                                          </button>
                                      </div>
                                      <div id="collapse-{{ rep.ldap }}" class="collapse" data-parent="#reporteeAccordion">
                                          <div class="card-body bg-white">
                                              {% with rep_grouped=grouped|get_item:rep.ldap %}
                                              {% if rep_grouped %}
                                              <div class="table-responsive">
                                                  <table class="table table-bordered table-sm punch-table-modern mb-0">
                                                      <!-- Inside your table -->
                                                      <thead class="thead-light">
                                                          <tr>
                                                              <th>
                                                                  <input type="checkbox" class="select-all" data-rep="{{ rep.ldap }}" aria-label="Select all rows for {{ rep.cn }}">
                                                              </th>
                                                              <th>Week #</th>
                                                              <th>Project</th>
                                                              <th>Subproject</th>
                                                              <th>TL Allocation</th>
                                                              <th>Act. Effort</th>
                                                              <th>Sat</th>
                                                              <th>Sun</th>
                                                              <th>Mon</th>
                                                              <th>Tue</th>
                                                              <th>Wed</th>
                                                              <th>Thu</th>
                                                              <th>Fri</th>

                                                          </tr>
                                                      </thead>
                                                      <tbody>
                                                      {% for week_number, week_data in rep_grouped.items %}
                                                          {% for project, project_data in week_data.items %}
                                                              {% for subproject, punch_row in project_data.items %}
                                                                  {% with statuses=punch_row.punch_list|map_filter:"status" %}
                                                                      <tr class="week-row">
                                                                          <td>
                                                                              <input type="checkbox" class="row-select"
                                                                                  data-rep="{{ rep.ldap }}"
                                                                                  data-punch-id="{{ punch_row.punch_list.0.punch_id }}"
                                                                                  aria-label="Select row for punch {{ punch_row.punch_list.0.punch_id }}">
                                                                          </td>
                                                                          <td>W{{ week_number }}</td>
                                                                          <td>{{ project }}</td>
                                                                          <td>{{ subproject }}</td>
                                                                          <td>{{ punch_row.punch_list.0.tl_allocation|default:"0" }}</td>
                                                                          <td>{{ punch_row.punch_list.0.act_effort|default:"0" }}</td>
                                                                          {% for day in day_names %}
                                                                              <td>
                                                                                  {% with punch=punch_row.punches_by_day|get_item:day %}
                                                                                      {% if punch %}
                                                                                          <input type="number" step="0.01" min="0" class="form-control form-control-sm punch-input"
                                                                                              value="{{ punch.punched_hours|default_if_none:'' }}"
                                                                                              data-punch-id="{{ punch.punch_id }}"
                                                                                              data-week="{{ week_number }}"
                                                                                              style="width:80px;"
                                                                                              {% if punch.status == "APPROVED" %}readonly{% endif %}
                                                                                              aria-label="Punched hours for {{ punch.date|date:'Y-m-d' }}"
                                                                                          >
                                                                                          <div>
                                                                                              <span>{{ punch.status|default:"" }}</span>
                                                                                          </div>
                                                                                      {% endif %}
                                                                                  {% endwith %}
                                                                              </td>
                                                                          {% endfor %}

                                                                      </tr>
                                                                  {% endwith %}
                                                              {% endfor %}
                                                          {% endfor %}
                                                          <tr class="week-separator" style="border-bottom: 3px solid #1F6FEB;">
                                                              <td colspan="14"></td>
                                                          </tr>
                                                      {% endfor %}
                                                      </tbody>
                                                  </table>
                                                  <button class="btn bulk-approve mt-4 mb-2 px-4 fw-semibold float-end d-flex align-items-center gap-2 shadow-sm"
                                                          data-rep="{{ rep.ldap }}" type="button">
                                                      <span class="fa fa-check-circle text-primary" style="font-size:1.2em;" aria-hidden="true"></span>
                                                      <span class="text-dark">Approve Selected</span>
                                                  </button>
                                              </div>
                                              {% else %}
                                              <div class="text-muted py-3">No punch data for this reportee.</div>
                                              {% endif %}
                                              {% endwith %}
                                          </div>
                                      </div>
                                  </div>
                                  {% endfor %}
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
             </div>
             {% endblock %}


             {% block extra_js %}
             <script>
             document.addEventListener("DOMContentLoaded", function() {
                 // Collapse all on load
                 document.querySelectorAll(".collapse").forEach(function(el) {
                     el.classList.remove("show");
                 });

                document.querySelectorAll(".expand-btn").forEach(function (btn) {
                    btn.addEventListener("click", function () {
                        var targetId = btn.getAttribute("data-target").replace(/^#/, "");
                        var target = document.getElementById(targetId);
                        if (!target) return;
                        var icon = btn.querySelector(".expand-icon");
                        var expanded = target.classList.contains("show");
                        // Collapse all others
                        document.querySelectorAll(".collapse.show").forEach(function (open) {
                            if (open !== target) open.classList.remove("show");
                        });
                        // Reset all expand icons
                        document.querySelectorAll(".expand-btn .expand-icon").forEach(function (ic) {
                            ic.classList.remove("fa-minus");
                            ic.classList.add("fa-plus");
                        });
                        // Toggle current
                        if (expanded) {
                            target.classList.remove("show");
                            btn.setAttribute("aria-expanded", "false");
                            if (icon) {
                                icon.classList.remove("fa-minus");
                                icon.classList.add("fa-plus");
                            }
                        } else {
                            target.classList.add("show");
                            btn.setAttribute("aria-expanded", "true");
                            if (icon) {
                                icon.classList.remove("fa-plus");
                                icon.classList.add("fa-minus");
                            }
                        }
                    });
                });
                             // Global expand/collapse button
                 var globalBtn = document.getElementById("global-expand-btn");
                 var globalState = false; // false = collapsed, true = expanded
                 globalBtn.addEventListener("click", function() {
                     var allCollapses = document.querySelectorAll(".collapse");
                     var allIcons = document.querySelectorAll(".expand-btn .expand-icon");
                     globalState = !globalState;
                     if (globalState) {
                         allCollapses.forEach(function(el) { el.classList.add("show"); });
                         allIcons.forEach(function(ic) {
                             ic.classList.remove("fa-plus");
                             ic.classList.add("fa-minus");
                         });
                         globalBtn.querySelector(".expand-icon").classList.remove("fa-plus");
                         globalBtn.querySelector(".expand-icon").classList.add("fa-minus");
                     } else {
                         allCollapses.forEach(function(el) { el.classList.remove("show"); });
                         allIcons.forEach(function(ic) {
                             ic.classList.remove("fa-minus");
                             ic.classList.add("fa-plus");
                         });
                         globalBtn.querySelector(".expand-icon").classList.remove("fa-minus");
                         globalBtn.querySelector(".expand-icon").classList.add("fa-plus");
                     }
                 });

              // Approve button handler
              document.querySelectorAll(".approve-btn").forEach(function(btn) {
                  btn.addEventListener("click", function(e) {
                      if (btn.hasAttribute("disabled")) return;
                      var punchId = btn.getAttribute("data-punch-id");
                      var input = document.querySelector('.punch-input[data-punch-id="' + punchId + '"]');
                      var punchedHours = input.value;
                      if (punchedHours === "" || isNaN(punchedHours) || Number(punchedHours) < 0) {
                          alert("Please enter a valid punched hours value.");
                          return;
                      }
                      var comments = prompt("Optional: Add comments for approval", "");
                      btn.disabled = true;
                      fetch("{% url 'projects:tl_punch_approve' %}", {
                          method: "POST",
                          headers: {
                              "X-CSRFToken": "{{ csrf_token }}",
                              "Content-Type": "application/json"
                          },
                          body: JSON.stringify({
                              punch_id: punchId,
                              punched_hours: punchedHours,
                              comments: comments
                          })
                      }).then(resp => resp.json()).then(data => {
                          if (data.ok) {
                              input.setAttribute("readonly", "readonly");
                              var statusCell = btn.closest("td").previousElementSibling;
                              if (statusCell) {
                                  statusCell.textContent = "APPROVED";
                              }
                              btn.remove();
                          } else {
                              alert("Error: " + (data.error || "Approval failed."));
                              btn.disabled = false;
                          }
                      }).catch(function() {
                          alert("Network error. Please try again.");
                          btn.disabled = false;
                      });
                  });
              });

              // Select all checkboxes
              document.querySelectorAll(".select-all").forEach(function(selectAll) {
                  selectAll.addEventListener("change", function() {
                      var rep = selectAll.getAttribute("data-rep");
                      document.querySelectorAll('.row-select[data-rep="' + rep + '"]').forEach(function(cb) {
                          cb.checked = selectAll.checked;
                      });
                  });
              });

              // Bulk approve
              document.querySelectorAll(".bulk-approve").forEach(function(btn) {
                  btn.addEventListener("click", function() {
                      var rep = btn.getAttribute("data-rep");
                      var punchIds = Array.from(document.querySelectorAll('.row-select[data-rep="' + rep + '"]:checked'))
                          .map(cb => cb.getAttribute("data-punch-id"));
                      if (punchIds.length === 0) {
                          alert("Select at least one row to approve.");
                          return;
                      }
                      btn.disabled = true;
                      fetch("{% url 'projects:tl_punch_bulk_approve' %}", {
                          method: "POST",
                          headers: {
                              "X-CSRFToken": "{{ csrf_token }}",
                              "Content-Type": "application/json"
                          },
                          body: JSON.stringify({ punch_ids: punchIds })
                      }).then(resp => resp.json()).then(data => {
                          if (data.ok) {
                              punchIds.forEach(function(id) {
                                  var row = document.querySelector('.row-select[data-punch-id="' + id + '"]').closest("tr");
                                  var approveBtn = row.querySelector(".approve-btn");
                                  if (approveBtn) approveBtn.remove();
                                  row.querySelector("td:nth-last-child(2)").textContent = "APPROVED";
                                  var input = row.querySelector(".punch-input");
                                  if (input) input.setAttribute("readonly", "readonly");
                              });
                          } else {
                              alert("Error in bulk approval: " + (data.error || ""));
                          }
                          btn.disabled = false;
                      }).catch(function() {
                          alert("Network error. Please try again.");
                          btn.disabled = false;
                      });
                  });
              });

              // Keyboard accessibility for checkboxes and buttons
              document.querySelectorAll("input[type=checkbox], button").forEach(function(el) {
                  el.addEventListener("keyup", function(e) {
                      if (e.key === "Enter" || e.key === " ") {
                          el.click();
                      }
                  });
              });
             });
             </script>
             <script>
             document.addEventListener('DOMContentLoaded', function() {
               document.querySelectorAll('.toggle-punch-table').forEach(function(btn) {
                 btn.addEventListener('click', function() {
                   var target = document.querySelector(btn.getAttribute('data-target'));
                   var icon = btn.querySelector('.toggle-icon');
                   if (target.style.display === 'none') {
                     target.style.display = '';
                     icon.textContent = '-';
                   } else {
                     target.style.display = 'none';
                     icon.textContent = '+';
                   }
                 });
               });
             });
             </script>
             {% endblock %}

             {% block extra_css %}
             <style>
             body {
              background: #f5f7fa;
              font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
              color: #222;
             }
             .container-fluid {
              margin-top: 2.5rem;
             }
             .card {
              border-radius: 16px;
              box-shadow: 0 2px 12px rgba(31, 111, 235, 0.07), 0 1.5px 4px rgba(0,0,0,0.04);
              border: none;
              background: #fff;
             }
             .card-header {
              background: #f3f6fa;
              border-radius: 16px 16px 0 0;
              padding: 1.1rem 1.5rem;
              font-size: 1.08rem;
              font-weight: 600;
              border-bottom: 1px solid #e3e8ee;
             }
             .card-body {
              border-radius: 0 0 16px 16px;
              padding: 2rem 1.5rem 1.5rem 1.5rem;
             }
             h2 {
              font-size: 2rem;
              font-weight: 700;
              color: #1f6feb;
              margin-bottom: 1.5rem;
             }
             .form-inline label {
              font-size: 1.08rem;
              font-weight: 500;
              margin-right: 0.5rem;
             }
             input[type="month"] {
              border: 1px solid #d1d9e6;
              border-radius: 6px;
              padding: 0.35rem 0.7rem;
              font-size: 1.05rem;
              background: #f8fafc;
              transition: border 0.2s;
              margin-right: 0.5rem;
             }
             input[type="month"]:focus {
              border-color: #1f6feb;
              outline: none;
             }
             .accordion .card {
              margin-bottom: 0.7rem;
              border-radius: 14px;
             }
             .accordion .card-header {
              background: #f8fafd;
              border-radius: 14px 14px 0 0;
              font-size: 1.08rem;
              font-weight: 600;
              color: #1f2937;
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 1rem 1.3rem;
             }
             .accordion .card-header strong {
              font-weight: 700;
              color: #1f6feb;
              font-size: 1.08rem;
              letter-spacing: 0.01em;
             }
             .accordion .card-header small {
              color: #6b7280;
              font-size: 0.98rem;
              margin-left: 0.5rem;
             }
             .accordion .btn-outline-primary {
              border: 1.5px solid #1f6feb;
              color: #1f6feb;
              background: #f8fafc;
              border-radius: 6px;
              padding: 0.25rem 0.9rem;
              font-weight: 500;
              transition: background 0.2s, color 0.2s;
             }
             .accordion .btn-outline-primary:hover, .accordion .btn-outline-primary:focus {
              background: #1f6feb;
              color: #fff;
              outline: none;
             }
             .collapse .card-body {
              background: #fff;
              border-radius: 0 0 14px 14px;
              padding: 1.2rem 1.3rem 1.1rem 1.3rem;
             }
             .table-responsive {
              margin-top: 0.7rem;
             }
             .punch-table-modern {
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 2px 16px rgba(31,111,235,0.08), 0 1.5px 4px rgba(0,0,0,0.04);
              overflow: hidden;
              margin-bottom: 1rem;
              font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
             }
             .punch-table-modern th, .punch-table-modern td {

              text-align: center;
              vertical-align: middle;
             }
             .punch-table-modern th {
               background: linear-gradient(90deg, #6a8dff 0%, #4f6bed 100%);
               color: #fff;
               font-weight: 600;
               font-size: 0.78rem;
               border: none;
               padding: 0.35rem 0.4rem; /* Compact: less vertical and horizontal space */
               letter-spacing: 0.01em;
               line-height: 1.1;
               vertical-align: middle;
             }
             .punch-table-modern td {
              background: #fff;
              color: #222;
              font-size: 0.8rem;
              border-top: 1px solid #f0f3fa;
              padding: 0.75rem 0.7rem;
              vertical-align: middle;
              transition: background 0.2s;
             }
             .punch-table-modern tr:hover td {
              background: #f5f8ff;
             }
             .punch-input {
              width: 80px;
              border: 1px solid #d1d9e6;
              border-radius: 5px;
              padding: 0.25rem 0.5rem;
              font-size: 0.8rem;
              background: #f8fafc;
              transition: border 0.2s;
             }
             .punch-input:focus {
              border-color: #1f6feb;
              background: #eaf1fb;
              outline: none;
             }
             .punch-input[readonly] {
              background: #e9ecef;
              color: #6b7280;
              border-color: #d1d9e6;
             }
             .bulk-approve {
              background: #eaf1fb;
              color: #1f2937;
              border: none;
              border-radius: 24px;
              font-size: 1.04rem;
              letter-spacing: 0.01em;
              box-shadow: 0 2px 8px 8px rgba(31,111,235,0.10);
              transition: background 0.2s, box-shadow 0.2s;
              margin-right: 0.5rem;
              padding-top: 0.45rem;
              padding-bottom: 0.45rem;
             }
             .bulk-approve:active, .bulk-approve:focus {
              outline: none;
              box-shadow: 0 0 0 2px #b6d4fe;
             }
             .approved-inactive {
              background: #e6f4ea !important;
              color: #198754 !important;
              border: 1.5px solid #b6e2c6 !important;
              font-weight: 500;
                 font-size: 0.8rem;
              opacity: 1 !important;
              cursor: not-allowed;
             }
             .btn-primary.btn-sm.approve-btn {
              background: #1f6feb;
              border: none;
              color: #fff;
              font-weight: 500;
              border-radius: 5px;
              padding: 0.25rem 1.1rem;
              font-size: 0.8rem;
              box-shadow: 0 1px 4px rgba(31,111,235,0.08);
              transition: background 0.2s;
             }
             .btn-primary.btn-sm.approve-btn:hover, .btn-primary.btn-sm.approve-btn:focus {
              background: #155ab6;
              outline: none;
             }
             .text-muted {
              color: #6b7280 !important;
              font-size: 1.01rem;
             }
             .shadow-xs {
              box-shadow: 0 1.5px 6px rgba(31, 111, 235, 0.08);
             }
             @media (max-width: 991px) {
              .container-fluid {
                  margin-top: 1.2rem;
              }
              .card-body, .collapse .card-body {
                  padding: 1.1rem 0.7rem 1rem 0.7rem;
              }
              .card-header {
                  padding: 0.8rem 0.7rem;
              }
              h2 {
                  font-size: 1.4rem;
              }
             }
             .week-separator td {
                 border-bottom: 3px solid #1f6feb !important;
                 background: #f3f6fa;
                 height: 8px;
                 padding: 0;
             }
             .expand-btn .fa-plus, .expand-btn .fa-minus {
                 font-size: 1.2em;
             }

             #global-expand-btn {
    margin-left: 850px;
    min-width: 36px;
    min-height: 36px;
    /*display: flex;*/
    align-items: center;
    justify-content: center;
}
             .collapse {
                display: none;
            }
            .collapse.show {
                display: block;
            }
            .approve-btn[disabled] {
              background: #ccc !important;
              border-color: #ccc !important;
              color: #888 !important;
              cursor: not-allowed;
            }
            .week-separator {
                border-bottom: 3px solid #1F6FEB !important;
            }
             </style>
             {% endblock %}